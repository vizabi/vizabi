function dialogDrag(a,b,c){var d,e,f,g,h,i,j,k,l,m;return{move:function(b,c){a.style("left",b+"px"),a.style("top",c+"px")},dragStart:function(n){d=n.sourceEvent.clientX,e=n.sourceEvent.clientY,f=parseInt(a.style("top"))||0,g=parseInt(a.style("left"))||0,h=parseInt(a.style("width")),i=parseInt(a.style("height")),j=parseInt(b.style("width"))+c,k=parseInt(b.style("height")),l=d-g,m=e-f},drag:function(a){var b=a.sourceEvent.clientX,d=a.sourceEvent.clientY,e=b-l,f=d-m;e>-c&&(e=-c),0>f&&(f=0),-e+h>j&&(e=-j+h),i+f>k&&(f=k-i),this.move(e,f)}}}(function(){"use strict";function a(a,b,d){var e=c.Tool.get(a);if(e){var f=new e(b,d);return c._instances[f._id]=f,f}c.utils.error('Tool "'+a+'" was not found.')}var b=this,c=(b.Vizabi,function(b,c,d){return a(b,c,d)});c._instances={},c._globals={},c.clearInstances=function(a){if(a)c._instances[a]=void 0;else{for(var b in c._instances)c._instances[b].clear();c._instances={}}},c._require=function(a){return"undefined"==typeof b[a]?(c.utils.warn(a+" is required and could not be found."),!1):!0},"function"==typeof define&&define.amd?define(function(){return c}):"object"==typeof module&&module.exports&&(module.exports=c),b.Vizabi=c}).call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils={uniqueId:function(){var a=0;return function(b){return b?b+(a+=1):a+=1}}(),isElement:function(a){return!(!a||1!==a.nodeType)},isArray:Array.isArray||function(a){return"[object Array]"===toString.call(a)},isObject:function(a){var b=typeof a;return"object"===b&&!!a},isDate:function(a){return a instanceof Date},isString:function(a){return"string"==typeof a},isNaN:function(a){return this.isNumber(a)&&a!==+a},isNumber:function(a){return"number"==typeof a||!!a&&"object"==typeof a&&"[object Number]"===Object.prototype.toString.call(a)},isPlainObject:function(a){return null!==a&&"[object Object]"===Object.prototype.toString.call(a)},getViewportPosition:function(a){for(var b=0,c=0;a;)b+=a.offsetLeft-a.scrollLeft+a.clientLeft,c+=a.offsetTop-a.scrollTop+a.clientTop,a=a.offsetParent;return{x:b,y:c}},findScrollableAncestor:function(a){for(var b=d3.select(a).node(),c=["scroll","auto"];b&&"HTML"!==b.tagName&&-1==c.indexOf(d3.select(b).style("overflow"));)b=b.parentNode;return b},roundStep:function(a,b){return Math.round(a/b)*b},strToFloat:function(a){return+a.replace(/[^\d.-]/g,"")},forEach:function(a,b,c){if(a){var d;if(this.isArray(a))for(d=0;d<a.length&&b.apply(c,[a[d],d])!==!1;d+=1);else{var e=Object.keys(a),f=e.length;for(d=0;f>d&&b.apply(c,[a[e[d]],e[d]])!==!1;d+=1);}}},extend:function(a){var b=Array.prototype.slice.call(arguments,1),c=this;return this.forEach(b,function(b,d){c.forEach(b,function(c,d){b.hasOwnProperty(d)&&(a[d]=c)})}),a},merge:function(a){var b=Array.prototype.slice.call(arguments,1),c=this;return this.forEach(b,function(b,d){c.forEach(b,function(d,e){b.hasOwnProperty(e)&&(a.hasOwnProperty(e)?(c.isArray(a[e])||(a[e]=[a[e]]),a[e].push(d)):a[e]=d)})}),a},clone:function(a,b,c){if(this.isArray(a))return a.slice(0);var d={};return this.forEach(a,function(e,f){b&&-1===b.indexOf(f)||c&&-1!==c.indexOf(f)||a.hasOwnProperty(f)&&(d[f]=e)}),d},deepClone:function(a){var b={},c=this;return this.forEach(a,function(d,e){a.hasOwnProperty(e)&&(c.isObject(d)||c.isArray(d)?b[e]=c.deepClone(d):b[e]=d)}),b},without:function(a,b){var c=a.indexOf(b);return-1!==c&&a.splice(c,1),a},unique:function(a,b){var c={},d=[];b||(b=function(a){return a});for(var e=0,f=a.length;f>e;e+=1){var g=b(a[e]);c.hasOwnProperty(g)||(d.push(a[e]),c[g]=1)}return d},uniqueLast:function(a,b){var c={},d=[];b||(b=function(a){return a});for(var e=0,f=a.length;f>e;e+=1){var g=b(a[e]);c.hasOwnProperty(g)&&d.splice(c[g],1),d.push(a[e]),c[g]=d.length-1}return d},find:function(a,b){var c;return this.forEach(a,function(a){return b(a)?(c=a,!1):void 0}),c},filter:function(a,b){for(var c,d,e=-1,f=a.length,g=-1,h=[],i=Object.keys(b),j=i.length;(e+=1)<f;){var k=a[e],l=!0;for(c=0;j>c;c+=1)if(d=i[c],!k.hasOwnProperty(d)||k[d]!==b[d]){l=!1;break}l&&(h[g+=1]=k)}return h},filterAny:function(a,b,c){for(var d,e,f=-1,g=a.length,h=-1,i=[],j=Object.keys(b),k=j.length;(f+=1)<g;){var l=a[f],m=!0;for(d=0;k>d;d+=1)if(e=j[d],!l.hasOwnProperty(e)||!this.matchAny(l[e],b[e],c)){m=!1;break}m&&(i[h+=1]=l)}return i},matchAny:function(a,b,c){this.isArray(a)||(a=[a]),c||(c="*");for(var d=!1,e=0;e<a.length;e++){var f=a[e];if(!this.isArray(b)&&f==b){d=!0;break}if(this.isArray(b)){for(var g=-1,h=0;h<b.length;h++){var i=b[h];if(!(this.isArray(i)||i!=f&&i!==c)){g=h;break}if(this.isArray(i)){var j=i[0],k=i[1]||j;if(f>=j&&k>=f){g=h;break}}}if(-1!==g){d=!0;break}}}return d},mapRows:function(a,b){function c(a,b){if(d.isArray(a)){for(var e=[],f=0;f<a.length;f++)e[f]=c(a[f],b);return e}return b(a)}var d=this,e=Object.keys(b),f=e.length;return a=a.map(function(a){for(var d=0;f>d;d++){var g,h=e[d];try{g=c(a[h],b[h])}catch(i){g=a[h]}a[h]=g}return a})},radiusToArea:function(a){return a*a*Math.PI},areaToRadius:function(a){return Math.sqrt(a/Math.PI)},timeStamp:function(b){a.console&&"function"==typeof a.console.timeStamp&&a.console.timeStamp(b)},warn:function(b){a.console&&"function"==typeof a.console.warn&&a.console.warn(b)},groupCollapsed:function(b){a.console&&"function"==typeof a.console.groupCollapsed&&a.console.groupCollapsed(b)},groupEnd:function(){a.console&&"function"==typeof a.console.groupEnd&&a.console.groupEnd()},error:function(b,c){a.console&&"function"==typeof a.console.error&&a.console.error(b,c)},countDecimals:function(a){return Math.floor(a.valueOf())===a.valueOf()?0:a.toString().split(".")[1].length||0},addClass:function(a,b){a.classList?a.classList.add(b):a.className+=" "+b},removeClass:function(a,b){a.classList?a.classList.remove(b):a.className=a.className.replace(new RegExp("(^|\\b)"+b.split(" ").join("|")+"(\\b|$)","gi")," ")},classed:function(a,b,c){if(c===!0)this.addClass(a,b);else{if(c!==!1)return this.hasClass(a,b);this.removeClass(a,b)}},hasClass:function(a,b){return a.classList?a.classList.contains(b):new RegExp("(^| )"+b+"( |$)","gi").test(a.className)},throttle:function(a,b){function c(){return f?(d=arguments,void(e=this)):(a.apply(this,arguments),f=!0,void setTimeout(function(){f=!1,d&&(c.apply(e,d),d=e=null)},b))}var d,e,f=!1;return c},keys:function(a){return Object.keys(a)},values:function(a){for(var b,c=Object.keys(a),d=c.length,e=0;d>e;e+=1)(b=b||[]).push(a[c[e]]);return b},arrayMin:function(a){return a.reduce(function(a,b){return b>a?a:b})},arrayMax:function(a){return a.reduce(function(a,b){return a>b?a:b})},arrayMean:function(a){return this.arraySum(a)/a.length},arraySum:function(a){return a.reduce(function(a,b){return a+b})},arrayMedian:function(a){a=a.sort(function(a,b){return a-b});var b=Math.floor((a.length-1)/2);return a.length%2?a[b]:(a[b]+a[b+1])/2},arrayLast:function(a){return a.length?a[a.length-1]:null},defer:function(a){setTimeout(a,1)},delay:function(a,b){setTimeout(a,b)},hashCode:function(a){this.isString(a)||(a=JSON.stringify(a));var b,c=0,d=a.length;if(0===d)return c;for(var e=0;d>e;e+=1)b=a.charCodeAt(e),c=(c<<5)-c+b,c&=c;return c.toString()},ajax:function(a){var b=new XMLHttpRequest;b.open(a.method,a.url,!0),"POST"!==a.method||a.json?"POST"===a.method&&a.json&&b.setRequestHeader("Content-Type","application/json; charset=UTF-8"):b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),b.onload=function(){if(b.status>=200&&b.status<400){var c=a.json?JSON.parse(b.responseText):b.responseText;a.success&&a.success(c)}else a.error&&a.error()},b.onerror=function(){a.error&&a.error()},b.send(a.data)},get:function(a,b,c,d,e){b=b||[],this.forEach(b,function(a,c){b.push(c+"="+a)}),a=b.length?a+"?"+b.join("&"):a,this.ajax({method:"GET",url:a,success:c,error:d,json:e})},post:function(a,b,c,d,e){this.ajax({method:"POST",url:a,success:c,error:d,json:e,data:b})},memoize:function(a){return function(){for(var b=Array.prototype.slice.call(arguments),c="",d=b.length,e=null;d--;)e=b[d],c+=e===Object(e)?JSON.stringify(e):e,a.memoize||(a.memoize={});return c in a.memoize?a.memoize[c]:a.memoize[c]=a.apply(this,b)}},debounce:function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}},isTouchDevice:function(){return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)}}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Promise=b.call(a)}(b,function(){function a(b){return this instanceof a?(this.status="pending",this.value,this.reason,this._resolves=[],this._rejects=[],g(b)&&b(this.resolve.bind(this),this.reject.bind(this)),this):new a(b)}function b(b,c){return c===b&&b.reject(new Error("TypeError")),c instanceof a?d(b,c):i(c)?e(b,c):b.resolve(c)}function d(a,b){var c=b.status;return"pending"===c&&b.then(a.resolve.bind(a),a.reject.bind(a)),"resolved"===c&&a.resolve(b.value),"rejected"===c&&a.reject(b.reason),promise}function e(a,c){var d,e=j(function(c){d||(b(a,c),d=!0)}),f=j(function(b){d||(a.reject(b),d=!0)});try{c.then.call(c,e,f)}catch(g){if(!d)throw g;a.reject(g)}return a}function f(a){for(var c,d,e=a.status,f=a["resolved"===e?"_resolves":"_rejects"],g=a["resolved"===e?"value":"reason"];c=f.shift();)d=c.call(a,g),d&&b(a._next,d);return a}function g(a){return"function"===h(a)}function h(a){var b={};return b.toString.call(a).replace(/\[object (\w+)\]/,"$1").toLowerCase()}function i(a){return a&&a.then&&g(a.then)}function j(a){var b,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments))}}return a.prototype.then=function(c,d){var e,f=this._next||(this._next=a()),h=this.status;if("pending"===h)return g(c)&&this._resolves.push(c),g(d)&&this._rejects.push(d),f;if("resolved"===h){if(g(c))try{e=c(this.value),b(f,e)}catch(i){this.reject(i)}else f.resolve(c);return f}if("rejected"===h){if(g(d))try{e=d(this.reason),b(f,e)}catch(i){this.reject(i)}else f.reject(d);return f}},a.prototype.resolve=function(a){if("rejected"===this.status)throw Error("Illegal call.");return this.status="resolved",this.value=a,this._resolves.length&&f(this),this},a.prototype.reject=function(a){if("resolved"===this.status)throw Error("Illegal call. "+a);return this.status="rejected",this.reason=a,this._rejects.length&&f(this),this},a.prototype["catch"]=function(a){return this.then(void 0,a)},a.cast=function(b){var c=a();return b instanceof a?d(c,b):a.resolve(b)},a.resolve=function(b){var c=a();return i(b)?e(c,b):c.resolve(b)},a.all=function(b){var d,e=b.length,f=a(),g=[],h=0;return c.forEach(b,function(a,b){a.then(function(a){g[b]=a,(h+=1)!==e||d||f.resolve(g)},function(a){d=!0,f.reject(a)})}),f},a.any=function(b){var d,e=a();return c.forEach(b,function(a,b){a.then(function(a){d||(e.resolve(a),d=!0)},function(a){d=!0,e.reject(a)})}),e},a.reject=function(b){if(!(b instanceof Error))throw Error("reason must be an instance of Error");var c=a();return c.reject(b),c},a})}.call(this),function(){"use strict";function a(b,f){function g(){!d&&this.init&&this.init.apply(this,arguments)}f=1===arguments.length?b:f;var h=this.prototype;d=!0;var i=new this;return d=!1,c.utils.forEach(f,function(a,b){"function"==typeof f[b]&&"function"==typeof h[b]&&e.test(f[b])?i[b]=function(a,b){return function(){var c=this._super;this._super=h[a];var d=b.apply(this,arguments);return this._super=c,d}}(b,f[b]):i[b]=a}),g.prototype=i,g.prototype.constructor=g,g.extend=a,g._collection={},g.register=function(a,b){"undefined"!=typeof this._collection[a]&&c.utils.warn('"'+a+'" is already registered. Overwriting...'),this._collection[a]=b},g.unregister=function(a){this._collection[a]=void 0},g.getCollection=function(){return this._collection},g.define=function(a,b){this.prototype[a]=b},g.get=function(a,b){return this._collection.hasOwnProperty(a)?this._collection[a]:(b||c.utils.warn('"'+a+'" was not found.'),!1)},arguments.length>1&&this.register&&this.register(b,g),g}var b=this,c=b.Vizabi,d=!1,e=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;c.Class=function(){},c.Class.extend=a,c.Helper=c.Class.extend({})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b.Promise,e=b.Class.extend({init:function(){this._collection={}},load:function(a,b,e,f){var g=this,h=new d,i=(new d).resolve(),j=a===!0?!0:this.isCached(a,b,e),k=!1;return j||(c.timeStamp("Vizabi Data: Loading Data"),f&&"function"==typeof f.load_start&&f.load_start(),i=new d,this.loadFromReader(a,b,e).then(function(a){k=!0,j=a,i.resolve()})),i.then(function(){g._collection[j].data;k&&f&&"function"==typeof f.load_end&&f.load_end(),h.resolve(j)},function(){k&&f&&"function"==typeof f.load_end&&f.load_end(),h.reject("Error loading file...")}),h},loadFromReader:function(a,e,f){var g=this,h=new d,i=f.reader,j=c.hashCode([a,e,f]),k=b.Reader.get(i),l=new k(f);return l.read(a,e).then(function(){var b=l.getData(),c=a;b=b.map(function(a){for(var b=0;b<c.select.length;b+=1){var d=c.select[b];"undefined"==typeof a[d]&&(a[d]=null)}return a}),g._collection[j]={};var d=g._collection[j];d.data=b,d.filtered={},d.nested={},d.unique={},d.limits={},h.resolve(j)},function(a){h.reject(a)}),h},get:function(a,b){return a?(b||(b="data"),this._collection[a][b]):void 0},isCached:function(a,b,d){var e=c.hashCode([a,b,d]);return-1!==Object.keys(this._collection).indexOf(e)?e:!1}}),f=b.Class.extend({init:function(a){this._name=this._name||a.reader,this._data=a.data||[],this._basepath=this._basepath||a.path||null,this._formatters=a.formatters,this._formatters&&(this._data=c.mapRows(this._data,this._formatters))},read:function(a,b){return new d.resolve},getData:function(){return this._data}});b.Reader=f,b.Data=e}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=!1,e=[],f={},g=b.Class.extend({init:function(){this._id=this._id||c.uniqueId("e"),this._events={},this._freeze=!1,this._freezer=[],this._freezeExceptions={}},on:function(a,b){var d;if(c.isArray(b))for(d=0;d<b.length;d+=1)this.on(a,b[d]);else if(c.isArray(a))for(d=0;d<a.length;d+=1)this.on(a[d],b);else if(c.isObject(a))for(d in a)this.on(d,a[d]);else this._events[a]=this._events[a]||[],"function"==typeof b?this._events[a].push(b):c.warn("Can't bind event '"+a+"'. It must be a function.")},unbind:function(a){if(c.isArray(a))for(var b=0;b<a.length;b+=1)this.unbind(a[b]);else this._events.hasOwnProperty(a)&&(this._events[a]=[])},unbindAll:function(){this._events={}},trigger:function(a,b,g){var h,i;if(c.isArray(a))for(h=0,i=a.length;i>h;h+=1)this.trigger(a[h],b);else{if(!this._events.hasOwnProperty(a))return;for(h=0;h<this._events[a].length;h+=1){var j=this._events[a][h],k=this,l=function(){var d="Vizabi Event: "+a+" - "+g;c.timeStamp(d),j.apply(k,[g||a,b])};this._freeze||d?d&&f.hasOwnProperty(a)||!d&&this._freeze&&this._freezeExceptions.hasOwnProperty(a)?l():(this._freezer.push(l),d&&!e[this._id]&&(this.freeze(),e[this._id]=this)):l()}}},triggerAll:function(a,b,d){var e=[];c.isArray(a)||(a=[a]);var f,g,h;for(f=0,g=a.length;g>f;f+=1){h=a[f];for(var d=h,i=h.split(":");i.length;)e.push([h,b,d]),i.pop(),h=i.join(":")}var j=c.unique(e,function(a){return a[0]});for(f=0;f<j.length;f+=1)this.trigger.apply(this,j[f])},freeze:function(a){if(this._freeze=!0,a){c.isArray(a)||(a=[a]);for(var b=0;b<a.length;b+=1)this._freezeExceptions[a[b]]=!0}},unfreeze:function(){for(this._freeze=!1,this._freezeExceptions={};this._freezer.length;){var a=this._freezer.shift();a()}},clearFrozen:function(){this._freeze=!1,this._freezeExceptions={},this._freezer=[]}});g.freezeAll=function(a){d=!0,a&&(c.isArray(a)||(a=[a]),c.forEach(a,function(a){f[a]=!0}))},g.unfreezeAll=function(){d=!1,f={};for(var a=Object.keys(e),b=0;b<a.length;b++){var c=e[a[b]];c&&c.unfreeze()}e={}},b.Events=g}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=(b.utils,b.Class.extend({init:function(){this.intervals={}},setInterval:function(a,b,c){this.clearInterval(a),this.intervals[a]=setInterval(b,c)},clearInterval:function(a){return a?clearInterval(this.intervals[a]):this.clearAllIntervals()},clearAllIntervals:function(){for(var a in this.intervals)this.clearInterval(a)}}));b.Intervals=c}.call(this),function(){"use strict";function a(){this._container&&this.setSize()}var b=this,c=b.Vizabi,d=c.utils,e="vzb-",f="vzb-portrait",g="vzb-landscape",h=c.Events.extend({screen_profiles:{small:{min_width:0,max_width:749},medium:{min_width:750,max_width:969},large:{min_width:970,max_width:1/0}},init:function(){this._container=null,this._curr_profile=null,this._prev_size={};this.resizeHandler=this.resizeHandler||a.bind(this),b.addEventListener("resize",this.resizeHandler),this._super()},setSize:function(){var a=this,b=this._container.clientWidth,c=this._container.clientHeight;this._prev_size&&this._prev_size.width===b&&this._prev_size.height===c||(d.forEach(this.screen_profiles,function(c,f){d.removeClass(a._container,e+f),b>=c.min_width&&b<=c.max_width&&(a._curr_profile=f)}),d.addClass(this._container,e+this._curr_profile),c>b?(d.addClass(this._container,f),d.removeClass(this._container,g)):(d.addClass(this._container,g),d.removeClass(this._container,f)),this._prev_size.width=b,this._prev_size.height=c,this.trigger("resize"))},setContainer:function(a){this._container=a,this.setSize()},currentProfile:function(){return this._curr_profile},clear:function(){b.removeEventListener("resize",this.resizeHandler)}});c.Layout=h}.call(this),function(){"use strict";function a(a){return a.hasOwnProperty("_data")}function b(a){for(var b in a._data)Object.defineProperty(a,b,{configurable:!0,get:function(b){return function(){return a.get(b)}}(b),set:function(b){return function(c){return a.set(b,c)}}(b)})}function c(b,c,d){var e=b.split("_")[0],f={change:function(a,b){d._ready&&(a=a.replace("change","change:"+e),d.triggerAll(a,d.getObject()))},hook_change:function(a,b){d.trigger(a,d.getObject())},load_start:function(a,b){a=a.replace("load_start","load_start:"+e),d.setReady(!1),d.triggerAll(a,d.getObject())},load_error:function(a,b){a=a.replace("load_error","load_error:"+e),d.triggerAll(a,b)},ready:function(a,b){a=a.replace("ready","ready:"+e),d.setReady(!1),n.defer(function(){d.setReady()})}};if(a(c))return c.on(f),c;var g=l.Model.get(e,!0)||r;return new g(c,d,f,!0)}function d(a){return a._intervals?a._intervals:a._parent?d(a._parent):new l.Intervals}function e(a,b){var c=f(a,b);return c?c:a._parent?e(a._parent,b):void 0}function f(b,c){for(var d in b._data)if(d===c&&a(b._data[d]))return b._data[d]}function g(a){return n.isArray(a.space)?a.space:a._parent?g(a._parent):void n.error('ERROR: space not found.\n You must specify the objects this hook will use under the "space" attribute in the state.\n Example:\n space: ["entities", "time"]')}function h(a,b,c,d,e,f,g){if(null===a||0===a.length)return n.warn("interpolatePoint returning NULL: array is empty"),null;if("value"===b)return c;if("property"===b&&0===d)return a[0][c];if("property"===b)return a[d-1][c];if(0===d)return a[0][c];if(d===a.length)return a[a.length-1][c];if(null===a[d][c]||null===a[d-1][c])return null;var h=j()[g](a[d-1][e],a[d][e],a[d-1][c],a[d][c],f);return n.isDate(a[0][c])&&(h=new Date(h)),h}function i(a,b,c,d,e){var f,g,h,i,k,l,m;return f=this._getFirstDimension({type:"time"}),g=new Date(a[f]),h=n.clone(a,null,f),i=this.getFilteredItems(h),null===i||0===i.length?(n.warn("interpolateValue returns "+c+" = NULL because items array is empty in "+JSON.stringify(h)),null):"value"===b?i[0][c]:(k=this._spaceId||(this._spaceId=Object.keys(this._space).join("-")),s[k]=s[k]||{},g in s[k]?l=s[k][g].next:(l=d3.bisectLeft(this.getUnique(f),g),s[k][g]={next:l}),"property"===b&&0===l?i[0][c]:"property"===b?i[l-1][c]:0===l?i[0][c]:l===i.length?i[i.length-1][c]:null===i[l][c]||null===i[l-1][c]?null:(m=j()[e](i[l-1][f],i[l][f],i[l-1][c],i[l][c],g),"[object Date]"===Object.prototype.toString.call(i[0][c])&&(m=new Date(m)),m))}function j(){return{linear:function(a,b,c,d,e){return+c+(d-c)*(e-a)/(b-a)},exp:function(a,b,c,d,e){return Math.exp((Math.log(c)*(b-e)-Math.log(d)*(a-e))/(b-a))}}}var k=this,l=k.Vizabi,m=l.Promise,n=l.utils,o=l._globals,p={year:"%Y",month:"%b",week:"week %U",day:"%d/%m/%Y",hour:"%d/%m/%Y %H",minute:"%d/%m/%Y %H:%M",second:"%d/%m/%Y %H:%M:%S"};l._require("d3");var q=new l.Data,r=l.Events.extend({init:function(a,b,c,e){this._type=this._type||"model",this._id=this._id||n.uniqueId("m"),this._data={},this._parent=b,this._set=!1,this._ready=!1,this._readyOnce=!1,this._loadedOnce=!1,this._loading=[],this._intervals=d(this),this._deps={parent:[],children:[]},this._space={},this._spaceDims={},this._dataId=!1,this._limits={},this._super(),c&&this.on(c),e&&this.freeze(),a&&this.set(a)},get:function(a){return a?this._data[a]:this._data},set:function(d,e,f){var g,h=[],i=this._setting,j=this;n.isPlainObject(d)?(g=d,f=e):(g={})[d]=e,i||(this._prevData=n.clone(this._data),this._changedData={}),this._setting=!0;for(var k in g){e=g[k];var l=this._data[k],m=this._prevData[k];if(!n.isPlainObject(e)||n.isArray(e)){if(l!==e||f||JSON.stringify(l)!==JSON.stringify(e)){var o="undefined"==typeof l?"init":"change";h.push(o+":"+k)}m!==e||f||JSON.stringify(m)!==JSON.stringify(e)?this._changedData[k]=e:this._changedData[k]=void 0,this._data[k]=e}else l&&a(l)?(h.push("change:"+k),this._data[k].set(e,f)):(h.push("init:"+k),this._data[k]=c(k,e,this),this._data[k].unfreeze())}b(this),this.validate&&!i&&this.validate(),(!i||f)&&(this._set?h.length&&h.push("change"):(this._set=!0,h.push("set")),j._setting=!1,j.triggerAll(h,j.getObject()),this.isHook()||this.setReady())},getType:function(){return this._type},getMetadata:function(){return this.isHook()&&o.metadata&&o.metadata.indicators&&("indicator"===this.use||"property"===this.use)?o.metadata.indicators[this.which]:{}},getSubmodels:function(a,b){var c=a?{}:[],b=b||function(){return!0};return n.forEach(this._data,function(d,e){d&&"undefined"!=typeof d._id&&b(d)&&(a?c[e]=d:c.push(d))}),c},getObject:function(){var a={};for(var b in this._data)this._data[b]&&"function"==typeof this._data[b].getObject?a[b]=this._data[b].getObject():a[b]=this._data[b];return a},clear:function(){var a=this.getSubmodels();for(var b in a)a[b].clear();this._spaceDims={},this.setReady(!1),this.unbindAll(),this._intervals.clearAllIntervals(),this._data={}},validate:function(){},isLoading:function(a){if(this.isHook()&&(!this._loadedOnce||this._loadCall))return!0;if(a)return-1!==this._loading.indexOf(a);if(this._loading.length>0)return!0;var b,c=this.getSubmodels();for(b=0;b<c.length;b+=1)if(c[b].isLoading())return!0;for(b=0;b<this._deps.children.length;b+=1){var d=this._deps.children[b];if(d.isLoading()||!d._ready)return!0}return!1},setLoading:function(a){this.isLoading()||this.trigger("load_start"),this._loading.push(a)},setLoadingDone:function(a){this._loading=n.without(this._loading,a),this.setReady()},setReady:function(a){if(a===!1)return this._ready=!1,void(this._parent&&this._parent.setReady&&this._parent.setReady(!1));var b=this._ready;this._ready=!this.isLoading()&&!this._setting&&!this._loadCall,this._ready&&b!==this._ready&&(this._readyOnce||(this._readyOnce=!0,this.trigger("readyOnce")),this.trigger("ready"))},load:function(a){a=a||{};var b=a.splashScreen||!1,c=this,d=this._dataModel,e=this._languageModel,f=this.getQuery(b),g=this._getAllFormatters(),h=new m,i=[];if(this._loadCall=!0,this.isHook()&&d&&f){this.trigger("hook_change");var j=d.getObject();j.formatters=g;var k=e?e.id:"en",o=new m,p={load_start:function(){c.setLoading("_hook_data"),l.Events.freezeAll(["load_start","resize","dom_ready"])}};n.timeStamp("Vizabi Model: Loading Data: "+c._id),q.load(f,k,j,p).then(function(a){c._dataId=a,n.timeStamp("Vizabi Model: Data loaded: "+c._id),c.afterLoad(),o.resolve()},function(a){c.trigger("load_error",f),o.reject(a)}),i.push(o)}n.forEach(this.getSubmodels(!0),function(b,c){i.push(b.load(a))});var r=i.length?m.all(i):new m.resolve;return r.then(function(){c.validate&&c.validate(),n.timeStamp("Vizabi Model: Model loaded: "+c._id),c._loadedOnce=!0,c._loadCall=!1,h.resolve(),n.defer(function(){c.setReady()})}),h},afterPreload:function(){var a=this.getSubmodels();n.forEach(a,function(a){a.afterPreload()})},afterLoad:function(){l.Events.unfreezeAll(),this.setLoadingDone("_hook_data"),s={}},resetDeps:function(){this._deps.children=[]},addDep:function(a){this._deps.children.push(a),a._deps.parent.push(this)},getQuery:function(a){var b,c,d;return this.isHook()?Object.keys(this._space).length<1?(n.error("Error:",this._id,"can't find the space"),!0):(b=this._getAllDimensions(),c=this._getAllFilters(a),"value"!==this.use&&(b=b.concat([this.which])),d=n.unique(b),{select:d,where:c}):!0},isHook:function(){return this.use?!0:!1},setHooks:function(){if(this.isHook())this.hookModel();else{var a=this.getSubmodels();n.forEach(a,function(a){a.setHooks()})}},hookModel:function(){var a=this,b=g(this);this._dataModel=e(this,"data"),this._languageModel=e(this,"language"),n.forEach(b,function(b){a._space[b]=e(a,b),a._space[b].show&&a._space[b].on("change:show",function(b){a.load()})}),this.on("change:which",function(b){a.load()}),this.on("hook_change",function(){a._spaceDims={},a.setReady(!1)})},getSubhooks:function(a){return this.getSubmodels(a,function(a){return a.isHook()})},getHookWhich:function(a){var b=[];return this.use&&this.use===a&&b.push(this.which),n.forEach(this.getSubmodels(),function(c){b=n.unique(b.concat(c.getHookWhich(a)))}),b},getIndicators:function(){return this.getHookWhich("indicator")},getProperties:function(){return this.getHookWhich("property")},getDimension:function(){return this.dim||!1},getFilter:function(){return{}},getValues:function(a,b,c){if(this.isHook())return[];var d,e,f,g,i,j,k,l,i;this._dataCube=this._dataCube||this.getSubhooks(!0),a=n.clone(a,this._getAllDimensions()),d=this._getFirstDimension({type:"time"}),e=new Date(a[d]),a=n.clone(a,null,d);var m={},p=Object.keys(a),q=p.map(function(b){return a[b]});return p.length?n.forEach(this._dataCube,function(b,r){if(g=g||d3.bisectLeft(b.getUnique(d),e),j=b.use,k=b.which,i=o.metadata.indicatorsDB[b.which]?o.metadata.indicatorsDB[b.which].interpolation||"linear":"linear",f=b.getNestedItems(p),n.forEach(q,function(a){f=f[a]}),l=h(f,j,k,g,d,e,i),m[r]=b.mapValue(l),c){var s=n.filter(f,a).filter(function(a){return a[d]<=e}).map(function(a){return b.mapValue(a[k])}).concat(m[r]);m[r]=s}}):n.forEach(this._dataCube,function(p,q){f=p.getNestedItems(b),m[q]={},g="undefined"==typeof g?d3.bisectLeft(p.getUnique(d),e):g,j=p.use,k=p.which,i=o.metadata.indicatorsDB[p.which]?o.metadata.indicatorsDB[p.which].interpolation||"linear":"linear",n.forEach(f,function(b,f){if(l=h(b,j,k,g,d,e,i),m[q][f]=p.mapValue(l),c){var o=n.filter(b,a).filter(function(a){return a[d]<=e}).map(function(a){return p.mapValue(a[k])}).concat(m[q][f]);m[q][f]=o}})}),m},getValue:function(a){if(a=n.clone(a,this._getAllDimensions()),!this.isHook())return void n.warn("getValue method needs the model to be hooked to data.");var b;if("value"===this.use)b=this.which;else if(this._space.hasOwnProperty(this.use))b=this._space[this.use][this.which];else{var c="property"!==this.use?null:this._languageModel.id,d=o.metadata.indicatorsDB[this.which].interpolation||"linear";b=i.call(this,a,this.use,this.which,c,d)}return this.mapValue(b)},mapValue:function(a){return a},getKeys:function(a){if(this.isHook()&&this._dataModel){var b=this._getAllDimensions({exceptType:"time"}),c=this._getAllDimensions({onlyType:"time"});return this.getUnique(b).map(function(b){return n.forEach(c,function(c){a&&a[c]&&(b[c]=a[c])}),b})}var d=this.getSubhooks(),e=[];return d.length>1&&n.forEach(d,function(a){return e=a.getKeys(),!1}),e},getFilteredItems:function(a){if(!a)return n.warn("No filter provided to getFilteredItems(<filter>)"),{};var b=JSON.stringify(a),c=q.get(this._dataId,"filtered");c[b];if(c[b])return c[b];var d=q.get(this._dataId);return c[b]=n.filter(d,a)},getNestedItems:function(a){function b(a){if(!a||!a.length||!a[0].key)return a;for(var c={},d=0;d<a.length;d++)c[a[d].key]=b(a[d].values);return c}if(!a)return n.warn("No order array provided to getNestedItems(<order>). E.g.: getNestedItems(['geo'])"),{};var c,d,e,f;if(c=a.join("-"),d=this._dataId?q.get(this._dataId,"nested"):!1,d&&c in d)return d[c];e=this._dataId?q.get(this._dataId):this.getKeys(),f=d3.nest();for(var g=0;g<a.length;g++)f=f.key(function(a){return function(b){return b[a]}}(a[g]));return d[c]=b(f.entries(e))},getFormatter:function(){},tickFormatter:function(a,b){if(n.isDate(a))return d3.time.format(p.year)(a);if(n.isString(a))return a;var c="f",d=0;Math.abs(a)<1&&(d=1,c="r");var e="";if(b)return d3.format("."+d+c)(a);switch(Math.floor(Math.log10(Math.abs(a)))){case-13:a=1e12*a,e="p";break;case-10:a=1e9*a,e="n";break;case-7:a=1e6*a,e="µ";break;case-6:a=1e6*a,e="µ";break;case-5:a=1e6*a,e="µ";break;case-4:break;case-3:break;case-2:break;case-1:break;case 0:break;case 1:break;case 2:break;case 3:break;case 4:break;case 5:a/=1e3,e="k";break;case 6:a/=1e6,e="M",d=1;break;case 7:a/=1e6,e="M";break;case 8:a/=1e6,e="M";break;case 9:a/=1e9,e="B",d=1;break;case 10:a/=1e9,e="B";break;case 11:a/=1e9,e="B";break;case 12:a/=1e12,e="T",d=1;break;default:return d3.format("."+d+"s")(a).replace("G","B")}return(d3.format("."+d+c)(a)+e).replace("G","B")},getScale:function(a){return this.scale||this.buildScale(a),this.scale},buildScale:function(){if(this.isHook()){var a,b=this.scaleType||"linear";switch(this.use){case"indicator":var c=this.getLimits(this.which);a=[c.min,c.max];break;case"property":a=this.getUnique(this.which);break;default:a=[this.which]}this.scale="time"===b?d3.time.scale().domain(a):d3.scale[b]().domain(a)}},getLimits:function(a){if(this.isHook()){var b=q.get(this._dataId,"limits");if(b[a])return b[a];for(var c,d,e=function(a){return n.isDate(a)?a:parseFloat(a)},f=q.get(this._dataId),g=f.reduce(function(b,c){var d=e(c[a]);return isNaN(d)||b.push(d),b},[]),h={},i=0;i<g.length;i+=1){var j=g[i];("undefined"==typeof c||c>j)&&(c=j),("undefined"==typeof d||j>d)&&(d=j)}return h.min=c||0,h.max=d||100,b[a]=h,h}},getUnique:function(a){if(this.isHook()){a||(a=this._getFirstDimension({type:"time"}));var b,c=q.get(this._dataId,"unique"),d=JSON.stringify(a);if(c[d])return c[d];var e=q.get(this._dataId);if(n.isArray(a)){var f=e.map(function(b){return n.clone(b,a)});b=n.unique(f,function(a){return JSON.stringify(a)})}else{var f=e.map(function(b){return b[a]});b=n.unique(f)}return c[d]=b,b}},getMaxMinMean:function(a){var b=this,c={},d=this._getFirstDimension({type:"time"});return d3.nest().key(function(b){return a.timeFormatter(b[d])}).entries(q.get(this._dataId)).forEach(function(d){var e=d.values.filter(function(a){return null!==a[b.which]}).map(function(a){return+a[b.which]});a.skipZeros&&(e=e.filter(function(a){return 0!=a})),c[d.key]={max:d3.max(e),min:d3.min(e),mean:d3.mean(e)}}),c},_getAllDimensions:function(a){var b=JSON.stringify(a);if(b in this._spaceDims)return this._spaceDims[b];a=a||{};var c,d=[],f=this._space;if(!this.isHook()&&this.space){f=[];var g=this;n.forEach(this.space,function(a){f.push(e(g,a))})}return n.forEach(f,function(b){return a.exceptType&&b.getType()===a.exceptType?!0:a.onlyType&&b.getType()!==a.onlyType?!0:void((c=b.getDimension())&&d.push(c))}),this._spaceDims[b]=d,d},_getFirstDimension:function(a){a=a||{};var b=this._space;if(!this.isHook()&&this.space){b=[];var c=this;n.forEach(this.space,function(a){b.push(e(c,a))})}var d=!1;return n.forEach(b,function(b){return a.exceptType&&b.getType()!==a.exceptType?(d=b.getDimension(),!1):a.type&&b.getType()===a.type?(d=b.getDimension(),!1):a.exceptType||a.type?void 0:(d=b.getDimension(),!1)}),d},_getAllFilters:function(a){var b={};return n.forEach(this._space,function(c){b=n.extend(b,c.getFilter(a))}),b},_getAllFormatters:function(){var a={};return n.forEach(this._space,function(b){var c=b.getFormatter();c&&(a[b.getDimension()]=c)}),a}});l.Model=r;var s={}}.call(this),function(){"use strict";function a(b){var c=new g,d=[];h.forEach(b.components,function(b){d.push(a(b))});var e=d.length?g.all(d):new g.resolve;
return e.then(function(){b.preload(c)},function(a){h.error("Error preloading data:",a)}),c.then(function(){return b.afterPreload(),!0})}function b(a,c){var d=/<[a-z][\s\S]*>/i.test(a)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):i[a]=i[a]||b(e.document.getElementById(a).innerHTML);return c?d(c):d}var c="vzb-loading",d="vzb-loading-first",e=this,f=e.Vizabi,g=f.Promise,h=f.utils,i={},j=f.Events.extend({init:function(a,b){if(this._id=this._id||h.uniqueId("c"),this._ready=!1,this._readyOnce=!1,this.name=this.name||a.name,this.template=this.template||"<div></div>",this.placeholder=this.placeholder||a.placeholder,this.template_data=this.template_data||{name:this.name},this.placeholder&&!h.isElement(this.placeholder))try{this.placeholder=b.placeholder.querySelector(this.placeholder)}catch(c){h.error("Error finding placeholder '"+this.placeholder+"' for component '"+this.name+"'")}this.parent=b||this,this.root=this.parent.root||this,this.components=this.components||[],this._components_config=this.components.map(function(a){return h.clone(a)}),this._frameRate=10,this.model_expects=this.model_expects||[],this.model_binds=this.model_binds||{},this.ui=this.ui||a.ui,this._super();var d=this;this.on({readyOnce:function(){"function"==typeof d.readyOnce&&d.readyOnce()},ready:function(){"function"==typeof d.ready&&d.ready()},domReady:function(){"function"==typeof d.domReady&&d.domReady()},resize:function(){"function"==typeof d.resize&&d.resize()}}),this.triggerResize=h.throttle(this.triggerResize)},preload:function(a){a.resolve()},afterPreload:function(){this.model&&this.model.afterPreload()},render:function(){function b(){h.removeClass(e.placeholder,c),h.removeClass(e.placeholder,d),e.setReady()}var e=this;if(this.loadTemplate(),this.loadComponents(),h.forEach(this.components,function(a){a.render(),e.on("resize",function(){a.trigger("resize")})}),this.isRoot()&&this.model){this.model.on("ready",function(){b()}),this.model.setHooks();var f=this.model&&this.model.data&&this.model.data.splash;a(this).then(function(){if(f){var a=e.model.state.time;a.splash=!0;var b=h.clone(a.getObject(),["start","end"]);e.model.load({splashScreen:!0}).then(function(){h.delay(function(){e.model.setLoading("restore_orig_time"),a.start=b.start,a.end=b.end,e.model.load().then(function(){e.model.setLoadingDone("restore_orig_time"),a.splash=!1,a.trigger("change")})},300)})}else e.model.load()})}else this.model&&this.model.isLoading()?this.model.on("ready",function(){b()}):b()},setReady:function(a){this._readyOnce||(this.trigger("readyOnce"),this._readyOnce=!0),this._ready=!0,this.trigger("ready")},loadTemplate:function(){var a=this.template,e=this.template_data,f=this,g="";if(this.placeholder){if(e=h.extend(e,{t:this.getTranslationFunction(!0)}),this.template)try{g=b(a,e)}catch(i){h.error("Templating error for component: '"+this.name+"' - Check if path to template is correct. E.g.: 'src/components/...'")}h.addClass(this.placeholder,c),h.addClass(this.placeholder,d),this.placeholder.innerHTML=g,this.element=this.placeholder.children[0],this.layout&&(this.layout.setContainer(this.element),this.layout.on("resize",function(){f._ready&&f.triggerResize()})),this.trigger("domReady")}},triggerResize:function(){this.trigger("resize")},loadComponents:function(){var a,b,c=this;this.components=[],this.model&&this.model.resetDeps(),h.forEach(this._components_config,function(d){if(!d.component)return void h.error("Error loading component: name not provided");if(b=f.Component.get(d.component)){a=h.extend(d,{name:d.component,ui:c._uiMapping(d.placeholder,d.ui)});var e=new b(a,c),g=d.model||[];e.model=c._modelMapping(e.name,g,e.model_expects,e.model_binds),e.model.unfreeze(),c.components.push(e)}})},isRoot:function(){return this.parent===this},findChildByName:function(a){return h.find(this.components,function(b){return b.name===a})},getLayoutProfile:function(){return this.layout?this.layout.currentProfile():this.parent.getLayoutProfile()},_uiMapping:function(a,b){if(b)return new f.Model(b);if(a&&this.ui){a=a.replace(".","");var c=this.ui[a];if(c)return c}return this.ui},_modelMapping:function(a,b,c,d){function e(a){for(var b=a.split("."),c=g.model,d="";b.length;)d=b.shift(),c=c[d];return{name:a,model:c,type:c?c.getType():null}}var g=this,i={};if(h.isArray(b)&&h.isArray(c)){c.length!==b.length&&(h.groupCollapsed("DIFFERENCE IN NUMBER OF MODELS EXPECTED AND RECEIVED"),h.warn("Please, configure the 'model_expects' attribute accordingly in '"+a+"' or check the models passed in '"+g.name+"'.\n\nComponent: '"+g.name+"'\nSubcomponent: '"+a+"'\nNumber of Models Expected: "+c.length+"\nNumber of Models Received: "+b.length),h.groupEnd()),h.forEach(b,function(d,f){var j,k=e(d);c[f]?(j=c[f].name,!c[f].type||k.type===c[f].type||h.isArray(c[f].type)&&-1!==c[f].type.indexOf(k.type)||(h.groupCollapsed("UNEXPECTED MODEL TYPE: '"+k.type+"' instead of '"+c[f].type+"'"),h.warn("Please, configure the 'model_expects' attribute accordingly in '"+a+"' or check the models passed in '"+g.name+"'.\n\nComponent: '"+g.name+"'\nSubcomponent: '"+a+"'\nExpected Model: '"+c[f].type+"'\nReceived Model'"+k.type+"'\nModel order: "+f),h.groupEnd())):(h.groupCollapsed("UNEXPECTED MODEL: '"+b[f]+"'"),h.warn("Please, configure the 'model_expects' attribute accordingly in '"+a+"' or check the models passed in '"+g.name+"'.\n\nComponent: '"+g.name+"'\nSubcomponent: '"+a+"'\nNumber of Models Expected: "+c.length+"\nNumber of Models Received: "+b.length),h.groupEnd(),j=k.name),i[j]=k.model});var j=b.length,k=c.length;return k>j&&(c.splice(0,j),h.forEach(k,function(a){i[a.name]={}})),new f.Model(i,null,d,!0)}},getTranslationFunction:function(a){var b;try{b=this.model.get("language").getTFunction()}catch(c){this.parent&&this.parent!==this&&(b=this.parent.getTranslationFunction())}return b||(b=function(a){return a}),a?this._translatedStringFunction(b):b},_translatedStringFunction:function(a){return function(b){var c=a(b);return'<span data-vzb-translate="'+b+'">'+c+"</span>"}},translateStrings:function(){var a=this.getTranslationFunction(),b=this.placeholder.querySelectorAll("[data-vzb-translate]");0!==b.length&&h.forEach(b,function(b){b&&b.getAttribute&&(b.innerHTML=a(b.getAttribute("data-vzb-translate")))})},isTool:function(){return"t"===this._id[0]},readyOnce:function(){},ready:function(){},resize:function(){},clear:function(){this.freeze(),this.model&&this.model.freeze(),f.utils.forEach(this.components,function(a){a.clear()})}});j.isComponent=function(a){return a._id&&("t"===a._id[0]||"c"===a._id[0])},f.Component=j}.call(this),function(){"use strict";function a(a,b){function c(){var e=JSON.stringify(a.getObject()),f=arguments[0]||0;this._readyOnce?b():b(this);var g=JSON.stringify(a.getObject());f>=d?k.error("Max validation loop."):e!==g&&c.call(this,[f+=1])}var d=10;return c}function b(a,c){for(var d,e,f,g,h=Object.keys(c),i=h.length,j=0;i>j;j+=1)d=h[j],"_defs_"!==d&&(e=c[d],f=a[d],g=typeof e,"object"===g&&(g=k.isPlainObject(e)&&e._defs_?"object":k.isArray(e)?"array":"model"),"undefined"==typeof f&&("object"!==g&&"model"!==g?a[d]=e:a[d]=b({},e)),f=a[d],"number"===g&&isNaN(f)?a[d]=0:"string"===g&&"string"!=typeof f?a[d]="":"array"!==g||k.isArray(f)?"model"===g?(k.isObject(f)||(a[d]={}),a[d]=b(a[d],e)):"object"===g&&(k.isObject(f)&&0!==Object.keys(f).length||(f=!1),k.isObject(e._defs_)||(e._defs_={}),a[d]=f||e._defs_):a[d]=[]);return a}function c(a,b){var d={};return k.forEach(a,function(a,e){if(!(e in b))return d[e]=a,!0;if(JSON.stringify(a)===JSON.stringify(b[e]))return!0;if(k.isArray(a))d[e]=a;else if(k.isObject(a))d[e]=c(a,b[e]);else if(k.isDate(b[e])){var f=a.toString(),g=b[e].getFullYear().toString();f!==g&&(d[e]=a)}else d[e]=a}),d}var d="vzb-loading-first",e="vzb-loading",f="vzb-loading-error",g="vzb-placeholder",h="vzb-buttonlist-off",i=this,j=i.Vizabi,k=j.utils,l=j.Model.extend({init:function(c,d,e,f){if(this._id=k.uniqueId("tm"),this._type="tool",this.validate=a(this,f),c=c||{},d=d||{},c=b(c,d),this._super(c,null,e,!0),c.language){var g=this;this.on("change:language",function(){g.trigger("translate")})}}}),m=j.Component.extend({init:function(a,b){this._id=k.uniqueId("t"),this.layout=new j.Layout,this.template=this.template||'<div class="vzb-tool vzb-tool-'+this.name+'"><div class="vzb-tool-content"><div class="vzb-tool-stage"><div class="vzb-tool-viz"></div><div class="vzb-tool-timeslider"></div></div><div class="vzb-tool-buttonlist"></div><div class="vzb-tool-treemenu vzb-hidden"></div><div class="vzb-tool-datawarning vzb-hidden"></div></div></div>',this.model_binds=this.model_binds||{},this.default_options=this.default_options||{};var c=this.validate.bind(this),d=this,e=k.merge({change:function(a,b){d._ready&&(d.model.validate(),d.trigger(a,b))},translate:function(a,b){d._ready&&j.Promise.all([d.preloadLanguage(),d.model.load()]).then(function(){d.model.validate(),d.translateStrings()})},load_start:function(){d.beforeLoading()},load_error:function(){d.errorLoading()},ready:function(a){d._ready&&d.afterLoading()}},this.model_binds);b=b||{},this.model=new l(b,this.default_options,e,c),this.model.unfreeze(),this.ui=this.model.ui||{},this.ui.splash=this.model&&this.model.data&&this.model.data.splash,this._super({name:this.name||this._id,placeholder:a},this),this._bindEvents(),this.render(),this._setUIOptions()},_bindEvents:function(){this.model.bind&&this.on(this.model.bind.get())},clear:function(){this.layout.clear(),this.setOptions=this.getOptions=function(){},this._super()},setOptions:function(a,b){b?this.model.reset(a):this.model.set(c(a,this.getOptions())),this._setUIOptions()},getOptions:function(){return this.model.getObject()||{}},beforeLoading:function(){this._readyOnce||k.addClass(this.placeholder,d),k.hasClass(this.placeholder,e)||k.addClass(this.placeholder,e)},afterLoading:function(){k.removeClass(this.placeholder,e),k.removeClass(this.placeholder,d)},errorLoading:function(){k.addClass(this.placeholder,f)},validate:function(a){if(a=this.model||a,!a||!a.state)return void k.warn("tool validation aborted: model.state looks wrong: "+a);var b=a.state.time,c=a.state.marker;if(!b)return void k.warn("tool validation aborted: time looks wrong: "+b);if(!c)return void k.warn("tool validation aborted: marker looks wrong: "+c);var d=c.label;if(!d)return void k.warn("tool validation aborted: marker label looks wrong: "+d);if(!(a.isLoading()||!d.getKeys()||d.getKeys().length<1)){var e=d.getLimits(b.getDimension()).min,f=d.getLimits(b.getDimension()).max;k.isDate(e)||k.warn("tool validation: min date looks wrong: "+e),k.isDate(f)||k.warn("tool validation: max date looks wrong: "+f),b.start<e&&(b.start=e),b.end>f&&(b.end=f)}},_setUIOptions:function(){k.addClass(this.placeholder,g),this.ui&&this.ui.buttons&&this.ui.buttons.length?k.removeClass(this.element,h):k.addClass(this.element,h)},preloadLanguage:function(){return j.Promise.resolve()}});m.isTool=function(a){return a._id&&"t"===a._id[0]},j.Tool=m}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.iconset={"paint-brush":'<svg class="vzb-icon vzb-icon-paint-brush" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1615 0q70 0 122.5 46.5t52.5 116.5q0 63-45 151-332 629-465 752-97 91-218 91-126 0-216.5-92.5t-90.5-219.5q0-128 92-212l638-579q59-54 130-54zm-909 1034q39 76 106.5 130t150.5 76l1 71q4 213-129.5 347t-348.5 134q-123 0-218-46.5t-152.5-127.5-86.5-183-29-220q7 5 41 30t62 44.5 59 36.5 46 17q41 0 55-37 25-66 57.5-112.5t69.5-76 88-47.5 103-25.5 125-10.5z"/></svg>',search:'<svg class="vzb-icon vzb-icon-search" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1216 832q0-185-131.5-316.5t-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5 316.5-131.5 131.5-316.5zm512 832q0 52-38 90t-90 38q-54 0-90-38l-343-342q-179 124-399 124-143 0-273.5-55.5t-225-150-150-225-55.5-273.5 55.5-273.5 150-225 225-150 273.5-55.5 273.5 55.5 225 150 150 225 55.5 273.5q0 220-124 399l343 343q37 37 37 90z"/></svg>',circle:'<svg class="vzb-icon vzb-icon-circle" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1664 896q0 209-103 385.5t-279.5 279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5 385.5-103 385.5 103 279.5 279.5 103 385.5z"/></svg>',expand:'<svg class="vzb-icon vzb-icon-expand" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M883 1056q0 13-10 23l-332 332 144 144q19 19 19 45t-19 45-45 19h-448q-26 0-45-19t-19-45v-448q0-26 19-45t45-19 45 19l144 144 332-332q10-10 23-10t23 10l114 114q10 10 10 23zm781-864v448q0 26-19 45t-45 19-45-19l-144-144-332 332q-10 10-23 10t-23-10l-114-114q-10-10-10-23t10-23l332-332-144-144q-19-19-19-45t19-45 45-19h448q26 0 45 19t19 45z"/></svg>',asterisk:'<svg class="vzb-icon vzb-icon-asterisk" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1546 1050q46 26 59.5 77.5t-12.5 97.5l-64 110q-26 46-77.5 59.5t-97.5-12.5l-266-153v307q0 52-38 90t-90 38h-128q-52 0-90-38t-38-90v-307l-266 153q-46 26-97.5 12.5t-77.5-59.5l-64-110q-26-46-12.5-97.5t59.5-77.5l266-154-266-154q-46-26-59.5-77.5t12.5-97.5l64-110q26-46 77.5-59.5t97.5 12.5l266 153v-307q0-52 38-90t90-38h128q52 0 90 38t38 90v307l266-153q46-26 97.5-12.5t77.5 59.5l64 110q26 46 12.5 97.5t-59.5 77.5l-266 154z"/></svg>',trails:'<svg class="vzb-icon vzb-icon-trails" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M 1381.375 17.1875 C 1375.7825 17.176804 1370.1216 17.316078 1364.4375 17.5625 C 1273.4913 21.505489 1197.0982 57.199956 1135.2188 124.6875 C 1076.5961 188.62338 1047.6964 263.96059 1048.5312 350.65625 L 835.71875 433 C 797.77288 391.67699 749.96961 361.96416 692.3125 343.84375 C 604.96227 316.39162 520.95691 323.70366 440.25 365.8125 C 359.5432 407.92133 305.45225 472.64985 278 560 C 250.54783 647.35004 257.89117 731.38694 300 812.09375 C 342.10886 892.80075 406.83755 946.89147 494.1875 974.34375 C 576.9404 1000.3512 657.38873 994.58645 735.5625 957.09375 L 959.28125 1171.4375 L 972.375 1184.4062 C 966.2931 1198.3454 961.94845 1209.2226 959.34375 1217.0625 C 956.73915 1224.9024 953.7186 1236.224 950.25 1251.0312 L 711.03125 1285.1875 C 669.59175 1209.0324 607.72526 1157.2863 525.40625 1129.9375 C 438.51381 1101.0693 354.34933 1107.021 272.96875 1147.8125 C 191.58796 1188.6039 136.49335 1252.4513 107.625 1339.3438 C 78.756758 1426.2362 84.708528 1510.3694 125.5 1591.75 C 166.29138 1673.1307 230.1387 1728.2567 317.03125 1757.125 C 403.92369 1785.9933 488.05682 1780.0415 569.4375 1739.25 C 650.81799 1698.4587 705.94425 1634.6111 734.8125 1547.7188 C 737.41718 1539.8788 740.43763 1528.5573 743.90625 1513.75 L 983.125 1479.5938 C 1024.5644 1555.7487 1086.4309 1607.4948 1168.75 1634.8438 C 1255.6425 1663.7119 1339.8069 1657.7603 1421.1875 1616.9688 C 1502.5682 1576.1772 1557.6631 1512.3299 1586.5312 1425.4375 C 1615.3996 1338.5451 1609.4477 1254.4119 1568.6562 1173.0312 C 1527.8647 1091.6506 1464.0174 1036.5244 1377.125 1007.6562 C 1294.9259 980.34721 1214.5066 984.74084 1135.8438 1020.8125 L 1120.2812 1005.9062 L 898.0625 785.96875 C 902.79653 774.40321 906.33847 765.03422 908.5 758.15625 C 920.42249 720.22 925.7916 682.90194 924.59375 646.21875 L 1130.9688 566.34375 C 1141.2015 577.59424 1149.3796 586.0106 1155.4688 591.59375 C 1222.9566 653.47326 1302.1474 682.44278 1393.0938 678.5 C 1484.04 674.55731 1560.4642 638.83151 1622.3438 571.34375 C 1684.2232 503.85591 1713.1929 424.6337 1709.25 333.6875 C 1705.3072 242.74139 1669.5816 166.34819 1602.0938 104.46875 C 1538.8238 46.456824 1465.2625 17.347946 1381.375 17.1875 z "/></svg>',lock:'<svg class="vzb-icon vzb-icon-lock" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M640 768h512v-192q0-106-75-181t-181-75-181 75-75 181v192zm832 96v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-192q0-184 132-316t316-132 316 132 132 316v192h32q40 0 68 28t28 68z"/></svg>',unlock:'<svg class="vzb-icon vzb-icon-unlock" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1376 768q40 0 68 28t28 68v576q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-576q0-40 28-68t68-28h32v-320q0-185 131.5-316.5t316.5-131.5 316.5 131.5 131.5 316.5q0 26-19 45t-45 19h-64q-26 0-45-19t-19-45q0-106-75-181t-181-75-181 75-75 181v320h736z"/></svg>',unexpand:'<svg class="vzb-icon vzb-icon-unexpand" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 960v448q0 26-19 45t-45 19-45-19l-144-144-332 332q-10 10-23 10t-23-10l-114-114q-10-10-10-23t10-23l332-332-144-144q-19-19-19-45t19-45 45-19h448q26 0 45 19t19 45zm755-672q0 13-10 23l-332 332 144 144q19 19 19 45t-19 45-45 19h-448q-26 0-45-19t-19-45v-448q0-26 19-45t45-19 45 19l144 144 332-332q10-10 23-10t23 10l114 114q10 10 10 23z"/></svg>',axes:'<svg class="vzb-icon vzb-icon-axes" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg"><path d="M430.25,379.655l-75.982-43.869v59.771H120.73V151.966h59.774l-43.869-75.983L92.767,0L48.898,75.983L5.029,151.966h59.775 v271.557c0,15.443,12.52,27.965,27.963,27.965h261.5v59.773l75.982-43.869l75.982-43.867L430.25,379.655z"/></svg>',gear:'<svg class="vzb-icon vzb-icon-gear" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1152 896q0-106-75-181t-181-75-181 75-75 181 75 181 181 75 181-75 75-181zm512-109v222q0 12-8 23t-20 13l-185 28q-19 54-39 91 35 50 107 138 10 12 10 25t-9 23q-27 37-99 108t-94 71q-12 0-26-9l-138-108q-44 23-91 38-16 136-29 186-7 28-36 28h-222q-14 0-24.5-8.5t-11.5-21.5l-28-184q-49-16-90-37l-141 107q-10 9-25 9-14 0-25-11-126-114-165-168-7-10-7-23 0-12 8-23 15-21 51-66.5t54-70.5q-27-50-41-99l-183-27q-13-2-21-12.5t-8-23.5v-222q0-12 8-23t19-13l186-28q14-46 39-92-40-57-107-138-10-12-10-24 0-10 9-23 26-36 98.5-107.5t94.5-71.5q13 0 26 10l138 107q44-23 91-38 16-136 29-186 7-28 36-28h222q14 0 24.5 8.5t11.5 21.5l28 184q49 16 90 37l142-107q9-9 24-9 13 0 25 10 129 119 165 170 7 8 7 22 0 12-8 23-15 21-51 66.5t-54 70.5q26 50 41 98l183 28q13 2 21 12.5t8 23.5z"/></svg>',stack:'<svg class="vzb-icon vzb-icon-stack" viewBox="0 0 54.849 54.849" xmlns="http://www.w3.org/2000/svg"><g><path d="M54.497,39.614l-10.363-4.49l-14.917,5.968c-0.537,0.214-1.165,0.319-1.793,0.319c-0.627,0-1.254-0.104-1.79-0.318     l-14.921-5.968L0.351,39.614c-0.472,0.203-0.467,0.524,0.01,0.716L26.56,50.81c0.477,0.191,1.251,0.191,1.729,0L54.488,40.33     C54.964,40.139,54.969,39.817,54.497,39.614z"/><path d="M54.497,27.512l-10.364-4.491l-14.916,5.966c-0.536,0.215-1.165,0.321-1.792,0.321c-0.628,0-1.256-0.106-1.793-0.321     l-14.918-5.966L0.351,27.512c-0.472,0.203-0.467,0.523,0.01,0.716L26.56,38.706c0.477,0.19,1.251,0.19,1.729,0l26.199-10.479     C54.964,28.036,54.969,27.716,54.497,27.512z"/><path d="M0.361,16.125l13.662,5.465l12.537,5.015c0.477,0.191,1.251,0.191,1.729,0l12.541-5.016l13.658-5.463     c0.477-0.191,0.48-0.511,0.01-0.716L28.277,4.048c-0.471-0.204-1.236-0.204-1.708,0L0.351,15.41     C-0.121,15.614-0.116,15.935,0.361,16.125z"/></g></svg>',drag:'<svg class="vzb-icon vzb-icon-drag" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 384q-53 0-90.5 37.5t-37.5 90.5v128h-32v-93q0-48-32-81.5t-80-33.5q-46 0-79 33t-33 79v429l-32-30v-172q0-48-32-81.5t-80-33.5q-46 0-79 33t-33 79v224q0 47 35 82l310 296q39 39 39 102 0 26 19 45t45 19h640q26 0 45-19t19-45v-25q0-41 10-77l108-436q10-36 10-77v-246q0-48-32-81.5t-80-33.5q-46 0-79 33t-33 79v32h-32v-125q0-40-25-72.5t-64-40.5q-14-2-23-2-46 0-79 33t-33 79v128h-32v-122q0-51-32.5-89.5t-82.5-43.5q-5-1-13-1zm0-128q84 0 149 50 57-34 123-34 59 0 111 27t86 76q27-7 59-7 100 0 170 71.5t70 171.5v246q0 51-13 108l-109 436q-6 24-6 71 0 80-56 136t-136 56h-640q-84 0-138-58.5t-54-142.5l-308-296q-76-73-76-175v-224q0-99 70.5-169.5t169.5-70.5q11 0 16 1 6-95 75.5-160t164.5-65q52 0 98 21 72-69 174-69z"/></svg>',warn:'<svg class="vzb-icon vzb-icon-warn" viewBox="0 0 512.209 512.209" xmlns="http://www.w3.org/2000/svg"><path d="M507.345,439.683L288.084,37.688c-3.237-5.899-7.71-10.564-13.429-13.988c-5.705-3.427-11.893-5.142-18.554-5.142   s-12.85,1.718-18.558,5.142c-5.708,3.424-10.184,8.089-13.418,13.988L4.859,439.683c-6.663,11.998-6.473,23.989,0.57,35.98   c3.239,5.517,7.664,9.897,13.278,13.128c5.618,3.237,11.66,4.859,18.132,4.859h438.529c6.479,0,12.519-1.622,18.134-4.859   c5.62-3.23,10.038-7.611,13.278-13.128C513.823,463.665,514.015,451.681,507.345,439.683z M292.655,411.132   c0,2.662-0.91,4.897-2.71,6.704c-1.807,1.811-3.949,2.71-6.427,2.71h-54.816c-2.474,0-4.616-0.899-6.423-2.71   c-1.809-1.807-2.713-4.042-2.713-6.704v-54.248c0-2.662,0.905-4.897,2.713-6.704c1.807-1.811,3.946-2.71,6.423-2.71h54.812   c2.479,0,4.62,0.899,6.428,2.71c1.803,1.807,2.71,4.042,2.71,6.704v54.248H292.655z M292.088,304.357   c-0.198,1.902-1.198,3.47-3.001,4.709c-1.811,1.238-4.046,1.854-6.711,1.854h-52.82c-2.663,0-4.947-0.62-6.849-1.854   c-1.908-1.243-2.858-2.807-2.858-4.716l-4.853-130.47c0-2.667,0.953-4.665,2.856-5.996c2.474-2.093,4.758-3.14,6.854-3.14h62.809   c2.098,0,4.38,1.043,6.854,3.14c1.902,1.331,2.851,3.14,2.851,5.424L292.088,304.357z"/></svg>',pinIcon:'<svg class="vzb-icon" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M800 864v-448q0-14-9-23t-23-9-23 9-9 23v448q0 14 9 23t23 9 23-9 9-23zm672 352q0 26-19 45t-45 19h-429l-51 483q-2 12-10.5 20.5t-20.5 8.5h-1q-27 0-32-27l-76-485h-404q-26 0-45-19t-19-45q0-123 78.5-221.5t177.5-98.5v-512q-52 0-90-38t-38-90 38-90 90-38h640q52 0 90 38t38 90-38 90-90 38v512q99 0 177.5 98.5t78.5 221.5z"/></svg>'}}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/bubblesize/bubblesize.html"),b.innerHTML='<div class="vzb-bs-holder"> <input type="range" id="vzb-bs-slider" class="vzb-bs-slider" step="1"> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/axes-mc/axes-mc.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="axes-mc" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="axes-mc" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/axes") %> </div> <div class="vzb-dialog-content"> <div class="vzb-yaxis-container"> <p class="vzb-dialog-sublabel"><%=t ( "hints/mount/maxYvalue") %></p> <br/> <form> <input type="radio" name="ymax" value="immediate"><%=t ( "mount/maxYmode/immediate") %> <input type="radio" name="ymax" value="latest"><%=t ( "mount/maxYmode/latest") %> </form> </div> <br/> <div class="vzb-xaxis-container"> <p class="vzb-dialog-sublabel"><%=t ( "hints/mount/logXstops") %></p> <br/> <form> <input type="checkbox" name="logstops" value="1">1 <input type="checkbox" name="logstops" value="2">2 <input type="checkbox" name="logstops" value="5">5 </form> </div> <br/> <p class="vzb-dialog-sublabel"><%=t ( "hints/mount/xlimits") %></p> <span class="vzb-xlimits-container"></span> <div class="vzb-povertyline-container"> <p><%=t ( "hints/mount/povertyline") %></p> <input type="text" class="vzb-povertyline-field" name="povertyline"> </div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/axes/axes.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="axes" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="axes" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/axes") %> </div> <div class="vzb-dialog-content"> <p class="vzb-dialog-sublabel"><%=t ("buttons/axis_x") %></p> <div class="vzb-xaxis-container"></div> <p class="vzb-dialog-sublabel"><%=t ("buttons/axis_y") %></p> <div class="vzb-yaxis-container"></div> <div class="vzb-axes-options"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/colors/colors.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="colors" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="colors" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/colors") %> </div> <div class="vzb-dialog-content"> <span class="vzb-caxis-container"></span> <div class="vzb-clegend-container"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/find/find.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="find" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="find" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/find") %> </div> <div class="vzb-dialog-content vzb-find-filter"> <input id="vzb-find-search" class="vzb-dialog-input" type="text" placeholder="Search..."/> </div> <div class="vzb-dialog-content vzb-dialog-content-fixed"> <div class="vzb-find-list">  </div> </div> <div class="vzb-dialog-buttons"> <div class="vzb-dialog-bubbleopacity vzb-dialog-control"></div> <div id="vzb-find-deselect" class="vzb-dialog-button"> <%=t ( "buttons/deselect") %> </div> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> <%=t ( "buttons/ok") %> </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/moreoptions/moreoptions.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="moreoptions" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="moreoptions" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ("buttons/more_options") %> </div> <div class="vzb-dialog-content"> <p class="vzb-dialog-sublabel"><%=t ("buttons/opacityRegular") %></p> <div class="vzb-dialog-bubbleopacity-regular"></div> <p class="vzb-dialog-sublabel"><%=t ("buttons/opacityNonselect") %></p> <div class="vzb-dialog-bubbleopacity-selectdim"></div> <div class="vzb-dialog-br"></div> <p class="vzb-dialog-sublabel"><%=t ("buttons/axis_x") %></p> <div class="vzb-xaxis-container"></div> <p class="vzb-dialog-sublabel"><%=t ("buttons/axis_y") %></p> <div class="vzb-yaxis-container"></div> <div class="vzb-axes-options"></div> <div class="vzb-dialog-br"></div> <p class="vzb-dialog-sublabel"><%=t ("buttons/size") %></p> <div class="vzb-saxis-container"></div> <p class="vzb-dialog-sublabel"><%=t ( "hints/bubbl/setminsize") %></p> <div class="vzb-dialog-bubblesize-min"></div> <p class="vzb-dialog-sublabel"><%=t ( "hints/bubbl/setmaxsize") %></p> <div class="vzb-dialog-bubblesize-max"></div> <div class="vzb-dialog-br"></div> <p class="vzb-dialog-sublabel"><%=t ("buttons/colors") %></p> <div class="vzb-caxis-container"></div> <div class="vzb-clegend-container"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/size/size.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="size" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="size" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/size") %> </div> <div class="vzb-dialog-content"> <div class="vzb-saxis-container"></div> <p class="vzb-dialog-sublabel"><%=t ( "hints/bubbl/setminsize") %></p> <div class="vzb-dialog-bubblesize-min"></div> <p class="vzb-dialog-sublabel"><%=t ( "hints/bubbl/setmaxsize") %></p> <div class="vzb-dialog-bubblesize-max"></div> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/buttonlist/dialogs/stack/stack.html"),b.innerHTML='<div class="vzb-dialog-modal"> <span class="thumb-tack-class thumb-tack-class-ico-pin fa" data-dialogtype="stack" data-click="pinDialog"></span> <span class="thumb-tack-class thumb-tack-class-ico-drag fa" data-dialogtype="stack" data-click="dragDialog"></span> <div class="vzb-dialog-title"> <%=t ( "buttons/stack") %> </div> <div class="vzb-dialog-content"> <p><%=t ( "hints/mount/howtostack") %></p> <br/> <form id="vzb-howtostack"> <input type="radio" name="stack" value="geo.region"><%=t ( "mount/stacking/region") %> <input type="radio" name="stack" value="all"><%=t ( "mount/stacking/world") %> <input type="radio" name="stack" value="none"><%=t ( "mount/stacking/none") %> </form> <br/><br/> <form id="vzb-merge-grouped"> <input type="checkbox" name="mergeGrouped"><%=t ( "mount/mergegrouped") %> </form> <br/><br/> <form id="vzb-merge-stacked"> <input type="checkbox" name="mergeStacked"><%=t ( "mount/mergestacked") %> </form> <br/><br/> <form id="vzb-manual-sorting"> <%=t ( "mount/manualSorting") %><br/> <div class="vzb-dialog-draggablelist vzb-dialog-control"></div> </form> </div> <div class="vzb-dialog-buttons"> <div data-click="closeDialog" class="vzb-dialog-button vzb-label-primary"> OK </div> </div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/components/_gapminder/timeslider/timeslider.html"),b.innerHTML='<div class="vzb-timeslider vzb-ts-loading"> <div class="vzb-ts-slider-wrapper"> <svg class="vzb-ts-slider"> <g> <g class="vzb-ts-slider-axis"></g> <g class="vzb-ts-slider-slide"> <circle class="vzb-ts-slider-handle"></circle> <text class="vzb-ts-slider-value"></text> </g> </g> </svg> </div>  <div class="vzb-ts-btns"> <button class="vzb-ts-btn-loading vzb-ts-btn"> <div class="vzb-loader"></div> </button> <button class="vzb-ts-btn-play vzb-ts-btn"> <svg class="vzb-icon vzb-icon-play" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"> <path d="M1576 927l-1328 738q-23 13-39.5 3t-16.5-36v-1472q0-26 16.5-36t39.5 3l1328 738q23 13 23 31t-23 31z"/> </svg> </button> <button class="vzb-ts-btn-pause vzb-ts-btn"> <svg class="vzb-icon vzb-icon-pause" width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"> <path d="M1664 192v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45zm-896 0v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45z"/> </svg> </button> </div> </div> ',
a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/barchart/barchart.html"),b.innerHTML=' <svg class="vzb-barchart"> <g class="vzb-bc-graph"> <g class="vzb-bc-bars"></g> <g class="vzb-bc-bar-labels"></g> <g class="vzb-bc-axis-y-title"></g> <g class="vzb-bc-axis-x-title"></g> <g class="vzb-bc-axis-x"></g> <g class="vzb-bc-axis-y"></g> <g class="vzb-bc-axis-labels">  </g> </g> </svg> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/bubblechart/bubblechart.html"),b.innerHTML=' <div class="vzb-bubblechart"> <svg class="vzb-bubblechart-svg"> <g class="vzb-bc-graph"> <text class="vzb-bc-year"></text> <svg class="vzb-bc-axis-x"> <g></g> </svg> <svg class="vzb-bc-axis-y"> <g></g> </svg> <line class="vzb-bc-projection-x"></line> <line class="vzb-bc-projection-y"></line> <svg class="vzb-bc-bubbles-crop"> <g class="vzb-bc-lines"></g> <g class="vzb-bc-trails"></g> <g class="vzb-bc-bubbles"></g> <g class="vzb-bc-labels"></g> </svg> <g class="vzb-bc-axis-y-title"></g> <g class="vzb-bc-axis-x-title"></g> <g class="vzb-bc-axis-s-title"></g> <g class="vzb-bc-axis-c-title"></g> <g class="vzb-bc-axis-y-info"> <circle></circle> <text>?</text> </g> <g class="vzb-bc-axis-x-info"> <circle></circle> <text>?</text> </g> <g class="vzb-data-warning"> <svg></svg> <text></text> </g> <rect class="vzb-bc-zoomRect"></rect> <g class="vzb-bc-tooltip vzb-hidden"> <rect class="vzb-bc-tooltip-border"></rect> <text class="vzb-bc-tooltip-text"></text> </g> </g> <filter id="vzb-bc-blur-effect"> <feGaussianBlur stdDeviation="2"/> </filter> </svg>  <div class="vzb-tooltip vzb-hidden vzb-tooltip-mobile"></div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/linechart/linechart.html"),b.innerHTML=' <div class="vzb-linechart"> <svg class="vzb-lc-graph"> <g> <g class="vzb-lc-axis-x"></g> <text class="vzb-lc-axis-x-value"></text> <text class="vzb-lc-axis-y-value"></text> <svg class="vzb-lc-lines"></svg> <g class="vzb-lc-axis-y"></g> <line class="vzb-lc-projection-x"></line> ; <line class="vzb-lc-projection-y"></line> ; <g class="vzb-lc-labels"> <line class="vzb-lc-vertical-now"></line> ; </g> <g class="vzb-lc-axis-y-title"></g> <g class="vzb-lc-axis-x-title"></g> </g>  </svg> <div class="vzb-tooltip vzb-hidden"></div> </div> ',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/mountainchart/mountainchart.html"),b.innerHTML=' <div class="vzb-mountainchart"> <svg class="vzb-mountainchart-svg"> <g class="vzb-mc-graph"> <rect class="vzb-mc-eventarea"></rect> <text class="vzb-mc-year"></text> <g class="vzb-mc-mountains-mergestacked"></g> <g class="vzb-mc-mountains-mergegrouped"></g> <g class="vzb-mc-mountains"></g> <g class="vzb-mc-mountains-labels"></g> <g class="vzb-mc-axis-y-title"> <text></text> </g> <g class="vzb-mc-axis-x-title"> <text></text> </g> <g class="vzb-mc-axis-info"> <circle></circle> <text>?</text> </g> <g class="vzb-data-warning"> <svg></svg> <text></text> </g> <g class="vzb-mc-axis-x"></g> <g class="vzb-mc-axis-labels"></g> <g class="vzb-mc-povertyline"> <text class="vzb-shadow vzb-mc-povertyline-valueUL"></text> <text class="vzb-shadow vzb-mc-povertyline-valueUR"></text> <text class="vzb-shadow vzb-mc-povertyline-valueDL"></text> <text class="vzb-shadow vzb-mc-povertyline-valueDR"></text> <text class="vzb-mc-povertyline-valueUL"></text> <text class="vzb-mc-povertyline-valueUR"></text> <text class="vzb-mc-povertyline-valueDL"></text> <text class="vzb-mc-povertyline-valueDR"></text> <text class="vzb-mc-povertyline-extremepoverty"></text> <line></line> </g> <g class="vzb-mc-tooltip vzb-hidden"> <rect class="vzb-bc-tooltip-border"></rect> <text class="vzb-bc-tooltip-text"></text> </g> </g> </svg> </div>',a.document.body.appendChild(b)}.call(this),function(){var a=this,b=a.document.createElement("script");b.type="text/template",b.setAttribute("id","src/tools/popbyage/popbyage.html"),b.innerHTML=' <svg class="vzb-popbyage"> <g class="vzb-bc-header"> <text class="vzb-bc-title"></text> <text class="vzb-bc-year"></text> </g> <g class="vzb-bc-graph"> <g class="vzb-bc-bars"></g> <g class="vzb-bc-labels"></g> <text class="vzb-bc-axis-y-title"></text> <g class="vzb-bc-axis-x"></g> <g class="vzb-bc-axis-y"></g> <g class="vzb-bc-axis-labels">  </g> </g> </svg> ',a.document.body.appendChild(b)}.call(this),function(){"use strict";var a=this.Vizabi;a.utils;a._require("d3")&&a.Component.extend("gapminder-bubbleopacity",{init:function(a,b){this.template='<div class="vzb-bo-holder"><input type="range" id="vzb-bo-slider" class="vzb-bo-slider" step="1"></div>',this.model_expects=[{name:"entities",type:"entities"}];var c=this;this.arg=a.arg,this.model_binds={"change:entities:select":function(a){c.updateView()}},this.model_binds["change:entities:"+this.arg]=function(a){c.updateView()},this._super(a,b)},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.slider=this.element.selectAll("#vzb-bo-slider"),this.elementSize=this.element.node().getBoundingClientRect(),this.sliderSize=this.slider.node().getBoundingClientRect(),this.slider.style("left",this.elementSize.left-this.sliderSize.left+"px"),this.slider.attr("min",0).attr("max",1).attr("step",.1).on("input",function(){a._setModel()}),this.updateView()},updateView:function(){var a=(this.model.entities.select.length,this.model.entities[this.arg]);this.slider.attr("value",a)},_setModel:function(){this.model.entities[this.arg]=+d3.event.target.value}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils;if(b._require("d3")){b.Component.extend("gapminder-bubblesize",{init:function(a,b){this.template=this.template||"src/components/_gapminder/bubblesize/bubblesize.html",this.model_expects=[{name:"size",type:"size"}],this.field=a.field||"max";var c=this;this.model_binds={"change:size":function(a){a.indexOf(c.field)>-1&&(c.sliderEl.node().value=c.model.size[c.field])}},this._super(a,b)},readyOnce:function(){var a=this.model.size[this.field],b=this;this.element=d3.select(this.element),this.indicatorEl=this.element.select("#vzb-bs-indicator"),this.sliderEl=this.element.selectAll("#vzb-bs-slider"),this.sliderEl.attr("min",0).attr("max",1).attr("step",.01).attr("value",a).on("input",function(){b.slideHandler()})},modelReady:function(){this.indicatorEl.text(this.model.size[this.field])},slideHandler:function(){this._setValue(+d3.event.target.value)},_setValue:function(a){var b=50,c=new Date;null!=this._updTime&&c-this._updTime<b||(this._updTime=c,this.model.size[this.field]=a)}})}}.call(this),function(){"use strict";function a(){return void 0!==g.document.webkitIsFullScreen?g.document.webkitIsFullScreen:void 0!==g.document.mozFullScreen?g.document.mozFullScreen:void 0!==g.document.msFullscreenElement?g.document.msFullscreenElement:!1}function b(b){a()||b()}function c(a){var c=g.document;this.exitFullscreenHandler=b.bind(this,a),c.addEventListener("webkitfullscreenchange",this.exitFullscreenHandler,!1),c.addEventListener("mozfullscreenchange",this.exitFullscreenHandler,!1),c.addEventListener("fullscreenchange",this.exitFullscreenHandler,!1),c.addEventListener("MSFullscreenChange",this.exitFullscreenHandler,!1)}function d(){var a=g.document;a.removeEventListener("webkitfullscreenchange",this.exitFullscreenHandler),a.removeEventListener("mozfullscreenchange",this.exitFullscreenHandler),a.removeEventListener("fullscreenchange",this.exitFullscreenHandler),a.removeEventListener("MSFullscreenChange",this.exitFullscreenHandler)}function e(a){a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()}function f(){d.call(this),document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}var g=this,h=g.Vizabi,i=(h.Promise,h.utils),j=h.iconset;if(h._require("d3")){var k="vzb-active",l="vzb-active-locked",m="vzb-unavailable",n="vzb-force-fullscreen";h.Component.extend("gapminder-buttonlist",{init:function(a,b){var c=this;this.name="buttonlist",this.template='<div class="vzb-buttonlist"></div>',this.model_expects=[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this._available_buttons={find:{title:"buttons/find",icon:"search",dialog:!0,ispin:!1},moreoptions:{title:"buttons/more_options",icon:"gear",dialog:!0,ispin:!1},colors:{title:"buttons/colors",icon:"paint-brush",dialog:!0,ispin:!1},size:{title:"buttons/size",icon:"circle",dialog:!0,ispin:!1},fullscreen:{title:"buttons/expand",icon:"expand",dialog:!1,func:this.toggleFullScreen.bind(this)},trails:{title:"buttons/trails",icon:"trails",dialog:!1,func:this.toggleBubbleTrails.bind(this)},lock:{title:"buttons/lock",icon:"lock",dialog:!1,func:this.toggleBubbleLock.bind(this)},axes:{title:"buttons/axes",icon:"axes",dialog:!0,ispin:!1},"axes-mc":{title:"buttons/axes-mc",icon:"axes",dialog:!0,ispin:!1},stack:{title:"buttons/stack",icon:"stack",dialog:!0,ispin:!1},_default:{title:"Button",icon:"asterisk",dialog:!1}},this._active_comp=!1,this.model_binds={"change:state:entities:select":function(){c._readyOnce&&(0===c.model.state.entities.select.length&&(c.model.state.time.lockNonSelected=0),c.setBubbleTrails(),c.setBubbleLock(),c.entitiesSelected_1!==c.model.state.entities.select.length>0&&c.scrollToEnd(),c.entitiesSelected_1=c.model.state.entities.select.length>0)}},this._super(a,b)},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.buttonContainerEl=this.element.append("div").attr("class","vzb-buttonlist-container-buttons"),this.dialogContainerEl=this.element.append("div").attr("class","vzb-buttonlist-container-dialogs"),this.model.ui.buttons&&this._addButtons();var b=this.element.selectAll(".vzb-buttonlist-btn");b.on("click",function(){d3.event.preventDefault(),d3.event.stopPropagation();var b=d3.select(this),c=b.attr("data-btn"),d=b.attr("class"),e=a._available_buttons[c];e&&e.dialog?-1!==d.indexOf(k)?a.closeDialog(c):a.openDialog(c):e.func&&e.func(c)});var c=this.element.selectAll("[data-click='closeDialog']");c.on("click",function(){a.closeAllDialogs(!0)});var d=this.element.selectAll("[data-click='pinDialog']");d.on("click",function(){a.pinDialog(this)}),d3.selectAll(".vzb-buttonlist-container-dialogs").on("click",function(){d3.event.stopPropagation()}),this.root.element.addEventListener("click",function(){a.closeAllDialogs()}),this._prev_body_overflow=document.body.style.overflow,this.setBubbleTrails(),this.setBubbleLock(),d3.select(this.root.element).on("mousedown",function(b){if(this._active_comp){for(var c=d3.event.target,d=!0;c;){if(c.classList.contains("vzb-dialog-modal")){d=!1;break}c=c.parentElement}d&&a.closeAllDialogs()}})},_addButtons:function(){this._components_config=[];var a=!0,b=["find","colors","size"],c=[];if(b.length){console.log(this.getLayoutProfile(),"add buttons");for(var d=0;d<b.length;d++){var e=b[d],f=this._available_buttons[e];if(f&&f.dialog){var g=this._components_config;g.push({component:"gapminder-buttonlist-"+e,placeholder:'.vzb-buttonlist-dialog[data-btn="'+e+'"]',model:["state","ui","language"]}),f.component=g.length-1}var h=f?e:"_default",k=this._available_buttons[h];k.id=e,k.icon=j[k.icon],c.push(k)}var l=this.getTranslationFunction(!0),m=this;this.buttonContainerEl.selectAll("button").data(c).enter().append("button").attr("class",function(b){return console.log(b),"large"===m.getLayoutProfile()&&a?"vzb-buttonlist-btn vzb-dialog-side":"vzb-buttonlist-btn"}).attr("data-btn",function(a){return a.id}).html(function(a){return"<span class='vzb-buttonlist-btn-icon fa'>"+a.icon+"</span><span class='vzb-buttonlist-btn-title'>"+l(a.title)+"</span>"}),this.dialogContainerEl.selectAll("div").data(c).enter().append("div").attr("class",function(){return"large"===m.getLayoutProfile()&&a?"vzb-buttonlist-dialog vzb-dialog-side":"vzb-buttonlist-dialog"}).attr("data-btn",function(a){return a.id}),this.loadComponents();var m=this;i.forEach(this.components,function(a){a.render(),m.on("resize",function(){a.trigger("resize")})})}},scrollToEnd:function(){var a=0,b=d3.select(".vzb-tool");b.classed("vzb-portrait")&&b.classed("vzb-small")?(this.model.state.entities.select.length>0&&(a=this.buttonContainerEl[0][0].scrollWidth),this.buttonContainerEl[0][0].scrollLeft=a):(this.model.state.entities.select.length>0&&(a=this.buttonContainerEl[0][0].scrollHeight),this.buttonContainerEl[0][0].scrollTop=a)},resize:function(){},openDialog:function(a){this.closeAllDialogs(!0);var b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),c=this.element.selectAll(".vzb-buttonlist-dialog[data-btn='"+a+"']");this._active_comp=this.components[this._available_buttons[a].component],this._active_comp.beforeOpen(),b.classed(k,!0),c.classed(k,!0),this._active_comp.open()},pinDialog:function(a){var b="string"==typeof a?a:a.getAttribute("data-dialogtype"),c=this.element.select(".vzb-buttonlist-btn[data-btn='"+b+"']"),d=this.element.select(".vzb-buttonlist-dialog[data-btn='"+b+"']");this._available_buttons[b].ispin?(c.classed("pinned",!1),this.element.select(".vzb-buttonlist-dialog[data-btn='"+b+"']").classed("pinned",!1),this._available_buttons[b].ispin=!1,this._active_comp.isPin=!1):(c.classed("pinned",!0),d.classed("pinned",!0),this._available_buttons[b].ispin=!0,this._active_comp.isPin=!0)},closeDialog:function(a){var b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),c=this.element.selectAll(".vzb-buttonlist-dialog[data-btn='"+a+"']");this._available_buttons[a].ispin&&this.pinDialog(a),this._active_comp&&this._active_comp.beforeClose(),b.classed(k,!1),c.classed(k,!1),this._active_comp&&this._active_comp.close(),this._active_comp=!1},closeAllDialogs:function(a){var b=a?".vzb-buttonlist-btn":".vzb-buttonlist-btn:not(.pinned)",c=a?".vzb-buttonlist-dialog":".vzb-buttonlist-dialog:not(.pinned)",d=this.element.selectAll(b),e=this.element.selectAll(c);a&&this.unpinAllDialogs(),!this._active_comp||!a&&this._available_buttons[this._active_comp.name].ispin||this._active_comp.beforeClose(),d.classed(k,!1),e.classed(k,!1),!this._active_comp||!a&&this._available_buttons[this._active_comp.name].ispin||this._active_comp.close(),this._active_comp&&!this._available_buttons[this._active_comp.name].ispin&&(this._active_comp=!1),this.model.state.entities.setNeedUpdate()},unpinAllDialogs:function(){var a=this._available_buttons,b=Object.keys(a);b.forEach(function(b){a[b].ispin&&this.pinDialog(b)}.bind(this))},toggleBubbleTrails:function(){this.model.state.time.trails=!this.model.state.time.trails,this.setBubbleTrails()},setBubbleTrails:function(){var a="trails",b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']");b.classed(l,this.model.state.time.trails),b.style("display",0==this.model.state.entities.select.length?"none":"inline-block")},toggleBubbleLock:function(a){if(0!=this.model.state.entities.select.length){var b=d3.time.format(this.model.state.time.formatInput),c=this.model.state.time.lockNonSelected;c=c?0:b(this.model.state.time.value),this.model.state.time.lockNonSelected=c,this.setBubbleLock()}},setBubbleLock:function(){var a="lock",b=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),c=this.model.language.getTFunction(),d=this.model.state.time.lockNonSelected;b.classed(m,0==this.model.state.entities.select.length),b.style("display",0==this.model.state.entities.select.length?"none":"inline-block"),b.classed(l,d),b.select(".vzb-buttonlist-btn-title").text(d?d:c("buttons/lock")),b.select(".vzb-buttonlist-btn-icon").html(j[d?"lock":"unlock"])},toggleFullScreen:function(a){for(var b=this,d=b.placeholder,h=!1,k=this.element.selectAll(".vzb-buttonlist-btn[data-btn='"+a+"']"),m=!this.model.ui.fullscreen,o=m?"hidden":this._prev_body_overflow;!(h=i.hasClass(d,"vzb-placeholder"));)b=this.parent,d=b.placeholder;m?(e(d),c.call(this,this.toggleFullScreen.bind(this,a))):f.call(this),i.classed(d,n,m),this.model.ui.fullscreen=m;var p=this.model.language.getTFunction();k.classed(l,m),k.select(".vzb-buttonlist-btn-icon").html(j[m?"unexpand":"expand"]),k.select(".vzb-buttonlist-btn-title").text(p("buttons/"+(m?"unexpand":"expand"))),document.body.style.overflow=o,function(){var a=g.document.createEvent("HTMLEvents");a.initEvent("resize",!0,!0),a.eventName="resize",g.dispatchEvent(a)}()}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b.iconset;b._require("d3")&&b.Component.extend("gapminder-buttonlist-dialog",{init:function(a,b){this.name=this.name||"",this.model_expects=this.model_expects||[{name:"state",type:"model"},{name:"ui",type:"model"},{name:"language",type:"language"}],this.template="src/components/_gapminder/buttonlist/dialogs/"+this.name+"/"+this.name+".html",this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element)},ready:function(){var a=this;this.placeholderEl=d3.select(this.placeholder),this.rootEl=d3.select(this.root.element),this.dragHandler=this.placeholderEl.select("[data-click='dragDialog']"),this.dragHandler.html(d.drag),this.pinIcon=this.placeholderEl.select("[data-click='pinDialog']"),this.pinIcon.html(d.pinIcon);var b=dialogDrag(this.placeholderEl,d3.select(".vzb-tool-content"),75),c=d3.behavior.drag().on("dragstart",function(){a.rootEl.classed("vzb-portrait")||a.isPin||b.dragStart(d3.event)}).on("drag",function(){a.rootEl.classed("vzb-portrait")||a.isPin||b.drag(d3.event)});this.dragHandler.call(c)},resize:function(){if(this.placeholderEl){var a=-parseInt(this.parent.parent.components[0].width,10),b=parseInt(this.placeholderEl.style("left"),10);c.isNumber(b)&&a>b&&(this.placeholderEl.style("left",a+"px"),this.leftPos&&(this.leftPos=a+"px")),this.rootEl.classed("vzb-portrait")&&(this.leftPos=null,this.topPos=null,this.placeholderEl.attr("style",""))}},beforeOpen:function(){var a=this;this.transitionEvents=["webkitTransitionEnd","transitionend","msTransitionEnd","oTransitionEnd"],this.transitionEvents.forEach(function(b){a.placeholderEl.on(b,a.transitionEnd.bind(a,b))}),this.leftPos&&!this.rootEl.classed("vzb-portrait")&&this.placeholderEl.style("left",this.leftPos),this.rootEl.classed("vzb-portrait")&&this.placeholderEl.style("top","")},open:function(){this.isOpen=!0,this.topPos&&!this.rootEl.classed("vzb-portrait")&&this.placeholderEl.style("top",this.topPos)},beforeClose:function(){this.rootEl.classed("vzb-portrait")&&this.placeholderEl.style("top","auto"),this.placeholderEl.classed("notransition",!1),this.placeholderEl.node().offsetHeight},close:function(){(this.isOpen||!this.rootEl.classed("vzb-portrait"))&&(this.leftPos=this.placeholderEl.style("left"),this.topPos=this.placeholderEl.style("top")),this.rootEl.classed("vzb-portrait")||this.placeholderEl.style("top",""),this.isOpen=!1},transitionEnd:function(a){var b=this;this.transitionEvents.forEach(function(a){b.placeholderEl.on(a,null)}),this.placeholderEl.classed("notransition",!0)}})}.call(this),function(){"use strict";var a=this.Vizabi,b=a.Component.get("gapminder-buttonlist-dialog");a.Component.register("gapminder-buttonlist-axes-mc",b.extend({init:function(a,b){this.name="axes-mc";var c=this;this.model_binds={"change:state:time:xLogStops":function(){c.updateView()},"change:state:time:yMaxMethod":function(){c.updateView()},"change:state:time:povertyline":function(){c.updateView()}},this.components=[{component:"gapminder-indicatorpicker",placeholder:".vzb-xlimits-container",model:["state.marker.axis_x","language"],ui:{selectIndicator:!1,selectScaletype:!1,selectMinMax:!0}}],this._super(a,b)},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.yMaxRadio=this.element.select(".vzb-yaxis-container").selectAll("input").on("change",function(){a.setModel("yMaxMethod",d3.select(this).node().value)}),this.xLogStops=this.element.select(".vzb-xaxis-container").selectAll("input").on("change",function(){a.setModel("xLogStops",d3.select(this).node().value)}),this.povertyLineFieldEl=this.element.select(".vzb-povertyline-field").on("change",function(){var b=parseFloat(this.value.replace(",","."));return b<=a.model.state.time.povertyCutoff?void(this.value=a.model.state.time.povertyline):void a.setModel("povertyline",b)}),this.updateView(),this._super()},updateView:function(){var a=this;this.yMaxRadio.property("checked",function(){return d3.select(this).node().value===a.model.state.time.yMaxMethod}),this.xLogStops.property("checked",function(){return-1!==a.model.state.time.xLogStops.indexOf(+d3.select(this).node().value)}),this.povertyLineFieldEl.property("value",this.model.state.time.povertyline)},setModel:function(a,b){var c;"yMaxMethod"==a&&(c=b),"xLogStops"==a&&(c=[],this.xLogStops.each(function(){d3.select(this).property("checked")&&c.push(+d3.select(this).node().value)})),"povertyline"==a&&(c=b),this.model.state.time[a]=c}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=a.Component.get("gapminder-buttonlist-dialog");a.Component.register("gapminder-buttonlist-axes",b.extend({init:function(a,b){this.name="axes";this.components=[{component:"gapminder-indicatorpicker",placeholder:".vzb-xaxis-container",model:["state.marker.axis_x","language"]},{component:"gapminder-indicatorpicker",placeholder:".vzb-yaxis-container",model:["state.marker.axis_y","language"]},{component:"gapminder-simplecheckbox",placeholder:".vzb-axes-options",model:["state","language"],submodel:"time",checkbox:"adaptMinMaxZoom"}],this._super(a,b)}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=(a.utils,a.Component.get("gapminder-buttonlist-dialog"));a._require("d3")&&a.Component.register("gapminder-buttonlist-colors",b.extend({init:function(a,b){this.name="colors",this.components=[{component:"gapminder-indicatorpicker",placeholder:".vzb-caxis-container",model:["state.marker.color","language"]},{component:"gapminder-colorlegend",placeholder:".vzb-clegend-container",model:["state.marker.color","state.entities","language"]}],this._super(a,b)}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils,c=a.Component.get("gapminder-buttonlist-dialog");a._require("d3")&&a.Component.register("gapminder-buttonlist-find",c.extend({init:function(a,b){this.name="find";var c=this;this.components=[{component:"gapminder-bubbleopacity",placeholder:".vzb-dialog-bubbleopacity",model:["state.entities"],arg:"opacitySelectDim"}],this.model_binds={"change:state:entities:select":function(a){c.ready()},"change:state:time:value":function(a){c.model.state.time.playing||c.model.state.time.dragging||c.ready()}},this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element),this.list=this.element.select(".vzb-find-list"),this.input_search=this.element.select("#vzb-find-search"),this.deselect_all=this.element.select("#vzb-find-deselect"),this.opacity_nonselected=this.element.select(".vzb-dialog-bubbleopacity"),this.KEY=this.model.state.entities.getDimension();var a=this;this.input_search.on("input",function(){a.showHideSearch()}),this.deselect_all.on("click",function(){a.deselectEntities()}),this._super()},open:function(){this._super(),this.input_search.node().value="",this.showHideSearch()},ready:function(){this._super();var a=this,c=this.KEY,d=this.model.state.time.getDimension(),e=this.model.state.entities.getSelected(),f=this.model.state.marker,g={};g[d]=this.model.state.time.value;var h=f.getValues(g,[c]),i=f.getKeys().map(function(a){var b={};return b[c]=a[c],b.name=h.label[a[c]],b}).filter(function(a){var d=!0;return b.forEach(h,function(b){return b[a[c]]?void 0:(d=!1,!1)}),d});i.sort(function(a,b){return a.name<b.name?-1:1}),this.list.html("");var j=this.list.selectAll(".vzb-find-item").data(i).enter().append("div").attr("class","vzb-find-item vzb-dialog-checkbox");j.append("input").attr("type","checkbox").attr("class","vzb-find-item").attr("id",function(a){return"-find-"+a[c]}).property("checked",function(a){return-1!==e.indexOf(a[c])}).on("change",function(b){a.model.state.entities.selectEntity(b)}),j.append("label").attr("for",function(a){return"-find-"+a[c]}).text(function(a){return a.name}).on("mouseover",function(b){a.model.state.entities.highlightEntity(b)}).on("mouseout",function(b){a.model.state.entities.clearHighlighted()}),this.showHideSearch(),this.showHideDeselect()},showHideSearch:function(){var a=this.input_search.node().value||"";a=a.toLowerCase(),this.list.selectAll(".vzb-find-item").classed("vzb-hidden",function(b){var c=b.name.toLowerCase();return-1===c.indexOf(a)})},showHideDeselect:function(){var a=!!this.model.state.entities.select.length;this.deselect_all.classed("vzb-hidden",!a),this.opacity_nonselected.classed("vzb-hidden",!a)},deselectEntities:function(){this.model.state.entities.clearSelected()},transitionEnd:function(a){this._super(a),b.isTouchDevice()||this.input_search.node().focus()}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=a.Component.get("gapminder-buttonlist-dialog");a.Component.register("gapminder-buttonlist-moreoptions",b.extend({init:function(a,b){this.name="moreoptions",this.components=[{component:"gapminder-indicatorpicker",placeholder:".vzb-xaxis-container",model:["state.marker.axis_x","language"],ui:{selectMinMax:!0}},{component:"gapminder-indicatorpicker",placeholder:".vzb-yaxis-container",model:["state.marker.axis_y","language"],ui:{selectMinMax:!0}},{component:"gapminder-simplecheckbox",placeholder:".vzb-axes-options",model:["state","language"],submodel:"time",checkbox:"adaptMinMaxZoom"},{component:"gapminder-bubblesize",placeholder:".vzb-dialog-bubblesize-min",model:["state.marker.size"],field:"min"},{component:"gapminder-bubblesize",placeholder:".vzb-dialog-bubblesize-max",model:["state.marker.size"],field:"max"},{component:"gapminder-indicatorpicker",placeholder:".vzb-saxis-container",model:["state.marker.size","language"]},{component:"gapminder-indicatorpicker",placeholder:".vzb-caxis-container",model:["state.marker.color","language"]},{component:"gapminder-colorlegend",placeholder:".vzb-clegend-container",model:["state.marker.color","state.entities","language"]},{component:"gapminder-bubbleopacity",placeholder:".vzb-dialog-bubbleopacity-regular",model:["state.entities"],arg:"opacityRegular"},{component:"gapminder-bubbleopacity",placeholder:".vzb-dialog-bubbleopacity-selectdim",model:["state.entities"],arg:"opacitySelectDim"}],this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element),this.resize()},resize:function(){var a=this.root.element.offsetHeight-200,b=this.element.select(".vzb-dialog-content");b.style("max-height",a+"px"),this._super()}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=a.Component.get("gapminder-buttonlist-dialog");a.Component.register("gapminder-buttonlist-size",b.extend({init:function(a,b){this.name="size",this.components=[{component:"gapminder-bubblesize",placeholder:".vzb-dialog-bubblesize-min",model:["state.marker.size"],ui:{show_button:!1},field:"min"},{component:"gapminder-bubblesize",placeholder:".vzb-dialog-bubblesize-max",model:["state.marker.size"],ui:{show_button:!1},field:"max"},{component:"gapminder-indicatorpicker",placeholder:".vzb-saxis-container",model:["state.marker.size","language"],ui:{selectIndicator:!0,selectScaletype:!1}}],this._super(a,b)}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils,c=a.Component.get("gapminder-buttonlist-dialog");a.Component.register("gapminder-buttonlist-stack",c.extend({init:function(a,b){this.name="stack";var c=this;this.components=[{component:"gapminder-draggablelist",placeholder:".vzb-dialog-draggablelist",model:["language"],dataArrFn:c.manualSorting.bind(c),lang:"region/"}],this.model_binds={"change:state:marker:stack":function(){c.updateView()},"change:state:marker:group":function(){c.updateView()}},this._super(a,b)},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.howToStackEl=this.element.select("#vzb-howtostack").selectAll("input").on("change",function(){a.setModel("stack",d3.select(this).node().value)}),this.mergeGroupedEl=this.element.select("#vzb-merge-grouped").selectAll("input").on("change",function(){a.setModel("merge grouped",d3.select(this).property("checked"))}),this.mergeStackedEl=this.element.select("#vzb-merge-stacked").selectAll("input").on("change",function(){a.setModel("merge stacked",d3.select(this).property("checked"))}),this.updateView(),this._super()},updateView:function(){var a=this;this.howToStackEl.property("checked",function(){return d3.select(this).node().value===a.model.state.marker.stack.which}),this.mergeGroupedEl.property("checked",this.model.state.marker.group.merge),this.mergeStackedEl.property("checked",this.model.state.marker.stack.merge)},manualSorting:function(a){return 0===arguments.length?this.model.state.marker.group.manualSorting:void(this.model.state.marker.group.manualSorting=a)},setModel:function(a,c){if("merge grouped"==a)this.model.state.marker.group.merge=c;else if("merge stacked"==a)this.model.state.marker.stack.merge=c;else{var d=this.model.state.marker.stack,e={};e.which=c,-1==b.values(d.getPalettes()).indexOf(c)?e.use="property":e.use="value",d.set(e)}}}))}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils,c="which";a._require("d3")&&a.Component.extend("gapminder-colorlegend",{init:function(a,b){var c=this;this.template='<div class="vzb-cl-holder"></div>',this.model_expects=[{name:"color",type:"color"},{name:"entities",type:"entities"},{name:"language",type:"language"}],this.needsUpdate=!1,this.which_1=!1,this.scaleType_1=!1,this.model_binds={"change:color":function(a){c.updateView()},"change:language":function(a){c.updateView()},ready:function(a){c._readyOnce&&c.updateView()}},this._super(a,b)},readyOnce:function(){this.element=d3.select(this.element),this.listColorsEl=this.element.append("div").attr("class","vzb-cl-colorList"),this.rainbowEl=this.listColorsEl.append("div").attr("class","vzb-cl-rainbow"),this.worldmapEl=this.listColorsEl.append("div").attr("class","vzb-cl-worldmap"),this.colorPicker=d3.svg.colorPicker(),this.element.call(this.colorPicker),this.worldMap=d3.svg.worldMap(),this.worldmapEl.call(this.worldMap),this.updateView()},updateView:function(){var a=this;this.translator=this.model.language.getTFunction();var d=this.model.entities.getDimension(),e=this.model.color.palette._data,f="_default";Object.keys(this.model.color.getPalettes()).indexOf(this.model.color[c])>-1&&(f=this.model.color[c]);var g=this.model.color.getPalettes()[f];this.listColorsEl.selectAll(".vzb-cl-option").remove();var h=this.listColorsEl.selectAll(".vzb-cl-option").data(b.keys(e),function(a){return a});if(h.enter().append("div").attr("class","vzb-cl-option").each(function(){d3.select(this).append("div").attr("class","vzb-cl-color-sample"),d3.select(this).append("div").attr("class","vzb-cl-color-legend")}).on("mouseover",function(){if(a.model.color.isUserSelectable(f)){var b=d3.select(this).select(".vzb-cl-color-sample");b.style("border-width","5px"),b.style("background-color","transparent")}}).on("mouseout",function(b){if(a.model.color.isUserSelectable(f)){var c=d3.select(this).select(".vzb-cl-color-sample");c.style("border-width","0px"),c.style("background-color",a.model.color.palette[b])}}).on("click",function(b){a.model.color.isUserSelectable(f)&&a.colorPicker.colorOld(e[b]).colorDef(g[b]).callback(function(c){a.model.color.setColor(c,b)}).show(!0)}),"indicator"==this.model.color.use){var i,j=this.listColorsEl.selectAll(".vzb-cl-option");if(j&&j[0]){var k=j[0][0].getBoundingClientRect(),l=j[0][j[0].length-1].getBoundingClientRect();i=l.top+l.height-k.top}isFinite(i)||(i=25*b.keys(e).length+5),this.rainbowEl.classed("vzb-hidden",!1).style("height",i+"px").style("background","linear-gradient("+b.values(e).join(", ")+")");
}else this.rainbowEl.classed("vzb-hidden",!0);if("geo.region"==this.model.color[c]){var m=this.worldmapEl.classed("vzb-hidden",!1).select("svg").selectAll("path");m.each(function(){var a=d3.select(this),b=e[a.attr("id")];a.style("fill",b)}).style("opacity",.8).on("mouseover",function(){var c=d3.select(this),e=c.attr("id");m.style("opacity",.5),c.style("opacity",1);var f=a.model.color.getNestedItems([d]),g=b.values(f).map(function(a){return a[a.length-1]}).filter(function(a){return a["geo.region"]==e}).map(function(a){return b.clone(a,[d])});a.model.entities.setHighlighted(g)}).on("mouseout",function(){m.style("opacity",.8),a.model.entities.clearHighlighted()}).on("click",function(b){if(a.model.color.isUserSelectable(f)){var c=d3.select(this),d=c.attr("id");a.colorPicker.colorOld(e[d]).colorDef(g[d]).callback(function(b){a.model.color.setColor(b,d)}).show(!0)}}),h.classed("vzb-hidden",!0)}else this.worldmapEl.classed("vzb-hidden",!0),h.classed("vzb-hidden",!1);h.each(function(b,c){if(d3.select(this).select(".vzb-cl-color-sample").style("background-color",e[b]).style("border","1px solid "+e[b]),"indicator"==a.model.color.use){var d=a.model.color.getScale().domain();d3.select(this).select(".vzb-cl-color-legend").text(a.model.color.tickFormatter(d[c]))}else d3.select(this).select(".vzb-cl-color-legend").text(a.translator("color/"+b))})}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=(b._globals,b.utils),d=b.iconset;if(b._require("d3")){var e=!0;b.Component.extend("gapminder-datawarning",{init:function(a,b){var d=this;this.model_expects=[{name:"language",type:"language"}],this.context=b,this.model_binds={"change:language":function(a){d.ready()}},this._super(a,b),this.ui=c.extend({},this.ui)},ready:function(){},readyOnce:function(){var a=this;this.element=d3.select(this.placeholder),this.translator=this.model.language.getTFunction(),this.element.selectAll("div").remove(),this.element.append("div").attr("class","vzb-data-warning-background").on("click",function(){a.toggle(!0)});var b=this.element.append("div").attr("class","vzb-data-warning-box");b.append("div").attr("class","vzb-data-warning-close").html("X").on("click",function(){a.toggle()});var c=b.append("div").attr("class","vzb-data-warning-link").html(d.warn);c.append("div").text("Data doubts"),this.parent.datawarning_content.title&&b.append("div").attr("class","vzb-data-warning-title").html(this.parent.datawarning_content.title),b.append("div").attr("class","vzb-data-warning-body").html(this.parent.datawarning_content.body)},toggle:function(a){null==a&&(a=!e),e=a,this.element.classed("vzb-hidden",e)}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b._require("d3")&&b.Component.extend("gapminder-draggablelist",{init:function(a,b){this.template='<span class="vzb-dl-holder"><ul class="vzb-draggable list"></ul></span>';var d=this;this.dataArrFn=a.dataArrFn,this.lang=a.lang,this.model_expects=[{name:"language",type:"language"}],this.model_binds={"change:axis":function(a){d.updateView()},"change:language":function(a){d.updateView()}},this._super(a,b),this.updateData=c.debounce(this.updateData,1e3)},ready:function(){var a=this;this.updateView(),this.element.selectAll("div").on("dragstart",function(){d3.select(this).style("opacity",.4),a.dragElem=this,d3.event.dataTransfer.setData("text/html",this.innerHTML),d3.event.dataTransfer.effectAllowed="move"}).on("dragover",function(){return d3.event.preventDefault&&d3.event.preventDefault(),d3.event.dataTransfer.dropEffect="move",!1}).on("dragenter",function(){return d3.select(this).select("li").classed("over",!0),!1}).on("dragleave",function(){d3.select(this).select("li").classed("over",!1)}).on("drop",function(){return d3.event.stopPropagation&&d3.event.stopPropagation(),a.dragElem&&(a.dragElem.innerHTML=this.innerHTML,this.innerHTML=d3.event.dataTransfer.getData("text/html")),!1}).on("dragend",function(){d3.select(this).style("opacity",""),a.element.selectAll("li").classed("over",!1),a.updateData()})},updateView:function(){var a=this;this.translator=this.model.language.getTFunction(),this.element.selectAll("li").remove(),this.data=this.element.selectAll("li").data(this.dataArrFn()),this.data.enter().insert("div").attr("draggable",!0).insert("li").each(function(b,c){d3.select(this).attr("data",b).text(a.translator(a.lang+b))})},updateData:function(){var a=[];this.element.selectAll("li").each(function(){a.push(d3.select(this).attr("data"))}),this.dataArrFn(a)},readyOnce:function(){this.element=d3.select(this.element).select(".list")}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b._globals,d=b.utils,e="which",f="min",g="max",h="scaleType";b._require("d3")&&b.Component.extend("gapminder-indicatorpicker",{init:function(a,b){this.template='<span class="vzb-ip-holder"><select class="vzb-ip-indicator"></select><select class="vzb-ip-scaletype"></select><br/><span class="vzb-ip-domainmin-label"></span> <input type="text" class="vzb-ip-domainmin" name="min"> <span class="vzb-ip-domainmax-label"></span> <input type="text" class="vzb-ip-domainmax" name="max">';var c=this;this.model_expects=[{name:"axis"},{name:"language",type:"language"}],this.model_binds={"change:axis":function(a){c.updateView()},"change:language":function(a){c.updateView()}},this._super(a,b),this.ui=d.extend({selectIndicator:!0,selectScaletype:!0,selectMinMax:!1},this.ui.getObject())},ready:function(){this.updateView()},afterPreload:function(){console.log("test")},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.el_select_indicator=this.element.select(".vzb-ip-indicator"),this.el_select_scaletype=this.element.select(".vzb-ip-scaletype"),this.el_domain_labelMin=this.element.select(".vzb-ip-domainmin-label"),this.el_domain_labelMax=this.element.select(".vzb-ip-domainmax-label"),this.el_domain_fieldMin=this.element.select(".vzb-ip-domainmin"),this.el_domain_fieldMax=this.element.select(".vzb-ip-domainmax"),this.el_select_indicator.on("change",function(){a._setModel(e,this.value)}),this.el_select_scaletype.on("change",function(){a._setModel(h,this.value)}),a.el_domain_fieldMin.on("change",function(){a._setModel(f,this.value)}),a.el_domain_fieldMax.on("change",function(){a._setModel(g,this.value)})},updateView:function(){var a=this;this.translator=this.model.language.getTFunction(),this.el_domain_labelMin.text(this.translator("min")+":"),this.el_domain_labelMax.text(this.translator("max")+":");var b=c.metadata.indicatorsDB,d=c.metadata.indicatorsArray,f="_default",g={};g[e]=d.filter(function(c){if(!a.model.axis.allow||!a.model.axis.allow.scales)return!0;if("*"==a.model.axis.allow.scales[0])return!0;for(var d=b[c].scales.length-1;d>=0;d--)if(a.model.axis.allow.scales.indexOf(b[c].scales[d])>-1)return!0;return!1}),g[e].indexOf(this.model.axis[e])>-1&&(f=this.model.axis[e]),g[h]=b[f].scales.filter(function(b){return a.model.axis.allow&&a.model.axis.allow.scales?"*"==a.model.axis.allow.scales[0]?!0:a.model.axis.allow.scales.indexOf(b)>-1:!0});var i=this.el_select_indicator.selectAll("option").data(g[e],function(a){return a}),j=this.el_select_scaletype.selectAll("option").data(g[h],function(a){return a});i.exit().remove(),j.exit().remove(),i.enter().append("option").attr("value",function(a){return a}),j.enter().append("option").attr("value",function(a){return a}),i.text(function(b){return a.translator("indicator/"+b)}),j.text(function(b){return a.translator("scaletype/"+b)}),this.el_select_indicator[0][0].value=this.model.axis[e],this.el_select_scaletype[0][0].value=this.model.axis[h],this.el_select_indicator.style("display",this.ui.selectIndicator?"auto":"none").attr("disabled",g[e].length<=1?"true":null),this.el_select_scaletype.style("display",0==g[h].length?"none":"inline").style("display",this.ui.selectScaletype?"auto":"none").attr("disabled",g[h].length<=1?"true":null),this.el_domain_labelMin.style("display",this.ui.selectMinMax?"auto":"none"),this.el_domain_labelMax.style("display",this.ui.selectMinMax?"auto":"none"),this.el_domain_fieldMin.style("display",this.ui.selectMinMax?"auto":"none"),this.el_domain_fieldMax.style("display",this.ui.selectMinMax?"auto":"none");var k=d3.format(".2r");this.el_domain_fieldMin.property("value",k(this.model.axis.getScale().domain()[0])),this.el_domain_fieldMax.property("value",k(this.model.axis.getScale().domain()[1]))},_setModel:function(a,b){var i=c.metadata.indicatorsDB;(a===f||a===g)&&(b=d.strToFloat(b));var j=this.model.axis,k={};k[a]=b,a==e&&(k.use=i[b].use,-1==i[b].scales.indexOf(j.scaleType)&&(k.scaleType=i[b].scales[0])),(a==e||a==h)&&"axis"==j.getType()&&(k.min=null,k.max=null),j.set(k)}})}.call(this),function(){"use strict";var a=this.Vizabi;a.utils;a._require("d3")&&a.Component.extend("gapminder-simplecheckbox",{init:function(a,b){this.template='<span class="vzb-sc-holder vzb-dialog-checkbox"><input type="checkbox"><label></label></span>';var c=this;this.checkbox=a.checkbox,this.submodel=a.submodel,this.model_expects=[{name:"mdl"},{name:"language",type:"language"}],this.model_binds={"change:mdl":function(a){c.updateView()},"change:language":function(a){c.updateView()}},this.model_binds["change:mdl:"+this.submodel+":"+this.checkbox]=function(){c.updateView()},this._super(a,b)},ready:function(){this.updateView()},readyOnce:function(){var a=this;this.element=d3.select(this.element);var b="-check-"+1e3*Math.random();this.labelEl=this.element.select("label").attr("for",b),this.checkEl=this.element.select("input").attr("id",b).on("change",function(){a._setModel(d3.select(this).property("checked"))})},updateView:function(){this.translator=this.model.language.getTFunction(),this.labelEl.text(this.translator("check/"+this.checkbox)),this.checkEl.property("checked",!!this.model.mdl[this.submodel][this.checkbox])},_setModel:function(a){this.model.mdl[this.submodel][this.checkbox]=a}})}.call(this),function(){var a=this.Vizabi,b=(a.utils,""),c=[],d='<?xml version="1.0" encoding="utf-8"?>';a.Helper.extend("gapminder-svgexport",{init:function(a){this.context=a,this.shapes=[],this.groups=[],this.counter=0,this.name="",this.label=""},reset:function(){this.container.remove(),this.context.element.selectAll(".vzb-export-redball").remove(),this.context.element.selectAll(".vzb-export-counter").remove(),this.counter=0},prefix:function(a){return arguments.length?(b=a,this):b},deleteClasses:function(a){return arguments.length?(c=a,this):c},open:function(a,d){var e=this;this.svg&&this.reset(),a||(a=this.context.element),d||(d=this.context.name),this.name=d;var f=parseInt(a.style("width"),10),g=parseInt(a.style("height"),10);this.container=a.append("div").attr("class","vzb-svg-export"),this.svg=this.container.node().appendChild(a.select("svg").node().cloneNode(!0)),this.svg=d3.select(this.svg),this.svg.attr("viewBox","0 0 "+f+" "+g).attr("version","1.1").attr("param1","http://www.w3.org/2000/svg").attr("param2","http://www.w3.org/1999/xlink").attr("x","0px").attr("y","0px").attr("style","enable-background:new 0 0 "+f+" "+g).attr("xml:space","preserve"),this.redBall=a.append("div").attr("class","vzb-export-redball").style("position","absolute").style("top","20px").style("right","20px").style("width","20px").style("height","20px").style("background","red").style("color","white").style("text-align","center").style("border-radius","10px").style("font-size","14px").style("line-height","20px").style("opacity",.8).style("cursor","pointer").on("mouseover",function(){d3.select(this).style("opacity",1).text("▼"),e.counterEl.text("Download")}).on("mouseout",function(){d3.select(this).style("opacity",.8).text(""),e.counterEl.text(e.label)}).on("click",function(){e.close()}),this.counterEl=a.append("div").attr("class","vzb-export-counter").style("position","absolute").style("top","20px").style("right","45px").style("color","red").style("opacity",.8).style("line-height","20px").style("font-size","14px").style("text-align","center"),this.root=this.svg.select("."+b+"graph"),this.root.selectAll("g, text, svg, line, rect").filter(function(){var a=d3.select(this),b=!1;return c.forEach(function(c){b=b||a.classed(c)}),b}).remove(),this.svg.selectAll(".tick line").attr("fill","none").attr("stroke","#999"),this.svg.selectAll("."+b+"axis-x path").attr("fill","none").attr("stroke","#999"),this.svg.selectAll("."+b+"axis-y path").attr("fill","none").attr("stroke","#999")},write:function(a){var b="time";if(this.root||this.open(),!(this.shapes.indexOf(a.id+"_"+a.time)>-1)){this.shapes.push(a.id+"_"+a.time),-1==this.groups.indexOf(a[b])&&(this.root.append("g").attr("id","g_"+a[b]),this.groups.push(a[b])),null==a.opacity&&(a.opacity=.5),null==a.fill&&(a.fill="#ff80dd");var c=this.root.select("#g_"+a[b]).append(a.type).attr("id",a.id+"_"+a.time).style("fill",a.fill).style("opacity",a.opacity);switch(a.type){case"path":c.attr("d",a.d);break;case"circle":c.attr("cx",a.cx).attr("cy",a.cy).attr("r",a.r)}this.counter++,this.redBall.style("opacity",this.counter%10/12+.2),this.label=a.type+" shapes: "+this.counter,this.counterEl.text(this.label)}},close:function(){var a=d+" "+this.container.node().innerHTML.replace("param1","xmlns").replace("param2","xmlns:xlink").replace(/\d+(\.\d+)/g,function(a){return Math.round(100*+a)/100+""});if(a.length/1024/1024>2)alert("The file size is "+Math.round(a.length/1024)+"kB, which is too large to download. Will try to print it in the console instead..."),console.log(a);else{var b=document.createElement("a");b.download=this.name+" "+this.counter+" shapes.svg",b.href="data:,"+a,b.click()}}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=(b.Promise,b.utils),d=3;if(b._require("d3")){var e="vzb-playing",f="vzb-ts-loading",g="vzb-ts-hide-play-button",h="vzb-ts-dragging",i="vzb-ts-axis-aligned",j="vzb-ts-show-value",k="vzb-ts-show-value-when-drag-play",l={year:"%Y",month:"%b",week:"week %U",day:"%d/%m/%Y",hour:"%d/%m/%Y %H",minute:"%d/%m/%Y %H:%M",second:"%d/%m/%Y %H:%M:%S"},m={small:{margin:{top:9,right:15,bottom:10,left:15},radius:8,label_spacing:10},medium:{margin:{top:9,right:15,bottom:10,left:15},radius:10,label_spacing:12},large:{margin:{top:9,right:15,bottom:10,left:15},radius:11,label_spacing:14}};b.Component.extend("gapminder-timeslider",{init:function(a,b){this.template=this.template||"src/components/_gapminder/timeslider/timeslider.html",this.model_expects=[{name:"time",type:"time"}];var d=this;this._splash=a.ui.splash,this.model_binds={"change:time":function(a,b){d._splash!==d.model.time.splash&&(d._splash=d.model.time.splash,d.readyOnce(),d.ready()),d._splash||(-1!==["change:time:start","change:time:end"].indexOf(a)&&d.changeLimits(),d._optionClasses(),d._dragging||d._setHandle(d.model.time.playing))}},this.ui=c.extend({show_limits:!1,show_value:!1,show_value_when_drag_play:!0,show_button:!0,class_axis_aligned:!1},a.ui,this.ui),this._super(a,b),this._dragging=!1,this.width=0,this.height=0,this.getValueWidth=c.memoize(this.getValueWidth),this._setTime=c.throttle(this._setTime,50)},readyOnce:function(){if(!this._splash){var a=this;this.element=d3.select(this.element),this.element.classed(f,!1),this.slider_outer=this.element.select(".vzb-ts-slider"),this.slider=this.slider_outer.select("g"),this.axis=this.element.select(".vzb-ts-slider-axis"),this.slide=this.element.select(".vzb-ts-slider-slide"),this.handle=this.slide.select(".vzb-ts-slider-handle"),this.valueText=this.slide.select(".vzb-ts-slider-value"),this.xScale=d3.time.scale().clamp(!0),this.xAxis=d3.svg.axis().orient("bottom").tickSize(0),this.valueText.attr("text-anchor","middle").attr("dy","-1em");var b=a._getBrushed(),c=a._getBrushedEnd();this.brush=d3.svg.brush().x(this.xScale).extent([0,0]).on("brush",function(){b.call(this)}).on("brushend",function(){c.call(this)}),this.slide.call(this.brush),this.slide.selectAll(".extent,.resize").remove(),this.parent.on("myEvent",function(b,c){var d=a.getLayoutProfile();c.profile&&c.profile.margin&&(m[d].margin=c.profile.margin),a.element.select(".vzb-ts-slider-wrapper").style("right",c.mRight-m[d].margin.right+"px"),a.xScale.range([0,c.rangeMax]),a.resize()})}},ready:function(){if(!this._splash){var a=this.element.select(".vzb-ts-btn-play"),b=this.element.select(".vzb-ts-btn-pause"),c=this,d=this.model.time;a.on("click",function(){c._dragging=!1,c.model.time.play()}),b.on("click",function(){c._dragging=!1,c.model.time.pause()});var e=d.formatOutput||l[d.unit];this.format=d3.time.format(e),this.changeLimits(),this.changeTime(),this.resize(),this._setHandle(this.model.time.playing)}},changeLimits:function(){var a=this.model.time.start,b=this.model.time.end;this.xScale.domain([a,b]),this.xAxis.tickValues([a,b]).tickFormat(this.format)},changeTime:function(){this.ui.format=this.model.time.unit;this.model.time.value;this._optionClasses()},resize:function(){this.model.time.pause(),this.profile=m[this.getLayoutProfile()];var a=parseInt(this.slider_outer.style("width"),10),b=parseInt(this.slider_outer.style("height"),10);this.width=a-this.profile.margin.left-this.profile.margin.right,this.height=b-this.profile.margin.bottom-this.profile.margin.top;var c=this;this.slider.attr("transform","translate("+this.profile.margin.left+","+this.profile.margin.top+")"),(this.xScale.range()[1]=1)&&this.xScale.range([0,this.width]),this.xAxis=this.xAxis.scale(this.xScale).tickPadding(this.profile.label_spacing),this.axis.attr("transform","translate(0,"+this.height/2+")").call(this.xAxis),this.slide.select(".background").attr("height",this.height),this.handle.attr("transform","translate(0,"+this.height/2+")").attr("r",this.profile.radius),this.sliderWidth=c.slider.node().getBoundingClientRect().width,this._setHandle()},getValueWidth:function(a,b){return this.valueText.node().getBoundingClientRect().width},_getBrushed:function(){var a=this;return function(){a.model.time.pause(),a._blockUpdate||(a._optionClasses(),a._blockUpdate=!0,a.element.classed(h,!0));var b=a.brush.extent()[0];if(d3.event.sourceEvent){a._dragging=!0,a.model.time.dragStart();var e=c.roundStep(Math.round(d3.mouse(this)[0]),d);b=a.xScale.invert(e);var f=a.getLayoutProfile(),g=a.getValueWidth(f,b),i=a.sliderWidth-g/2;e>i?e=i:0>e&&(e=0),a.handle.attr("cx",e),a.valueText.attr("transform","translate("+e+","+a.height/2+")"),a.valueText.text(a.format(b))}b-a.model.time.value!==0&&a._setTime(b)}},_getBrushedEnd:function(){var a=this;return function(){a._dragging=!1,a.model.time.dragStop(),a._blockUpdate=!1,a.element.classed(h,!1),a.model.time.pause(),a.model.time.snap()}},_setHandle:function(a){var b=this.model.time.value;this.slide.call(this.brush.extent([b,b])),this.valueText.text(this.format(b));var c=this.handle.attr("cx"),d=this.xScale(b);null==c&&(c=d);var e=d>c?this.model.time.speed:0;a?this.handle.attr("cx",c).transition().duration(e).ease("linear").attr("cx",d):(this.handle.transition().duration(0).attr("cx",d),d3.timer.flush()),this.valueText.attr("transform","translate("+c+","+this.height/2+")").transition().duration(e).ease("linear").attr("transform","translate("+d+","+this.height/2+")")},_setTime:function(a){var b=this;b.model.time.value=a},_optionClasses:function(){var a=this.ui.show_limits,b=this.ui.show_value,c=this.ui.show_value_when_drag_play,d=this.ui.axis_aligned,f=this.ui.show_button&&this.model.time.playable;a||this.xAxis.tickValues([]).ticks(0),this.element.classed(g,!f),this.element.classed(e,this.model.time.playing),this.element.classed(j,b),this.element.classed(k,c),this.element.classed(i,d)}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b._globals,d=b.utils;if(b._require("d3")){var e,f,g,h,i={wrapper:"vzb-treemenu-wrap",search:"vzb-treemenu-search",list:"vzb-treemenu-list",list_item:"vzb-treemenu-list_item",hasChild:"vzb-treemenu-list_item--children",list_item_label:"vzb-treemenu-list_item_label",list_top_level:"vzb-treemenu-list_top",search_wrap:"vzb-treemenu-search_wrap",isSpecial:"vzb-treemenu-list_item--special",hidden:"vzb-hidden",title:"vzb-treemenu-title"},j={MENU_ID:"menu-"+this._id,MOUSE_LOCS:[],MOUSE_LOCS_TRACKED:3,DELAY:200,TOLERANCE:150,LAST_DELAY_LOC:null,TIMEOUT:null,SEARCH_PROPERTY:"id",SUBMENUS:"children",SEARCH_MIN_STR:2,CONTAINER_DIMENSIONS:{},RESIZE_TIMEOUT:null,MOBILE_BREAKPOINT:400,CURRENT_PATH:[],CURRENT_PROFILE:null,MIN_COL_WIDTH:50},k=[{col_width:300,min:1280},{col_width:250,min:1024},{col_width:200,min:j.MOBILE_BREAKPOINT}],l=function(a){console.log("Indicator selector: stub callback fired. New indicator is ",a)};b.Component.extend("gapminder-treemenu",{tree:function(a){return arguments.length?(e=a,this):e},lang:function(a){return arguments.length?(g=a,this):g},langStrings:function(a){return arguments.length?(f=a,this):f},callback:function(a){return arguments.length?(l=a,this):l},markerID:function(a){return arguments.length?(h=a,this):h},init:function(a,b){var c=this;this.model_expects=[{name:"marker"},{name:"language",type:"language"}],this.context=b,this.model_binds={"change:axis":function(a){c.updateView()},"change:language":function(a){c.updateView()}},this._super(a,b),this.ui=d.extend({},this.ui)},ready:function(){this.updateView()},readyOnce:function(){this.element=d3.select(this.placeholder);var a=this,b=this.element.append("div").classed(i.wrapper,!0).attr("id",j.MENU_ID);b.append("div").classed(i.title,!0).append("span"),b.append("div").classed(i.search_wrap,!0).append("input").classed(i.search,!0).attr("placeholder","Search...").attr("type","text").attr("id",i.search+"_"+j.MENU_ID),d3.select("body").on("mousemove",a._mousemoveDocument).select("#"+j.MENU_ID).on("mouseleave",function(){a._closeAllSub(this)}),a._enableSearch(),a._watchContainerSize()},toggle:function(){var a=d3.select("#"+j.MENU_ID),b=this.element.classed(i.hidden);this.element.classed(i.hidden,!b),b||a.selectAll("."+i.list_item).filter(".marquee").each(function(){_this._marqueeToggle(this,!1)})},_closeAllSub:function(a){a=d3.select(a),a.selectAll(".active").classed("active",!1),a.selectAll(".marquee").classed("marquee",!1),this._resizeDropdown()},_mousemoveDocument:function(){var a=d3.mouse(this);j.MOUSE_LOCS.push({x:a[0],y:a[1]}),j.MOUSE_LOCS.length>j.MOUSE_LOCS_TRACKED&&j.MOUSE_LOCS.shift()},_activationDelay:function(a){function b(a,b){return(b.y-a.y)/(b.x-a.x)}var c=d3.select(a).node(),d=c.parentNode;if(0==c.getElementsByClassName("active").length)return 0;var e={x:c.offsetLeft+d.offsetLeft,y:c.offsetTop+d.offsetTop-j.TOLERANCE},f={x:c.offsetLeft+d.offsetLeft+c.offsetWidth,y:e.y},g={x:c.offsetLeft+d.offsetLeft,y:c.offsetTop+d.offsetTop+c.offsetHeight+j.TOLERANCE},h={x:c.offsetLeft+d.offsetLeft+c.offsetWidth,y:g.y},i=j.MOUSE_LOCS[j.MOUSE_LOCS.length-1],k=j.MOUSE_LOCS[0];if(!i)return 0;if(k||(k=i),k.x<c.offsetLeft||k.y<c.offsetTop||k.y>h.y)return 0;if(j.LAST_DELAY_LOC&&i.x==j.LAST_DELAY_LOC.x&&i.y==j.LAST_DELAY_LOC.y)return 0;var l=f,m=h,n=b(i,l),o=b(i,m),p=b(k,l),q=b(k,m);return p>n&&o>q?(j.LAST_DELAY_LOC=i,j.DELAY):(j.LAST_DELAY_LOC=null,0)},_watchContainerSize:function(){var a=this;j.CONTAINER_DIMENSIONS={height:a.element.node().offsetHeight,width:a.element.node().offsetWidth};var b=function(b){for(var c=0;c<k.length;c++){if(k[c].min<b&&0==c||k[c].min<b&&0!=c&&b<a.resizeProfiles[c-1].min){j.CURRENT_PROFILE=k[c],j.IS_MOBILE=!1;break}b<=j.MOBILE_BREAKPOINT&&(j.CURRENT_PROFILE=null,j.IS_MOBILE=!0)}j.IS_MOBILE?(d3.select("#"+j.MENU_ID).classed("mobile",!0),a.element.selectAll("*").each(function(){d3.select(this).attr("style","")})):d3.select("#"+j.MENU_ID).classed("mobile",!1)};setTimeout(function(){var c=(a.element,a.element.node().offsetWidth),d=a.element.node().offsetHeight;(c!==j.CONTAINER_DIMENSIONS.width||d!==j.CONTAINER_DIMENSIONS.height)&&(j.CONTAINER_DIMENSIONS.width=c,j.CONTAINER_DIMENSIONS.height=d),b(j.CONTAINER_DIMENSIONS.width),a._watchContainerSize()},500)},_enableSearch:function(){var a=this,b=d3.select("#"+i.search+"_"+j.MENU_ID),c=function(b){var c=[],d=function(b,c,d){if(a.langStrings())for(var e in a.langStrings())for(var f in a.langStrings()[e])if(a.langStrings()[e][f].toLowerCase().indexOf(b.toLowerCase())>=0)return f},f=function(a){for(var e=0;e<a.length;e++){var g=!1;g=g||a[e][j.SEARCH_PROPERTY].toLowerCase().indexOf(b.toLowerCase())>=0||a[e][j.SEARCH_PROPERTY]==d(b,a,e),g&&c.push(a[e]),a[e][j.SUBMENUS]&&f(a[e][j.SUBMENUS])}};return f(e),c},d=function(){var d=b.node().value;d.length>=j.SEARCH_MIN_STR?a.redraw(c(d)):a.redraw()};b.on("keyup",d)},_marqueeToggle:function(a,b){var c=d3.select(a),d=c.select("."+i.list_item_label);b?d.node().scrollWidth>a.offsetWidth&&c.classed("marquee",!0):c.classed("marquee",!1)},_resizeDropdown:function(){var a=this;if(!j.IS_MOBILE){var b=[];b.push(d3.select("#"+j.MENU_ID).node()),a.element.selectAll("."+i.list+".active").each(function(){b.push(this)});var c=Math.floor(j.CONTAINER_DIMENSIONS.width/j.CURRENT_PROFILE.col_width),d=j.CONTAINER_DIMENSIONS.width-c*j.CURRENT_PROFILE.col_width;d<j.MIN_COL_WIDTH&&(c-=1,d+=j.CURRENT_PROFILE.col_width);for(var e=b.length-1;e>=0;e--){var f=d3.select(b[e]);c>0?(f.transition().duration(200).style("width",j.CURRENT_PROFILE.col_width),c--):d>j.MIN_COL_WIDTH?(f.transition().duration(200).style("width",d/(e+1)),d-=d/(e+1)):(f.transition().duration(200).style("width",d),d=0)}j.CURRENT_PATH=b}},_toggleSub:function(a){var b=this,c=a.node().parentNode,d=function(g,h){if(j.IS_MOBILE&&"click"==g.type)return f(c),void(a.classed("active")||e(h));if(!j.IS_MOBILE&&"mouseenter"==g.type){var i=b._activationDelay(c);i?j.TIMEOUT=setTimeout(function(){d(g,h)},i):(e(h),f(c))}},e=function(a){d3.select(a).select("."+i.list).classed("active",!0),b._marqueeToggle(a,!0)},f=function(a){var c=d3.select(a).selectAll("."+i.list_item+":not(:hover)");c.each(function(){d3.select(this).selectAll("."+i.list).each(function(){d3.select(this).classed("active",!1)})}),c.filter(".marquee").each(function(){b._marqueeToggle(this,!1)}),b._resizeDropdown()},g=function(){if(!j.IS_MOBILE){var a=d3.select(c);a.classed("active",!1).attr("style","")}};d3.select(c).select("."+i.list_item).node().addEventListener("mouseleave",g,!1),a.node().addEventListener("mouseenter",function(){d(event,this)},!1),a.node().addEventListener("click",function(){d(event,this)},!1)},_selectIndicator:function(a){var b=d3.select(a).data()[0];b.children||(l(b.id,h),this.toggle())},redraw:function(a){var b=this;this.element.select("."+i.title).select("span").text(this.translator("buttons/"+h)),null==a&&(a=e),this.element.select("#"+j.MENU_ID).select("."+i.list_top_level).remove();var d=this.element.select("#"+j.MENU_ID).append("ul").classed(i.list_top_level,!0),f=c.metadata.indicatorsDB,g=function(a){return a.filter(function(a){return a.children||c.metadata.indicatorsArray.indexOf(a.id)>-1}).filter(function(a){if(!b.model.marker[h].allow||!b.model.marker[h].allow.scales)return!0;if("*"==b.model.marker[h].allow.scales[0])return!0;if(a.children)return!0;for(var c=f[a.id].scales.length-1;c>=0;c--)if(b.model.marker[h].allow.scales.indexOf(f[a.id].scales[c])>-1)return!0;return!1})},k=d.selectAll("li").data(g(a),function(a){return a.id});return k.exit().remove(),k.enter().append("li"),k.append("span").classed(i.list_item_label,!0).text(function(a){return b.translator("indicator/"+a.id)}).on("click",function(){b._selectIndicator(this)}),k.classed(i.list_item,!0).classed(i.hasChild,function(a){return a.children}).classed(i.isSpecial,function(a){return a.special}).each(function(a){var c=d3.select(this);b._toggleSub(c);var d=function(a,c){if(null!=c){var e=a.append("ul").classed(i.list,!0).selectAll("li").data(g(c),function(a){return a.id}).enter().append("li");e.append("span").classed(i.list_item_label,!0).text(function(a){return b.translator("indicator/"+a.id)}).on("click",function(){b._selectIndicator(this)}),e.classed(i.list_item,!0).classed(i.hasChild,function(a){return a.children}).classed(i.isSpecial,function(a){return a.special}).each(function(a){b._toggleSub(d3.select(this)),d(d3.select(this),a.children)})}};d(c,a.children)}),this},updateView:function(){var a=this,b=a.model.language.id;if(h){var d=f?f:{};d[b]=a.model.language.strings[b],this.translator=this.model.language.getTFunction();var e=this._setModel.bind(this);return this.langStrings(d).lang(b).callback(e).tree(c.metadata.indicatorsTree).redraw(),this}},_setModel:function(a,b){var d=c.metadata.indicatorsDB,e=this.model.marker[b],f={};f.which=a,f.use=d[a].use,f.scaleType=d[a].scales[0],"axis"==e.getType()&&(f.min=null,f.max=null),e.set(f)}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;if(b._require("d3")){({year:d3.time.format("%Y"),month:d3.time.format("%Y-%m"),week:d3.time.format("%Y-W%W"),day:d3.time.format("%Y-%m-%d"),hour:d3.time.format("%Y-%m-%d %H"),minute:d3.time.format("%Y-%m-%d %H:%M"),second:d3.time.format("%Y-%m-%d %H:%M:%S")});b.Model.extend("axis",{init:function(a,b,d){this._type="axis",a=c.extend({use:"value",which:void 0,min:null,max:null},a),this._super(a,b,d)},validate:function(){var a=["log","genericLog","linear","time","pow"];(!this.scaleType||"indicator"===this.use&&-1===a.indexOf(this.scaleType))&&(this.scaleType="linear"),"indicator"!==this.use&&"ordinal"!==this.scaleType&&(this.scaleType="ordinal"),(this.which_1!=this.which||this.scaleType_1!=this.scaleType)&&(this.scale=null),this.which_1=this.which,this.scaleType_1=this.scaleType,this.scale&&this._readyOnce&&"indicator"==this.use&&(null==this.min&&(this.min=this.scale.domain()[0]),null==this.max&&(this.max=this.scale.domain()[1]),this.min<=0&&"log"==this.scaleType&&(this.min=.01),this.max<=0&&"log"==this.scaleType&&(this.max=10),(this.min!=this.scale.domain()[0]||this.max!=this.scale.domain()[1])&&this.scale.domain([this.min,this.max]))},buildScale:function(a){var b,c=this.scaleType||"linear";if(void 0===a&&(a=!0),"boolean"==typeof a){var d=a;a={},a.min=d,a.max=d}if("time"==this.scaleType){var e=this.getLimits(this.which);return void(this.scale=d3.time.scale().domain([e.min,e.max]))}switch(this.use){case"indicator":var e=this.getLimits(this.which),f=(e.max-e.min)/20;b=[e.min-(a.min&&f?f:0),e.max+(a.max&&f?f:0)],"log"==c&&(b=[e.min-e.min/4,e.max+e.max/4]);break;case"property":b=this.getUnique(this.which);break;case"value":default:b=[this.which]}null!=this.min&&null!=this.max&&"ordinal"!==c&&(b=[this.min,this.max],this.min=b[0],this.max=b[1]),this.scale=d3.scale[c]().domain(b)}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b._globals;b._require("d3")&&b.Model.extend("color",{init:function(a,b,d){this._type="color",a=c.extend({use:"value",palette:null,which:void 0},a),this._original_palette=a.palette,this._super(a,b,d),this._firstLoad=!0,this._hasDefaultColor=!1},getPalettes:function(){var a=d.metadata?d.metadata.color.palettes:{_continuous:{0:"#F77481",1:"#E1CE00",2:"#B4DE79"},_discrete:{0:"#1f77b4",1:"#aec7e8",3:"#ff7f0e",4:"#2ca02c",5:"#98df8a",6:"#ffbb78",7:"#d62728",8:"#ff9896",9:"#9467bd",10:"#c5b0d5"},_default:{_default:"#fa5ed6"}};return a},afterPreload:function(){this._resetPalette=!0,this._super()},isUserSelectable:function(a){var b=d.metadata?d.metadata.color.selectable:{};return null==b[a]?!0:b[a]},validate:function(){var a=this.getPalettes(),b=["log","genericLog","linear","time","pow"];(!this.scaleType||"indicator"===this.use&&-1===b.indexOf(this.scaleType))&&(this.scaleType="linear"),"indicator"!==this.use&&"ordinal"!==this.scaleType&&(this.scaleType="ordinal"),(null==this.palette||this._firstLoad===!1&&this.which_1!=this.which||this._firstLoad===!1&&this.scaleType_1!=this.scaleType||this._resetPalette)&&(this.set("palette",this._original_palette,!1),this.scale=null,a[this.which]?this.palette=c.clone(a[this.which]):"value"===this.use?this.palette={_default:this.which}:"indicator"===this.use?this.palette=c.clone(a._continuous):"property"===this.use?this.palette=c.clone(a._discrete):this.palette=c.clone(a._default),this._resetPalette=!1),this.which_1=this.which,this.scaleType_1=this.scaleType,this._firstLoad=!1},setColor:function(a,b){var d=this.palette.getObject();d[b]=a,this.scale.range(c.values(d)),this.palette[b]=a},mapValue:function(a){return null!=this.scale&&"property"==this.use&&this._hasDefaultColor&&-1==this.scale.domain().indexOf(a)&&(a="_default"),
this._super(a)},buildScale:function(){var a=this,b=Object.keys(a.palette.getObject()),d=c.values(a.palette.getObject());if(this._hasDefaultColor=b.indexOf("_default")>-1,"time"==this.scaleType){var e=this.getLimits(this.which),f=(e.max.valueOf()-e.min.valueOf())/(d.length-1);return b=d3.range(e.min.valueOf(),e.max.valueOf(),f).concat(e.max.valueOf()),void(this.scale=d3.time.scale().domain(b).range(d).interpolate(d3.interpolateRgb))}switch(this.use){case"indicator":var e=this.getLimits(this.which),f=(e.max-e.min)/(d.length-1);if(b=d3.range(e.min,e.max,f).concat(e.max),b=b.reverse(),"log"==this.scaleType){var g=d3.scale.log().domain([0===e.min?1:e.min,e.max]).range([e.min,e.max]);b=b.map(function(a){return g.invert(a)})}return void(this.scale=d3.scale[this.scaleType]().domain(b).range(d).interpolate(d3.interpolateRgb));default:return void(this.scale=d3.scale.ordinal().domain(b).range(d))}}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b.Model.extend("data",{init:function(a,b,d){this._type="data",a=c.extend({reader:"csv-file",splash:!1},a),this._super(a,b,d)}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b.Model.extend("entities",{init:function(a,b,d){this._type="entities",a=c.extend({show:{},select:[],highlight:[],opacitySelectDim:.3,opacityRegular:1,needUpdate:{}},a),this._visible=[],this._multiple=!0,this._super(a,b,d)},validate:function(a){var b=this.getDimension(),c=this._visible.map(function(a){return a[b]});c.length&&(this.select=this.select.filter(function(a){return-1!==c.indexOf(a[b])}),this.highlight=this.highlight.filter(function(a){return-1!==c.indexOf(a[b])}))},setVisible:function(a){this._visible=a},getVisible:function(a){return this._visible},selectMultiple:function(a){this._multiple=a},getDimension:function(){return this.dim},getFilter:function(){return this.show.getObject()},getSelected:function(){var a=this.getDimension();return this.select.map(function(b){return b[a]})},selectEntity:function(a,b,c){var d=this.getDimension(),e=a[d];if(this.isSelected(a))this.select=this.select.filter(function(a){return a[d]!==e});else{var f={};f[d]=e,f.labelOffset=[0,0],b&&c&&(f.trailStartTime=c(a[b])),this.select=this._multiple?this.select.concat(f):[f]}},setLabelOffset:function(a,b){var d=this.getDimension(),e=a[d];c.find(this.select,function(a){return a[d]===e}).labelOffset=b,this.set("select",this.select,!0)},isSelected:function(a){var b=this.getDimension(),c=a[this.getDimension()],d=this.select.map(function(a){return a[b]});return-1!==d.indexOf(c)},clearSelected:function(){this.select=[]},setHighlighted:function(a){this.highlight=[].concat(a)},highlightEntity:function(a,b,d){var e=this.getDimension(),f=a[e];if(!this.isHighlighted(a)){var g={};g[e]=f,g=c.extend(a,g),b&&d&&(g.trailStartTime=d(a[b])),this.highlight=this.highlight.concat(g)}},unhighlightEntity:function(a){var b=this.getDimension(),c=a[b];this.isHighlighted(a)&&(this.highlight=this.highlight.filter(function(a){return a[b]!==c}))},isHighlighted:function(a){var b=this.getDimension(),c=a[this.getDimension()],d=this.highlight.map(function(a){return a[b]});return-1!==d.indexOf(c)},clearHighlighted:function(){this.highlight=[]},setNeedUpdate:function(){this.needUpdate=new Date}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b._require("d3")&&b.Model.extend("group",{init:function(a,b,d){this._type="model",a=c.extend({use:"property",which:void 0,merge:!1,manualSorting:null},a),this._super(a,b,d)},validate:function(){this.scale&&(this.scale=null),"property"!=this.use&&(c.warn("group model: use must not be 'property'. Resetting..."),this.use="property")},buildScale:function(){}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b.Model.extend("language",{init:function(a,b,d){this._type="language",a=c.extend({id:"en",strings:{}},a),this._super(a,b,d)},getUIString:function(a,b,c){return b=b||this.id,c=c||this.strings,c&&c.hasOwnProperty(b)&&c[b].hasOwnProperty(a)?c[b][a]:a},getTFunction:function(){var a=this.id,b=this.strings,c=this;return function(d){return c.getUIString(d,a,b)}}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b._require("d3")&&b.Model.extend("size",{init:function(a,b,d){this._type="size",a=c.extend({use:"value",min:0,max:1,which:void 0},a),this._super(a,b,d)},validate:function(){("undefined"==typeof this.min||this.min<0)&&(this.min=0),("undefined"==typeof this.max||this.max>1)&&(this.max=1),this.max<this.min&&this.set("min",this.max,!0),"value"===this.use&&this.which>this.max?this.which=this.max:"value"===this.use&&this.which<this.min&&(this.which=this.min),this.scaleType||(this.scaleType="linear"),"property"===this.use&&(this.scaleType="ordinal"),(this.which_1!=this.which||this.scaleType_1!=this.scaleType)&&(this.scale=null),this.which_1=this.which,this.scaleType_1=this.scaleType},buildScale:function(){"value"===this.use&&(this.scale=d3.scale.linear().domain([0,1])),this._super()}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;if(b._require("d3")){var d={ALL:"all",_default:"none"};b.Model.extend("stack",{init:function(a,b,d){this._type="model",a=c.extend({use:"value",which:void 0,merge:!1},a),this._super(a,b,d)},validate:function(){this.scale&&(this.scale=null),"indicator"===this.use&&(c.warn("stack model: use must not be 'indicator'. Resetting use to 'value' and which to '"+d._default),this.use="value",this.which=d._default),"value"===this.use&&-1==c.values(d).indexOf(this.which)&&(c.warn("stack model: the requested value '"+this.which+"' is not allowed. resetting to '"+d._default),this.which==d._default)},getPalettes:function(){return d},buildScale:function(){}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;if(b._require("d3")){var d={year:"%Y",month:"%Y-%m",week:"%Y-W%W",day:"%Y-%m-%d",hour:"%Y-%m-%d %H",minute:"%Y-%m-%d %H:%M",second:"%Y-%m-%d %H:%M:%S"},e=Object.keys(d),f=c.values(d);b.Model.extend("time",{init:function(a,b,d){this._type="time",a=c.extend({dim:"time",value:"1800",start:"1800",end:"2014",playable:!0,playing:!1,loop:!1,round:"floor",speed:300,unit:"year",step:1,adaptMinMaxZoom:!1,formatInput:"%Y",xLogStops:[],yMaxMethod:"latest",record:!1,dragging:!1,povertyline:0,povertyCutoff:0,povertyFade:1,gdpFactor:1,gdpShift:0,xPoints:50},a),a.formatOutput=a.formatOutput||a.formatInput,this._super(a,b,d);var e=this;this._playing_now=!1,this.on({"change:playing":function(){e.playing===!0?e._startPlaying():e._stopPlaying()},set:function(){e.playing===!0&&e.set("playing",!0,!0),this.snap("start"),this.snap("end"),this.snap("value")}})},_formatToDates:function(){for(var a=["value","start","end"],b=[this.formatInput].concat(f),d=0;d<a.length;d++){var e=a[d];if(!c.isDate(this[e]))for(var g=0;g<b.length;g++){var h=d3.time.format(b[g]),i=h.parse(this[e].toString());if(c.isDate(i)){this.set(e,i);break}}}},validate:function(){-1===e.indexOf(this.unit)&&(this.unit="year"),this.step<1&&(this.step="year"),c.isDate(this.start)&&c.isDate(this.end)&&c.isDate(this.value)||this._formatToDates(),this.end<this.start&&(this.end=this.start),this.value<this.start?this.value=this.start:this.value>this.end&&(this.value=this.end),this.playable===!1&&this.playing===!0&&(this.playing=!1)},play:function(){this.playing=!0},pause:function(){this.playing=!1},dragStart:function(){this.dragging=!0},dragStop:function(){this.dragging=!1},getRange:function(){return d3.time[this.unit].range(this.start,this.end,this.step)},getFilter:function(a){var b=d3.time.format(this.formatInput||"%Y")(this.start),c=d3.time.format(this.formatInput||"%Y")(this.end),d=d3.time.format(this.formatInput||"%Y")(this.value),e=this.getDimension(),f={};return f[e]=a?[[d]]:[[b,c]],f},getFormatter:function(){var a=d3.time.format(this.formatInput||"%Y");return function(b){return a.parse(b)}},getAllSteps:function(){for(var a=[],b=this.start;b<=this.end;)a.push(b),b=d3.time[this.unit].offset(b,this.step);return a},snap:function(a){if(this.round){null==a&&(a="value");var b="round";"ceil"===this.round&&(b="ceil"),"floor"===this.round&&(b="floor");var c=d3.time[this.unit][b](this[a]);this.set(a,c,!0)}},_startPlaying:function(){if(this.playable&&!this._playing_now){this._playing_now=!0;var a=this,b=this.value,c=this.speed;this.snap(),a.end-b<=0&&(b=this.start,a.value=b),this._intervals.setInterval("playInterval_"+this._id,function(){return b>=a.end?void(a.loop?(b=a.start,a.value=b):a.playing=!1):(b=d3.time[a.unit].offset(b,a.step),void(a.value=b))},c),this.trigger("play")}},_stopPlaying:function(){this._playing_now=!1,this._intervals.clearInterval("playInterval_"+this._id),this.snap(),this.trigger("pause")}})}}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b.Promise,e={},f={};b.Reader.extend("csv-file",{init:function(a){this._name="csv-file",this._data=[],this._basepath=a.path,this._formatters=a.formatters,this._basepath||c.error("Missing base path for csv-file reader")},read:function(a,b){var g=this,h=new d,i=this._basepath.replace("{{LANGUAGE}}",b);return 1===a.where.time[0].length&&(i=i.replace(".csv","-"+a.where.time[0][0]+".csv")),i=i.replace(/{{(.*?)}}/g,function(b,d){return d=d.toLowerCase(),c.isArray(a.where[d])?a.where[d].sort().join("-"):a.where[d]}),g._data=[],function(a,b){function h(a){a=a.map(function(a){return a["geo.cat"]=[a["geo.cat"]],a["geo.region"]=a["geo.region"]||a.geo,a}),a=c.mapRows(a,g._formatters);var b=Object.keys(g._formatters),d=b[0];return a.sort(function(a,b){return a[d]-b[d]}),a}function j(d){var e=d,f=a.where;f["geo.category"]&&(f["geo.cat"]=c.clone(f["geo.category"]),f["geo.category"]=void 0),f=c.mapRows([f],g._formatters)[0];var h=[];c.forEach(f,function(a,b){for(var c=0,d=e.length;d>c;c++)if(e[c].hasOwnProperty(b))return h.push(b),!0}),f=c.clone(f,h),e=c.filterAny(e,f),0==e.length&&c.warn("data reader returns empty array, that's bad"),e=e.map(function(b){return c.clone(b,a.select)}),g._data=e,b.resolve()}e.hasOwnProperty(i)?j(e[i]):f.hasOwnProperty(i)?f[i].then(function(){j(e[i])}):(d3.csv(i,function(a,b){return b?a?void c.error("Error Happened While Loading CSV File: "+i,a):(b=h(b),e[i]=b,f[i].resolve(),f[i]=void 0,void j(b)):void c.error("No permissions or empty file: "+i,a)}),f[i]=new d)}(a,h),h},getData:function(){return this._data}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.Reader.extend("inline",{init:function(a){this.name="inline",this._super(a)}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=b.Promise,e={},f={};b.Reader.extend("json-file",{init:function(a){this._name="json-file",this._data=[],this._basepath=a.path,this._formatters=a.formatters,this._basepath||c.error("Missing base path for json-file reader")},read:function(a,b){var g=this,h=new d,i=this._basepath.replace("{{LANGUAGE}}",b);return g._data=[],function(a,b){function h(a){a=a[0].map(function(a){return a["geo.cat"]=[a["geo.cat"]],a["geo.region"]=a["geo.region"]||a.geo,a}),a=c.mapRows(a,g._formatters);var b=Object.keys(g._formatters),d=b[0];return a.sort(function(a,b){return a[d]-b[d]}),a}function j(d){var e=d,f=a.where;f["geo.category"]&&(f["geo.cat"]=c.clone(f["geo.category"]),f["geo.category"]=void 0),f=c.mapRows([f],g._formatters)[0];var h=[];c.forEach(f,function(a,b){for(var c=0,d=e.length;d>c;c++)if(e[c].hasOwnProperty(b))return h.push(b),!0}),f=c.clone(f,h),e=c.filterAny(e,f),0==e.length&&c.warn("data reader returns empty array, that's bad"),e=e.map(function(b){return c.clone(b,a.select)}),g._data=e,b.resolve()}e.hasOwnProperty(i)?j(e[i]):f.hasOwnProperty(i)?f[i].then(function(){j(e[i])}):(d3.json(i,function(a,b){return b?a?void c.error("Error Happened While Loading JSON File: "+i,a):(b=h(b),e[i]=b,f[i].resolve(),f[i]=void 0,void j(b)):void c.error("No permissions or empty file: "+i,a)}),f[i]=new d)}(a,h),h},getData:function(){return this._data}})}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils,c=a.Promise;a.Reader.extend("waffle-server",{basepath:"",init:function(a){this._name="waffle-reader",this._data=[],this._formatters=a.formatters,this._basepath=a.path||this.basepath,this._basepath||b.error("Missing base path for waffle-server reader")},read:function(a,d){var e,f=this,g=new c;return this._data=[],function(a,c){function g(a){a=a.map(function(a){return a["geo.cat"]=[a["geo.cat"]],a["geo.region"]=a["geo.region"]||a.geo,a}),a=b.mapRows(a,f._formatters);var c=Object.keys(f._formatters),d=c[0];return a.sort(function(a,b){return a[d]-b[d]}),a}function h(a){0==a.length&&b.warn("data reader returns empty array, that's bad"),f._data=a,c.resolve()}var i=a.where;i.time&&(i.time=i.time[0].join("-")),i["geo.category"]&&(i["geo.cat"]=b.clone(i["geo.category"]),i["geo.category"]=void 0),e={SELECT:a.select,WHERE:i,FROM:"spreedsheet"};var j={query:[e],lang:d};b.post(f._basepath,JSON.stringify(j),function(a){a=g(a[0]),h(a)},function(){console.log("Error loading from Waffle Server:",f._basepath),c.reject("Could not read from waffle server")},!0)}(a,g),g},getData:function(){return this._data}})}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils;if(a._require("d3")){var c="src/tools/barchart/barchart.html";a.Component.extend("gapminder-barchart",{init:function(a,d){this.name="barchart",this.template=c,this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}];var e=this;this.model_binds={"change:time:value":function(a){e.updateEntities()},"change:marker:color:palette":b.debounce(function(a){e.updateEntities()},200)},this._super(a,d),this.xScale=null,this.yScale=null,this.cScale=d3.scale.category10(),this.xAxis=d3.svg.axisSmart(),this.yAxis=d3.svg.axisSmart()},readyOnce:function(){this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisEl=this.graph.select(".vzb-bc-axis-y"),this.xAxisEl=this.graph.select(".vzb-bc-axis-x"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.bars=this.graph.select(".vzb-bc-bars");var a=this;this.on("resize",function(){a.updateEntities()})},ready:function(){this.updateIndicators(),this.resize(),this.updateEntities()},updateIndicators:function(){var a=this;this.translator=this.model.language.getTFunction(),this.duration=this.model.time.speed;var b=this.translator("indicator/"+this.model.marker.axis_y.which),c=this.translator("indicator/"+this.model.marker.axis_x.which),d=this.yTitleEl.selectAll("text").data([0]);d.enter().append("text"),d.attr("y","-6px").attr("x","-9px").attr("dx","-0.72em").text(b).on("click",function(){a.parent.findChildByName("gapminder-treemenu").markerID("axis_y").updateView().toggle()});var e=this.xTitleEl.selectAll("text").data([0]);e.enter().append("text"),e.attr("y","-3px").attr("dx","-0.72em").text(c).on("click",function(){a.parent.findChildByName("gapminder-treemenu").markerID("axis_x").updateView().toggle()}),this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.yAxis.tickFormat(a.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(a.model.marker.axis_x.tickFormatter)},updateEntities:function(){var a=this,b=this.model.time,c=b.getDimension(),d=this.model.entities.getDimension(),e=b.playing?b.speed:0,f={};f[c]=b.value;var g=this.model.marker.getKeys(f),h=this.model.marker.getValues(f,[d]);this.entityBars=this.bars.selectAll(".vzb-bc-bar").data(g),this.entityBars.exit().remove(),this.entityBars.enter().append("rect").attr("class","vzb-bc-bar").on("mousemove",function(a,b){}).on("mouseout",function(a,b){}).on("click",function(a,b){});var i=(this.bars.selectAll(".vzb-bc-bar"),this.xScale.rangeBand());this.bars.selectAll(".vzb-bc-bar").attr("width",i).attr("fill",function(b){return a.cScale(h.color[b[d]])}).attr("x",function(b){return a.xScale(h.axis_x[b[d]])}).transition().duration(e).ease("linear").attr("y",function(b){return a.yScale(h.axis_y[b[d]])}).attr("height",function(b){return a.height-a.yScale(h.axis_y[b[d]])})},resize:function(){var a=this;this.profiles={small:{margin:{top:30,right:20,left:40,bottom:50},padding:2,minRadius:2,maxRadius:40},medium:{margin:{top:30,right:60,left:60,bottom:60},padding:2,minRadius:3,maxRadius:60},large:{margin:{top:30,right:60,left:60,bottom:80},padding:2,minRadius:4,maxRadius:80}},this.activeProfile=this.profiles[this.getLayoutProfile()];var b=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-b.top-b.bottom,this.width=parseInt(this.element.style("width"),10)-b.left-b.right,this.graph.attr("transform","translate("+b.left+","+b.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],a.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width],a.activeProfile.padding).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:b,limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:b}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.xScale.rangeRoundBands([0,this.width],.1,.2),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis);var c=this.xAxisEl.node().getBoundingClientRect(),d=this.xTitleEl.node().getBoundingClientRect(),e=c.width/2-d.width/2,f=this.height+c.height+d.height;this.xTitleEl.attr("transform","translate("+e+","+f+")")}});var d=a.Tool.extend("BarChart",{init:function(a,b){this.name="barchart",this.components=[{component:"gapminder-barchart",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:"gapminder-buttonlist",placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:"gapminder-treemenu",placeholder:".vzb-tool-treemenu",model:["state.marker","language"]}],this._super(a,b)}});d.define("default_options",{state:{time:{},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"lex"},axis_x:{use:"property",which:"geo.name"},color:{use:"property",which:"geo.region"}}},data:{reader:"csv-file",path:"local_data/waffles/basic-indicators.csv"}})}}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils,c=a.iconset;a._require("d3")&&a.Component.extend("gapminder-bubblechart",{init:function(c,d){var e=this;this.name="bubblechart",this.template="src/tools/bubblechart/bubblechart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}],this._splash=c.ui.splash,this.model_binds={"change:time":function(a,b){if(e._splash!==e.model.time.splash){if(!e._readyOnce)return;e._splash=e.model.time.splash}},"change:time:record":function(){e.model.time.record?e._export.open(this.element,this.name):e._export.reset()},"change:time:trails":function(a){e._trails.toggle(e.model.time.trails),e.redrawDataPoints()},"change:time:lockNonSelected":function(a){e.redrawDataPoints(500)},"change:marker":function(a){return!e._readyOnce||-1!==a.indexOf("change:marker:size")||a.indexOf("change:marker:color:palette")>-1?void 0:a.indexOf("min")>-1||a.indexOf("max")>-1?(e.updateSize(),e.updateMarkerSizeLimits(),e._trails.run("findVisible"),e.redrawDataPoints(),void e._trails.run("resize")):void e.ready()},"change:entities:select":function(){e._readyOnce&&(e.selectDataPoints(),e.redrawDataPoints(),e._trails.run(["resize","recolor","findVisible","reveal"]),e.updateBubbleOpacity(),e._updateDoubtOpacity())},"change:entities:highlight":function(){e._readyOnce&&e.highlightDataPoints()},"change:time:value":function(){e.updateTime(),e._updateDoubtOpacity(),e._trails.run("findVisible"),e.model.time.adaptMinMaxZoom?e.adaptMinMaxZoom():e.redrawDataPoints(),e._trails.run("reveal"),e.tooltipMobile.classed("vzb-hidden",!0),e._bubblesInteract().mouseout()},"change:time:adaptMinMaxZoom":function(){e.model.time.adaptMinMaxZoom?e.adaptMinMaxZoom():e.resetZoomer()},"change:marker:size":function(){e.updateMarkerSizeLimits(),e._trails.run("findVisible"),e.redrawDataPointsOnlySize(),e._trails.run("resize")},"change:marker:color:palette":function(){e.redrawDataPointsOnlyColors(),e._trails.run("recolor")},"change:entities:opacitySelectDim":function(){e.updateBubbleOpacity()},"change:entities:opacityRegular":function(){e.updateBubbleOpacity()}},this._super(c,d),this.xScale=null,this.yScale=null,this.sScale=null,this.cScale=null,this.xAxis=d3.svg.axisSmart(),this.yAxis=d3.svg.axisSmart(),this.cached={},this.xyMaxMinMean={},this.currentZoomFrameXY=null,this.draggingNow=null,this.ui=b.extend({whenHovering:{},labels:{}},this.ui["vzb-tool-"+this.name]),this.ui.whenHovering=b.extend({showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},this.ui.whenHovering),this.ui.labels=b.extend({autoResolveCollisions:!1,dragging:!0},this.ui.labels);var f=a.Helper.get("gapminder-bublechart-trails");this._trails=new f(this);var g=a.Helper.get("gapminder-svgexport");this._export=new g(this),this._export.prefix("vzb-bc-").deleteClasses(["vzb-bc-bubbles-crop","vzb-hidden","vzb-bc-year","vzb-bc-zoomRect","vzb-bc-projection-x","vzb-bc-projection-y","vzb-bc-axis-c-title"]),this.dragger=d3.behavior.drag().on("dragstart",function(a,b){d3.event.sourceEvent.stopPropagation();var c=e.KEY;e.druging=a[c]}).on("drag",function(a,b){var c=e.KEY;if(e.ui.labels.dragging){var d=e.cached[a[c]];d.labelFixed=!0,d.labelX_+=d3.event.dx/e.width,d.labelY_+=d3.event.dy/e.height;var f=e.xScale(d.labelX0)+d.labelX_*e.width,g=e.yScale(d.labelY0)+d.labelY_*e.height,h=e.xScale(d.labelX0),i=e.yScale(d.labelY0),j=e.entityLines.filter(function(b){return b[c]==a[c]});e._repositionLabels(a,b,this,f,g,h,i,0,j)}}).on("dragend",function(a,b){var c=e.KEY;e.druging=null,e.model.entities.setLabelOffset(a,[Math.round(100*e.cached[a[c]].labelX_)/100,Math.round(100*e.cached[a[c]].labelY_)/100])}),this.dragRectangle=d3.behavior.drag().on("dragstart",function(a,b){(d3.event.sourceEvent.ctrlKey||d3.event.sourceEvent.metaKey)&&(this.ctrlKeyLock=!0,this.origin={x:d3.mouse(this)[0]-e.activeProfile.margin.left,y:d3.mouse(this)[1]-e.activeProfile.margin.top},e.zoomRect.classed("vzb-invisible",!1))}).on("drag",function(a,b){if(this.ctrlKeyLock){var c=this.origin,d={x:d3.event.x-e.activeProfile.margin.left,y:d3.event.y-e.activeProfile.margin.top};e.zoomRect.attr("x",Math.min(d.x,c.x)).attr("y",Math.min(d.y,c.y)).attr("width",Math.abs(d.x-c.x)).attr("height",Math.abs(d.y-c.y))}}).on("dragend",function(a){this.ctrlKeyLock&&(this.ctrlKeyLock=!1,e.zoomRect.attr("width",0).attr("height",0).classed("vzb-invisible",!0),this.target={x:d3.mouse(this)[0]-e.activeProfile.margin.left,y:d3.mouse(this)[1]-e.activeProfile.margin.top},e._zoomOnRectangle(d3.select(this),this.origin.x,this.origin.y,this.target.x,this.target.y,!0,500))}),this.zoomer=d3.behavior.zoom().scaleExtent([1,100]).on("zoom",function(){if(null==d3.event.sourceEvent||!d3.event.sourceEvent.ctrlKey&&!d3.event.sourceEvent.metaKey){if(null!=d3.event.sourceEvent&&e.scrollableAncestor&&(1==d3.event.scale&&(e.scrollableAncestor.scrollTop+=d3.event.sourceEvent.deltaY),b.getViewportPosition(e.element.node()).y<0&&d3.event.scale>1))return void(e.scrollableAncestor.scrollTop+=d3.event.sourceEvent.deltaY);e.model._data.entities.clearHighlighted(),e._setTooltip();var a=d3.event.scale,c=d3.event.translate,d=e.zoomer.ratioY,f=e.zoomer.ratioX;e.draggingNow=!0,(isNaN(a)||null==a)&&(a=e.zoomer.scale()),(isNaN(a)||null==a)&&(a=1),1==a&&(e.zoomer.ratioX=1,f=1,e.zoomer.ratioY=1,d=1),(isNaN(c[0])||isNaN(c[1])||null==c[0]||null==c[1])&&(c=e.zoomer.translate()),(isNaN(c[0])||isNaN(c[1])||null==c[0]||null==c[1])&&(c=[0,0]),1>a*d&&(d=1/a,e.zoomer.ratioY=d),1>a*f&&(f=1/a,e.zoomer.ratioX=f),c[0]>0&&(c[0]=0),c[1]>0&&(c[1]=0),c[0]<(1-a*f)*e.width&&(c[0]=(1-a*f)*e.width),c[1]<(1-a*d)*e.height&&(c[1]=(1-a*d)*e.height),e.zoomer.translate(c);var g=[0*a*f+c[0],e.width*a*f+c[0]],h=[e.height*a*d+c[1],0*a*d+c[1]];"ordinal"===e.model.marker.axis_x.scaleType?e.xScale.rangeBands(g):e.xScale.range(g),"ordinal"===e.model.marker.axis_y.scaleType?e.yScale.rangeBands(h):e.yScale.range(h);var i=e.yAxis.labelerOptions(),j=e.xAxis.labelerOptions();i.limitMaxTickNumber=2>a*d?7:14,i.transitionDuration=e.zoomer.duration,j.transitionDuration=e.zoomer.duration,e.xAxisEl.call(e.xAxis.labelerOptions(j)),e.yAxisEl.call(e.yAxis.labelerOptions(i)),e.redrawDataPoints(e.zoomer.duration),e._trails.run("resize",null,e.zoomer.duration),e.zoomer.duration=0}}).on("zoomend",function(){e.draggingNow=!1}),this.zoomer.ratioX=1,this.zoomer.ratioY=1,this.fontSettings={minSize:8,step:2}},readyOnce:function(){var a=this;this.scrollableAncestor=b.findScrollableAncestor(this.element),this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisElContainer=this.graph.select(".vzb-bc-axis-y"),this.yAxisEl=this.yAxisElContainer.select("g"),this.xAxisElContainer=this.graph.select(".vzb-bc-axis-x"),this.xAxisEl=this.xAxisElContainer.select("g"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.xTitleEl=this.graph.select(".vzb-bc-axis-x-title"),this.sTitleEl=this.graph.select(".vzb-bc-axis-s-title"),this.cTitleEl=this.graph.select(".vzb-bc-axis-c-title"),this.yearEl=this.graph.select(".vzb-bc-year"),this.yInfoEl=this.graph.select(".vzb-bc-axis-y-info"),this.xInfoEl=this.graph.select(".vzb-bc-axis-x-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.fontSettings.maxTitleFontSize=parseInt(this.sTitleEl.style("font-size"),10),this.projectionX=this.graph.select(".vzb-bc-projection-x"),this.projectionY=this.graph.select(".vzb-bc-projection-y"),this.trailsContainer=this.graph.select(".vzb-bc-trails"),this.bubbleContainerCrop=this.graph.select(".vzb-bc-bubbles-crop"),this.bubbleContainer=this.graph.select(".vzb-bc-bubbles"),this.labelsContainer=this.graph.select(".vzb-bc-labels"),this.linesContainer=this.graph.select(".vzb-bc-lines"),this.zoomRect=this.element.select(".vzb-bc-zoomRect"),this.entityBubbles=null,this.entityLabels=null,this.tooltip=this.element.select(".vzb-bc-tooltip"),this.tooltipMobile=this.element.select(".vzb-tooltip-mobile"),this.entityLines=null,this.on("resize",function(){a.updateSize(),a.updateMarkerSizeLimits(),a._trails.run("findVisible"),a.resetZoomer()}),d3.select("body").on("keydown",function(){(d3.event.metaKey||d3.event.ctrlKey)&&a.element.select("svg").classed("vzb-zoomin",!0)}).on("keyup",function(){d3.event.metaKey||d3.event.ctrlKey||a.element.select("svg").classed("vzb-zoomin",!1)}),this.element.on("mouseup",function(){a.draggingNow=!1}).onTap(function(){}),this.KEY=this.model.entities.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this._calculateAllValues(),this._valuesCalculated=!0,this.updateUIStrings(),this.wScale=d3.scale.linear().domain(this.parent.datawarning_content.doubtDomain).range(this.parent.datawarning_content.doubtRange),this.updateIndicators(),this.updateEntities(),this.updateTime(),this.updateSize(),this.updateMarkerSizeLimits(),this.selectDataPoints(),this.updateBubbleOpacity(),this._updateDoubtOpacity(),this._trails.create(),this.resetZoomer(),this._trails.run(["recolor","findVisible","reveal"]),this.model.time.adaptMinMaxZoom&&this.adaptMinMaxZoom()},ready:function(){this._valuesCalculated?this._valuesCalculated=!1:this._calculateAllValues(),this.updateUIStrings(),this.updateEntities(),this.redrawDataPoints(),this.updateBubbleOpacity(),this.updateIndicators(),this.updateSize(),this.updateMarkerSizeLimits(),this._trails.create(),this._trails.run("findVisible"),this.resetZoomer(),this._trails.run(["recolor","reveal"])},updateIndicators:function(){var a=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.sScale=this.model.marker.size.getScale(),this.cScale=this.model.marker.color.getScale(),this.yAxis.tickFormat(a.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(a.model.marker.axis_x.tickFormatter),this.xyMaxMinMean={x:this.model.marker.axis_x.getMaxMinMean({timeFormatter:this.timeFormatter,skipZeros:!0}),y:this.model.marker.axis_y.getMaxMinMean({timeFormatter:this.timeFormatter,skipZeros:!0}),s:this.model.marker.size.getMaxMinMean({timeFormatter:this.timeFormatter,skipZeros:!0})}},updateUIStrings:function(){var b=this;this.translator=this.model.language.getTFunction(),this.timeFormatter=d3.time.format(b.model.time.formatOutput);var d=a._globals.metadata.indicatorsDB;this.strings={title:{Y:this.translator("indicator/"+this.model.marker.axis_y.which),X:this.translator("indicator/"+this.model.marker.axis_x.which),S:this.translator("indicator/"+this.model.marker.size.which),C:this.translator("indicator/"+this.model.marker.color.which)},unit:{Y:this.translator("unit/"+d[this.model.marker.axis_y.which].unit)||"",X:this.translator("unit/"+d[this.model.marker.axis_x.which].unit)||"",S:this.translator("unit/"+d[this.model.marker.size.which].unit)||"",C:this.translator("unit/"+d[this.model.marker.color.which].unit)||""}},this.strings.unit.Y&&(this.strings.unit.Y=", "+this.strings.unit.Y),this.strings.unit.X&&(this.strings.unit.X=", "+this.strings.unit.X),this.strings.unit.S&&(this.strings.unit.S=", "+this.strings.unit.S),this.strings.unit.C&&(this.strings.unit.C=", "+this.strings.unit.C);var e=this.yTitleEl.selectAll("text").data([0]);e.enter().append("text"),e.attr("y","-6px").on("click",function(){});var f=this.xTitleEl.selectAll("text").data([0]);f.enter().append("text"),f.attr("y","-0.32em").on("click",function(){});var g=this.sTitleEl.selectAll("text").data([0]);g.enter().append("text"),g.attr("text-anchor","end"),this.dataWarningEl.html(c.warn).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").attr("text-anchor","end").attr("y","-0.32em").text(this.translator("hints/dataWarning")),this.yInfoEl.on("click",function(){window.open(d[b.model.marker.axis_y.which].sourceLink,"_blank").focus()}),this.xInfoEl.on("click",function(){window.open(d[b.model.marker.axis_x.which].sourceLink,"_blank").focus()}),this.dataWarningEl.on("click",function(){b.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){b._updateDoubtOpacity(1)}).on("mouseout",function(){b._updateDoubtOpacity()})},_updateDoubtOpacity:function(a){null==a&&(a=this.wScale(+this.timeFormatter(this.time))),this.someSelected&&(a=1),this.dataWarningEl.style("opacity",a)},updateEntities:function(){var a=this,c=this.KEY,d=this.TIMEDIM,e=function(a){return a=a||"",this.model.marker.getKeys().map(function(b){var e={};return e[c]=b[c],e[d]=f,e.sortValue=g.size[b[c]],e[c]=a+b[c],e}).sort(function(a,b){return b.sortValue-a.sortValue})},f=this.model.time.end,g=this._getValuesInterpolated(f);this.model.entities.setVisible(e.call(this)),this.entityBubbles=this.bubbleContainer.selectAll(".vzb-bc-entity").data(this.model.entities.getVisible(),function(a){return a[c]}),this.entityBubbles.exit().remove(),this.entityBubbles.enter().append("circle").attr("class",function(a){return"vzb-bc-entity "+a[c]}).on("mouseover",function(c,d){b.isTouchDevice()||a._bubblesInteract().mouseover(c,d)}).on("mouseout",function(c,d){b.isTouchDevice()||a._bubblesInteract().mouseout(c,d)}).on("click",function(c,d){b.isTouchDevice()||a._bubblesInteract().click(c,d)}).onTap(function(a,b){return}).onLongTap(function(a,b){}),this.entityTrails=this.bubbleContainer.selectAll(".vzb-bc-entity").data(e.call(this,"trail-"),function(a){return a[c]}),this.entityTrails.enter().insert("g",function(a){return document.querySelector(".vzb-bc-bubbles ."+a[c].replace("trail-",""))}).attr("class",function(a){return"vzb-bc-entity "+a[c];
})},_bubblesInteract:function(){var a=this,c=this.KEY,d=this.TIMEDIM;return{mouseover:function(e,f){a.model.entities.highlightEntity(e);var g="";a.model.entities.isSelected(e)&&a.model.time.trails?(g=a.timeFormatter(a.time),a.entityLabels.filter(function(a){return a[c]==e[c]}).classed("vzb-highlighted",!0)):g=a.model.marker.label.getValue(e);var h={};h[c]=e[c],h[d]=a.time;var i=a.xScale(a.model.marker.axis_x.getValue(h)),j=a.yScale(a.model.marker.axis_y.getValue(h)),k=b.areaToRadius(a.sScale(a.model.marker.size.getValue(h)));a._setTooltip(g,i-k/2,j-k/2)},mouseout:function(b,c){a.model.entities.clearHighlighted(),a._setTooltip(),a.entityLabels.classed("vzb-highlighted",!1)},click:function(b,c){a.draggingNow||(a._setTooltip(),a.model.entities.selectEntity(b,d,a.timeFormatter))}}},adaptMinMaxZoom:function(){var a=this,c=a.xyMaxMinMean.x[a.timeFormatter(a.time)],d=a.xyMaxMinMean.y[a.timeFormatter(a.time)],e=b.areaToRadius(a.sScale(a.xyMaxMinMean.s[a.timeFormatter(a.time)].max)),f=a.currentZoomFrameXY,g={x1:a.xScale(c.min)-e,y1:a.yScale(d.min)+e,x2:a.xScale(c.max)+e,y2:a.yScale(d.max)-e},h=0;if(!f||g.x1<f.x1*(1-h)||g.x2>f.x2*(1+h)||g.y2<f.y2*(1-h)||g.y1>f.y1*(1+h)){a.currentZoomFrameXY=b.clone(g);var f=a.currentZoomFrameXY;a._zoomOnRectangle(a.element,f.x1,f.y1,f.x2,f.y2,!1,a.duration)}else a.redrawDataPoints(a.duration)},_zoomOnRectangle:function(a,b,c,d,e,f,g){var h=this,i=h.zoomer;if(!(Math.abs(b-d)<10||Math.abs(c-e)<10)){if(Math.abs(b-d)>Math.abs(c-e))var j=h.height/Math.abs(c-e)*i.scale(),k=h.width/Math.abs(b-d)*i.scale()/j*i.ratioX,l=i.ratioY;else var j=h.width/Math.abs(b-d)*i.scale(),l=h.height/Math.abs(c-e)*i.scale()/j*i.ratioY,k=i.ratioX;f&&i.translate([i.translate()[0]+b-d,i.translate()[1]+c-e]);var m=[(i.translate()[0]-Math.min(b,d))/i.scale()/i.ratioX*j*k,(i.translate()[1]-Math.min(c,e))/i.scale()/i.ratioY*j*l];i.scale(j),i.ratioY=l,i.ratioX=k,i.translate(m),i.duration=g?g:0,i.event(a)}},resetZoomer:function(a){this.zoomer.scale(1),this.zoomer.ratioY=1,this.zoomer.ratioX=1,this.zoomer.translate([0,0]),this.zoomer.duration=0,this.zoomer.event(a||this.element)},updateTime:function(){this.time_1=null==this.time?this.model.time.value:this.time,this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-this.time_1>0?this.model.time.speed:0,this.yearEl.text(this.timeFormatter(this.time))},updateSize:function(){var a=this;this.profiles={small:{margin:{top:30,right:10,left:40,bottom:45},padding:2,minRadius:.5,maxRadius:40},medium:{margin:{top:40,right:15,left:60,bottom:55},padding:2,minRadius:1,maxRadius:55},large:{margin:{top:50,right:20,left:60,bottom:60},padding:2,minRadius:1,maxRadius:70}},this.activeProfile=this.profiles[this.getLayoutProfile()];var b=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-b.top-b.bottom,this.width=parseInt(this.element.style("width"),10)-b.left-b.right,this.graph.attr("transform","translate("+b.left+","+b.top+")"),this.yearEl.attr("x",this.width/2).attr("y",this.height/3*2).style("font-size",Math.max(this.height/4,this.width/4)+"px"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],a.activeProfile.padding).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width],a.activeProfile.padding).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:{top:0,right:b.right,left:b.left,bottom:0},limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:{top:b.top,right:5,left:5,bottom:b.bottom}}),this.bubbleContainerCrop.attr("width",this.width).attr("height",this.height),this.xAxisElContainer.attr("width",this.width).attr("height",this.activeProfile.margin.bottom).attr("y",this.height),this.xAxisEl.attr("transform","translate(0,1)"),this.yAxisElContainer.attr("width",this.activeProfile.margin.left).attr("height",this.height).attr("x",-this.activeProfile.margin.left),this.yAxisEl.attr("transform","translate("+(this.activeProfile.margin.left-1)+",0)"),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.projectionX.attr("y1",a.yScale.range()[0]),this.projectionY.attr("x2",a.xScale.range()[0]);var c=this.yTitleEl.select("text").text(this.strings.title.Y+this.strings.unit.Y);c.node().getBBox().width>this.width&&c.text(this.strings.title.Y);var d=this.xTitleEl.select("text").text(this.strings.title.X+this.strings.unit.X);d.node().getBBox().width>this.width&&d.text(this.strings.title.X);var e=this.sTitleEl.select("text").text(this.translator("buttons/size")+": "+this.strings.title.S+", "+this.translator("buttons/colors")+": "+this.strings.title.C),f=this.sTitleEl.append("text").text(e.text()),g=parseInt(f.style("font-size"))*(this.height-20)/f.node().getBBox().width;f.node().getBBox().width>this.height-20?e.style("font-size",g):e.style("font-size",null),f.remove();var h=this.yAxisElContainer.select("g").node().getBBox().width;this.yTitleEl.attr("transform","translate("+-h+",0)"),this.xTitleEl.attr("transform","translate(0,"+(this.height+b.bottom)+")"),this.sTitleEl.attr("transform","translate("+this.width+",20) rotate(-90)"),this.dataWarningEl.attr("transform","translate("+this.width+","+(this.height+b.bottom)+")"),this.dataWarningEl.select("text").text(this.translator("hints/dataWarning"+("small"===this.getLayoutProfile()?"-little":"")));var i=this.dataWarningEl.select("text").node().getBBox();if(this.dataWarningEl.select("svg").attr("width",i.height).attr("height",i.height).attr("x",-i.width-1.2*i.height).attr("y",1.2*-i.height),this.yInfoEl.select("text").node()){var j=this.yInfoEl.select("text").node().getBBox().height||0,k=this.yTitleEl.select("text").node().getBBox().width||0;this.yInfoEl.attr("transform","translate("+(k-h+1*j)+","+.7*-j+")"),this.yInfoEl.select("text").attr("dy","0.1em"),this.yInfoEl.select("circle").attr("r",j/2)}if(this.xInfoEl.select("text").node()){var j=this.xInfoEl.select("text").node().getBBox().height||0,k=this.xTitleEl.select("text").node().getBBox().width||0;this.xInfoEl.attr("transform","translate("+(k+1*j)+","+(this.height+b.bottom-.7*j)+")"),this.xInfoEl.select("text").attr("dy","0.1em"),this.xInfoEl.select("circle").attr("r",j/2)}},updateMarkerSizeLimits:function(){var a=this,c=this.activeProfile.minRadius,d=this.activeProfile.maxRadius;this.minRadius=Math.max(d*this.model.marker.size.min,c),this.maxRadius=Math.max(d*this.model.marker.size.max,c),"ordinal"!==this.model.marker.size.scaleType?this.sScale.range([b.radiusToArea(a.minRadius),b.radiusToArea(a.maxRadius)]):this.sScale.rangePoints([b.radiusToArea(a.minRadius),b.radiusToArea(a.maxRadius)],0).range()},redrawDataPointsOnlyColors:function(){var a=this,b=this.KEY,c=this.TIMEDIM;this.entityBubbles.style("fill",function(d){var e={};e[b]=d[b],e[c]=a.time;var f=a.model.marker.color.getValue(e);return a.cScale(f)})},redrawDataPointsOnlySize:function(){var a,c=this,d=this.KEY;if(this.model.time.lockNonSelected&&this.someSelected){var e=this.timeFormatter.parse(""+this.model.time.lockNonSelected);a=this._getValuesInterpolated(e)}else a=this._getValuesInterpolated(this.time);this.entityBubbles.each(function(e,f){var g=a.size[e[d]];null!=g&&d3.select(this).attr("r",b.areaToRadius(c.sScale(g)))})},redrawDataPoints:function(a){var b=this;null==a&&(a=b.duration);var c,d;this.TIMEDIM,this.KEY;if(this.model.time.lockNonSelected&&this.someSelected){var e=this.timeFormatter.parse(""+this.model.time.lockNonSelected);d=this._getValuesInterpolated(e)}c=this._getValuesInterpolated(this.time),this.entityBubbles.each(function(e,f){var g=d3.select(this);b._updateBubble(e,c,d,f,g,a)}),0==b.duration&&d3.timer.flush(),b.ui.labels.autoResolveCollisions&&(clearTimeout(b.collisionTimeout),b.collisionTimeout=setTimeout(function(){},1.2*b.model.time.speed))},_updateBubble:function(a,c,d,e,f,g){var h=this,i=(this.TIMEDIM,this.KEY);h.model.time.lockNonSelected&&h.someSelected&&!h.model.entities.isSelected(a)&&(c=d);var j=c.axis_y[a[i]],k=c.axis_x[a[i]],l=c.size[a[i]],m=c.label[a[i]],n=c.color[a[i]];if(m&&j&&k&&l){var o=b.areaToRadius(h.sScale(l));f.classed("vzb-invisible",!1).style("fill",h.cScale(n)),g?f.transition().duration(g).ease("linear").attr("cy",h.yScale(j)).attr("cx",h.xScale(k)).attr("r",o):(f.attr("cy",h.yScale(j)).attr("cx",h.xScale(k)).attr("r",o),d3.timer.flush()),this.model.time.record&&h._export.write({type:"circle",id:a[i],time:this.model.time.value.getFullYear(),fill:h.cScale(n),cx:h.xScale(k),cy:h.yScale(j),r:o}),h._updateLabel(a,e,k,j,o,m,g)}else f.classed("vzb-invisible",!0)},_updateLabel:function(a,c,d,e,f,g,h){var i=this,j=this.KEY;if(a[j]!=i.druging)if(null==h&&(h=i.duration),i.model.entities.isSelected(a)&&null!=i.entityLabels){null==i.cached[a[j]]&&(i.cached[a[j]]={});var k=i.cached[a[j]],l=b.find(i.model.entities.select,function(b){return b[j]==a[j]}),m=i.timeFormatter.parse(""+l.trailStartTime);k.valueX=d,k.valueY=e,(!i.model.time.trails||m-i.time>0||null==l.trailStartTime)&&(l.trailStartTime=i.timeFormatter(i.time),k.scaledS0=f,k.labelX0=d,k.labelY0=e),(null==k.scaledS0||null==k.labelX0||null==k.labelX0)&&(k.scaledS0=f,k.labelX0=d,k.labelY0=e);var n=i.entityLines.filter(function(b){return b[j]==a[j]});i.entityLabels.filter(function(b){return b[j]==a[j]}).each(function(b){var d=d3.select(this),e=d.selectAll("text.vzb-bc-label-content").text(g+(i.model.time.trails?" "+l.trailStartTime:""));n.select("line").style("stroke-dasharray","0 "+(k.scaledS0+2)+" 100%");var f=d.select("rect"),j=e[0][0].getBBox();k.contentBBox&&k.contentBBox.width==j.width||(k.contentBBox=j,d.select("text.vzb-bc-label-x").attr("x",0*j.height+4).attr("y",-1*j.height),d.select("circle").attr("cx",0*j.height+4).attr("cy",-1*j.height).attr("r",.5*j.height),f.attr("width",j.width+8).attr("height",j.height+8).attr("x",-j.width-4).attr("y",-j.height-1).attr("rx",.2*j.height).attr("ry",.2*j.height)),k.labelX_=l.labelOffset[0]||-k.scaledS0/2/i.width,k.labelY_=l.labelOffset[1]||-k.scaledS0/2/i.width;var m=i.xScale(k.labelX0)+k.labelX_*i.width,o=i.yScale(k.labelY0)+k.labelY_*i.height,p=m-k.contentBBox.width>0?m<i.width?m:i.width:k.contentBBox.width,q=o-k.contentBBox.height>0?o<i.height?o:i.height:k.contentBBox.height,r=i.xScale(k.labelX0),s=i.yScale(k.labelY0);i._repositionLabels(a,c,this,p,q,r,s,h,n)})}else null!=i.cached[a[j]]&&(i.cached[a[j]]=void 0)},_repositionLabels:function(a,b,c,d,e,f,g,h,i){var j=d3.select(c);h?(j.transition().duration(h).ease("linear").attr("transform","translate("+d+","+e+")"),i.transition().duration(h).ease("linear").attr("transform","translate("+d+","+e+")")):(j.attr("transform","translate("+d+","+e+")"),i.attr("transform","translate("+d+","+e+")"));var k=parseInt(j.select("rect").attr("width")),l=parseInt(j.select("rect").attr("height")),m=f-d,n=g-e,o=0,p=0,q=180*Math.atan2(m+k/2,n+l/2)/Math.PI;Math.abs(q)<=45&&(o=k/2,p=0),q>45&&135>q&&(o=0,p=l/4),-45>q&&q>-135&&(o=k,p=l/4),Math.abs(q)>=135&&(o=k/2,p=l/2),i.selectAll("line").attr("x1",m).attr("y1",n).attr("x2",-o).attr("y2",-p)},selectDataPoints:function(){var a=this,c=this.KEY;a.someSelected=a.model.entities.select.length>0,this.entityLabels=this.labelsContainer.selectAll(".vzb-bc-entity").data(a.model.entities.select,function(a){return a[c]}),this.entityLines=this.linesContainer.selectAll(".vzb-bc-entity").data(a.model.entities.select,function(a){return a[c]}),this.entityLabels.exit().each(function(b){a._trails.run("remove",b)}).remove(),this.entityLines.exit().each(function(b){a._trails.run("remove",b)}).remove(),this.entityLines.enter().append("g").attr("class","vzb-bc-entity").call(a.dragger).each(function(a,b){d3.select(this).append("line").attr("class","vzb-bc-label-line")}),this.entityLabels.enter().append("g").attr("class","vzb-bc-entity").call(a.dragger).each(function(d,e){var f=d3.select(this);f.append("rect").on("click",function(d,e){if(!d3.event.defaultPrevented){var f=a.cached[d[c]].maxMinValues,g=b.areaToRadius(a.sScale(f.valueSmax));a._zoomOnRectangle(a.element,a.xScale(f.valueXmin)-g,a.yScale(f.valueYmin)+g,a.xScale(f.valueXmax)+g,a.yScale(f.valueYmax)-g,!1,500)}}),f.append("text").attr("class","vzb-bc-label-content vzb-label-shadow"),f.append("text").attr("class","vzb-bc-label-content"),f.append("circle").attr("class","vzb-bc-label-x vzb-label-shadow vzb-transparent").on("click",function(b,c){a.model.entities.clearHighlighted(),d3.event.defaultPrevented||a.model.entities.selectEntity(b)}),f.append("text").attr("class","vzb-bc-label-x vzb-transparent").text("x"),a._trails.create(d)}).on("mousemove",function(){a.model.entities.highlightEntity(this.__data__),d3.select(this).selectAll(".vzb-bc-label-x").classed("vzb-transparent",!1)}).on("mouseout",function(b){a.model.entities.clearHighlighted(),d3.select(this).selectAll(".vzb-bc-label-x").classed("vzb-transparent",!0)})},_setTooltip:function(a,b,c){if(a){var d=d3.mouse(this.graph.node()).map(function(a){return parseInt(a)});this.tooltip.classed("vzb-hidden",!1).attr("transform","translate("+(b?b:d[0])+","+(c?c:d[1])+")").selectAll("text").text(a);var e=this.tooltip.select("text")[0][0].getBBox();this.tooltip.select("rect").attr("width",e.width+8).attr("height",e.height+8).attr("x",-e.width-4).attr("y",-e.height-1).attr("rx",.2*e.height).attr("ry",.2*e.height)}else this.tooltip.classed("vzb-hidden",!0)},_axisProjections:function(a){if(null!=a){var c=this.model.marker.axis_y.getValue(a),d=this.model.marker.axis_x.getValue(a),e=this.model.marker.size.getValue(a),f=b.areaToRadius(this.sScale(e));if(!c||!d||!e)return;this.ui.whenHovering.showProjectionLineX&&this.projectionX.style("opacity",1).attr("y2",this.yScale(c)+f).attr("x1",this.xScale(d)).attr("x2",this.xScale(d)),this.ui.whenHovering.showProjectionLineY&&this.projectionY.style("opacity",1).attr("y1",this.yScale(c)).attr("y2",this.yScale(c)).attr("x1",this.xScale(d)-f),this.ui.whenHovering.higlightValueX&&this.xAxisEl.call(this.xAxis.highlightValue(d)),this.ui.whenHovering.higlightValueY&&this.yAxisEl.call(this.yAxis.highlightValue(c))}else this.projectionX.style("opacity",0),this.projectionY.style("opacity",0),this.xAxisEl.call(this.xAxis.highlightValue("none")),this.yAxisEl.call(this.yAxis.highlightValue("none"))},highlightDataPoints:function(){var a=this,c=this.TIMEDIM;if(this.someHighlighted=this.model.entities.highlight.length>0,this.updateBubbleOpacity(),1===this.model.entities.highlight.length){var d=b.clone(this.model.entities.highlight[0]);a.model.time.lockNonSelected&&a.someSelected&&!a.model.entities.isSelected(d)?d[c]=a.timeFormatter.parse(""+a.model.time.lockNonSelected):d[c]=d.trailStartTime||a.time,this._axisProjections(d)}else this._axisProjections()},updateBubbleOpacity:function(a){var b=this,c=1,d=.3,e=this.model.entities.opacityRegular,f=this.model.entities.opacityRegular,g=this.model.entities.opacitySelectDim;this.entityBubbles.style("opacity",function(a){return b.someHighlighted&&b.model.entities.isHighlighted(a)?c:b.someSelected?b.model.entities.isSelected(a)?e:g:b.someHighlighted?d:f});var h=b.someSelected&&b.model.entities.opacitySelectDim<.01;h!=this.someSelectedAndOpacityZero_1&&this.entityBubbles.style("pointer-events",function(a){return!h||b.model.entities.isSelected(a)?"visible":"none"}),this.someSelectedAndOpacityZero_1=b.someSelected&&b.model.entities.opacitySelectDim<.01},_calculateAllValues:function(){this.STEPS=this.model.time.getAllSteps(),this.VALUES={};for(var a={},b=0;b<this.STEPS.length;b++){var c=this.STEPS[b];a[this.TIMEDIM]=c,this.VALUES[c]=this.model.marker.getValues(a,[this.KEY])}},_getValuesInterpolated:function(a){if(this.VALUES||this._calculateAllValues(),this.VALUES[a])return this.VALUES[a];var c=d3.bisectLeft(this.STEPS,a);if(0===c)return this.VALUES[this.STEPS[0]];if(c>this.STEPS.length)return this.VALUES[this.STEPS[this.STEPS.length-1]];var d=(a-this.STEPS[c-1])/(this.STEPS[c]-this.STEPS[c-1]),e=this.VALUES[this.STEPS[c-1]],f=this.VALUES[this.STEPS[c]],g={};return b.forEach(e,function(a,c){g[c]={},b.forEach(a,function(a,e){var h=f[c][e];g[c][e]=b.isNumber(a)?a+(h-a)*d:a})}),g}})}.call(this),function(){"use strict";var a=this.Vizabi;a.utils;a._require("d3")&&a.Tool.extend("BubbleChart",{init:function(a,b){this.name="bubblechart",this.components=[{component:"gapminder-bubblechart",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:"gapminder-buttonlist",placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:"gapminder-treemenu",placeholder:".vzb-tool-treemenu",model:["state.marker","language"]},{component:"gapminder-datawarning",placeholder:".vzb-tool-datawarning",model:["language"]}],this._super(a,b)}})}.call(this),function(){"use strict";var a=this.Vizabi.Tool.get("BubbleChart");a.define("default_options",{state:{time:{round:"ceil",trails:!0,lockNonSelected:0,adaptMinMaxZoom:!1},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["country"]}},opacitySelectDim:.3,opacityRegular:1},marker:{space:["entities","time"],type:"geometry",label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"lex"},axis_x:{use:"indicator",which:"gdp_per_cap"},color:{use:"property",which:"geo.region"},size:{use:"indicator",which:"pop"}}},data:{reader:"csv-file",path:"local_data/waffles/basic-indicators.csv"}})}.call(this),function(){var a=this.Vizabi,b=a.utils;a.Helper.extend("gapminder-bublechart-trails",{init:function(a){this.context=a},toggle:function(a){var b=this.context;a?(b._trails.create(),b._trails.run(["resize","recolor","findVisible","reveal"])):(b._trails.run("remove"),b.model.entities.select.forEach(function(a){a.trailStartTime=null}))},create:function(a){var b=this.context,c=b.KEY;if(b.model.time.trails&&b.model.entities.select.length){for(var d=+b.timeFormatter(b.model.time.start),e=+b.timeFormatter(b.model.time.end),f=b.model.time.step,g=[],h=d;e>=h;h+=f)g.push(h);a=null==a?b.model.entities.select:[a],a.forEach(function(a){var d=g.map(function(a){return{t:b.timeFormatter.parse(""+a)}});null==b.cached[a[c]]&&(b.cached[a[c]]={}),b.cached[a[c]].maxMinValues={valueXmax:null,valueXmin:null,valueYmax:null,valueYmin:null,valueSmax:null};var e=b.cached[a[c]].maxMinValues,f=b.entityTrails.filter(function(b){return b[c]=="trail-"+a[c]}).selectAll("g").data(d);f.exit().remove(),f.enter().append("g").attr("class","trailSegment").on("mousemove",function(a,d){var e=d3.select(this.parentNode).data()[0][c],f={};f[c]=e.replace("trail-",""),f.time=a.t,b._axisProjections(f),b._setTooltip(b.timeFormatter(a.t)),b.entityLabels.filter(function(a){return a[c]==e}).classed("vzb-highlighted",!0)}).on("mouseout",function(a,c){b._axisProjections(),b._setTooltip(),b.entityLabels.classed("vzb-highlighted",!1)}).each(function(a,b){var c=d3.select(this);c.append("circle"),c.append("line")}),f.each(function(d,f){var g={};g[c]=a[c],g.time=d.t,d.valueY=b.model.marker.axis_y.getValue(g),d.valueX=b.model.marker.axis_x.getValue(g),d.valueS=b.model.marker.size.getValue(g),d.valueC=b.model.marker.color.getValue(g),(d.valueX>e.valueXmax||null==e.valueXmax)&&(e.valueXmax=d.valueX),(d.valueX<e.valueXmin||null==e.valueXmin)&&(e.valueXmin=d.valueX),(d.valueY>e.valueYmax||null==e.valueYmax)&&(e.valueYmax=d.valueY),(d.valueY<e.valueYmin||null==e.valueYmin)&&(e.valueYmin=d.valueY),(d.valueS>e.valueSmax||null==e.valueSmax)&&(e.valueSmax=d.valueS)})})}},run:function(a,b,c){var d=this.context,e=d.KEY;(d.model.time.trails&&d.model.entities.select.length||"remove"==a)&&(c||(c=0),a=[].concat(a),b=null==b?d.model.entities.select:[b],b.forEach(function(b){var f=d.entityTrails.filter(function(a){return a[e]=="trail-"+b[e]}).selectAll("g");a.forEach(function(a){d._trails["_"+a](f,c,b)})}))},_remove:function(a,b,c){a.remove()},_resize:function(a,c,d){var e=this.context;a.each(function(a,c){var d=d3.select(this);d.select("circle").attr("cy",e.yScale(a.valueY)).attr("cx",e.xScale(a.valueX)).attr("r",b.areaToRadius(e.sScale(a.valueS)));var f=this.parentNode.childNodes[c+1];null!=f&&(f=f.__data__,d.select("line").attr("x1",e.xScale(f.valueX)).attr("y1",e.yScale(f.valueY)).attr("x2",e.xScale(a.valueX)).attr("y2",e.yScale(a.valueY)))})},_recolor:function(a,b,c){var d=this.context;a.each(function(a,b){var c=d3.select(this);c.select("circle").style("fill",d.cScale(a.valueC)),c.select("line").style("stroke",d.cScale(a.valueC))})},_findVisible:function(a,c,d){var e=this.context,f=e.KEY,g=!0,h=e.timeFormatter.parse(""+d.trailStartTime);a.each(function(a,c){a.transparent=a.t-e.time>=0||h-a.t>0||d.trailStartTime-e.timeFormatter(e.time)>=0,g&&!a.transparent&&(e.cached[d[f]].labelX0=a.valueX,e.cached[d[f]].labelY0=a.valueY,e.cached[d[f]].scaledS0=b.areaToRadius(e.sScale(a.valueS)),g=!1)})},_reveal:function(a,b,c){var d=this.context,e=d.KEY;a.each(function(a,b){var f=d3.select(this);if(f.classed("vzb-invisible",a.transparent),!a.transparent){var g=this.parentNode.childNodes[b+1];null!=g&&(g=g.__data__,a.t-d.time<=0&&d.time-g.t<=0?(g=d.cached[c[e]],f.select("line").attr("x2",d.xScale(a.valueX)).attr("y2",d.yScale(a.valueY)).attr("x1",d.xScale(a.valueX)).attr("y1",d.yScale(a.valueY)).attr("x1",d.xScale(g.valueX)).attr("y1",d.yScale(g.valueY))):f.select("line").attr("x2",d.xScale(a.valueX)).attr("y2",d.yScale(a.valueY)).attr("x1",d.xScale(g.valueX)).attr("y1",d.yScale(g.valueY)))}})}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils;b._require("d3")&&b.Component.extend("gapminder-linechart",{init:function(a,b){var d=this;this.name="linechart",this.template="src/tools/linechart/linechart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}],this.model_binds={"change:time:value":function(){d._readyOnce&&(d.updateTime(),d.redrawDataPoints())}},this._super(a,b),this.xScale=null,this.yScale=null,this.xAxis=d3.svg.axisSmart().orient("bottom"),this.yAxis=d3.svg.axisSmart().orient("left"),this.isDataPreprocessed=!1,this.timeUpdatedOnce=!1,this.sizeUpdatedOnce=!1,this.ui=c.extend({entity_labels:{},whenHovering:{}},this.ui["vzb-tool-"+this.name]),this.ui.entity_labels=c.extend({min_number_of_entities_when_values_hide:10},this.ui.entity_labels),this.ui.whenHovering=c.extend({hideVerticalNow:!0,showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0,showTooltip:!0},this.ui.whenHovering),this.getValuesForYear=c.memoize(this.getValuesForYear),this.getNearestKey=c.memoize(this.getNearestKey)},readyOnce:function(){var a=this;this.element=d3.select(this.element),this.graph=this.element.select(".vzb-lc-graph"),this.yAxisEl=this.graph.select(".vzb-lc-axis-y"),this.xAxisEl=this.graph.select(".vzb-lc-axis-x"),this.xTitleEl=this.graph.select(".vzb-lc-axis-x-title"),this.yTitleEl=this.graph.select(".vzb-lc-axis-y-title"),this.xValueEl=this.graph.select(".vzb-lc-axis-x-value"),this.yValueEl=this.graph.select(".vzb-lc-axis-y-value"),this.linesContainer=this.graph.select(".vzb-lc-lines"),this.labelsContainer=this.graph.select(".vzb-lc-labels"),this.verticalNow=this.labelsContainer.select(".vzb-lc-vertical-now"),this.tooltip=this.element.select(".vzb-tooltip"),this.projectionX=this.graph.select("g").select(".vzb-lc-projection-x"),this.projectionY=this.graph.select("g").select(".vzb-lc-projection-y"),this.entityLines=null,this.entityLabels=null,this.totalLength_1={},this.KEY=this.model.entities.getDimension(),this.on("resize",function(){a.updateSize(),a.updateTime(),a.redrawDataPoints()})},ready:function(){this.updateTime(),this.updateUIStrings(),this.updateShow(),this.updateSize(),this.redrawDataPoints(),this.graph.on("mousemove",this.entityMousemove.bind(this,null,null,this,!0)).on("mouseleave",this.entityMouseout.bind(this,null,null,this))},updateUIStrings:function(){this.translator=this.model.language.getTFunction();var a=this.translator("indicator/"+this.model.marker.axis_x.which),b=this.translator("indicator/"+this.model.marker.axis_y.which),c=this.xTitleEl.selectAll("text").data([0]);c.enter().append("text"),c.attr("text-anchor","end").attr("y","-0.32em").text(a);var d=this.yTitleEl.selectAll("text").data([0]);d.enter().append("text"),d.attr("y","-0px").attr("x","-9px").attr("dy","-0.36em").attr("dx","-0.72em").text(b)},updateShow:function(){var a=this,b=this.KEY;this.cached={},this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.cShadeScale=this.model.marker.color_shadow.getScale(),this.yAxis.tickSize(6,0).tickFormat(this.model.marker.axis_y.tickFormatter),this.xAxis.tickSize(6,0).tickFormat(this.model.marker.axis_x.tickFormatter),this.collisionResolver=d3.svg.collisionResolver().selector(".vzb-lc-label").value("valueY").scale(this.yScale).KEY(b),this.line=d3.svg.line().interpolate("basis").x(function(b){return a.xScale(b[0])}).y(function(b){return a.yScale(b[1])})},updateTime:function(){var a=this.KEY,b=null===this.time?this.model.time.value:this.time;this.time=this.model.time.value,this.duration=this.model.time.playing&&this.time-b>0?.9*this.model.time.speed:0;var c=this.model.time.getDimension(),d={};d[c]=this.time,this.data=this.model.marker.getKeys(d),this.values=this.model.marker.getValues(d,[a]),this.prev_values=this.model.marker.getValues(d,[a],!0),this.entityLines=this.linesContainer.selectAll(".vzb-lc-entity").data(this.data),this.entityLabels=this.labelsContainer.selectAll(".vzb-lc-entity").data(this.data),this.timeUpdatedOnce=!0},updateSize:function(){var a=this,b=this.values,c=this.KEY,d=2;this.profiles={small:{margin:{top:30,right:20,left:55,bottom:30},tick_spacing:60,text_padding:8,lollipopRadius:6,limitMaxTickNumberX:5},medium:{margin:{top:40,right:60,left:55,bottom:40},tick_spacing:80,text_padding:12,lollipopRadius:7,limitMaxTickNumberX:10},large:{margin:{top:50,right:60,left:55,bottom:50},tick_spacing:100,text_padding:20,lollipopRadius:9,limitMaxTickNumberX:0}};var e={small:{margin:{top:9,right:15,bottom:10,left:5}},medium:{margin:{top:9,right:15,bottom:10,left:5}},large:{margin:{top:9,right:15,bottom:10,left:10}}};this.activeProfile=this.profiles[this.getLayoutProfile()],this.margin=this.activeProfile.margin,this.tick_spacing=this.activeProfile.tick_spacing;var f=this.model.marker.getKeys().map(function(a,d){return b.label[a[c]]}),g=0,h=this.linesContainer.selectAll(".samplingView").data(f);h.enter().append("text").attr("class","samplingView vzb-lc-labelName").style("opacity",0).text(function(a){return a.length<13?a:a.substring(0,10)+"..."}).each(function(a){g>this.getComputedTextLength()||(g=this.getComputedTextLength())}).remove(),this.margin.right=Math.max(this.margin.right,g+this.activeProfile.text_padding+20),this.height=parseInt(this.element.style("height"),10)-this.margin.top-this.margin.bottom,this.width=parseInt(this.element.style("width"),10)-this.margin.left-this.margin.right,this.collisionResolver.height(this.height),this.graph.attr("width",this.width+this.margin.right+this.margin.left).attr("height",this.height+this.margin.top+this.margin.bottom).select("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0],d).range(),"ordinal"!==this.model.marker.axis_x.scaleType,this.xScale.range([0,this.width]),this.yAxis.scale(this.yScale).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:{top:0,right:this.margin.right,left:this.margin.left,bottom:this.margin.bottom},limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:this.margin,limitMaxTickNumber:this.activeProfile.limitMaxTickNumberX}),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.xAxisEl.attr("transform","translate(0,"+this.height+")"),this.xValueEl.attr("transform","translate(0,"+this.height+")").attr("y",this.xAxis.tickPadding()+this.xAxis.tickSize()),this.xTitleEl.attr("transform","translate("+this.width+","+this.height+")"),this.verticalNow.attr("y1",this.yScale.range()[0]).attr("y2",this.yScale.range()[1]).attr("x1",0).attr("x2",0),this.projectionX.attr("y1",a.yScale.range()[0]),this.projectionY.attr("x2",a.xScale.range()[0]);var i={rangeMax:this.xScale.range()[1],mRight:this.margin.right,profile:e[this.getLayoutProfile()]};this.parent.trigger("myEvent",i),this.sizeUpdatedOnce=!0},redrawDataPoints:function(){var a=this,b=this.KEY,d=this.values;this.timeUpdatedOnce||this.updateTime(),this.sizeUpdatedOnce||this.updateSize(),this.entityLabels.exit().remove(),this.entityLines.exit().remove(),this.entityLines.enter().append("g").attr("class","vzb-lc-entity").each(function(c,e){var f=d3.select(this),g=a.cScale(d.color[c[b]]),h=a.cShadeScale(d.color_shadow[c[b]]);f.append("path").attr("class","vzb-lc-line-shadow").style("stroke",h).attr("transform","translate(0,2)"),f.append("path").attr("class","vzb-lc-line").style("stroke",g)}),this.entityLabels.enter().append("g").attr("class","vzb-lc-entity").each(function(c,e){var f=d3.select(this),g=a.cScale(d.color[c[b]]),h=a.cShadeScale(d.color_shadow[c[b]]);d.label[c[b]];f.append("circle").attr("class","vzb-lc-circle").style("fill",g).attr("cx",0);var i=f.append("g").attr("class","vzb-lc-label");i.append("text").attr("class","vzb-lc-labelName").style("fill",h).attr("dy",".35em"),i.append("text").attr("class","vzb-lc-labelValue").style("fill",h).attr("dy","1.6em")});var e=this.prev_values;this.entityLines.each(function(f,g){var h=d3.select(this),i=(d.label[f[b]],e.axis_x[f[b]]),j=e.axis_y[f[b]],k=i.map(function(a,b){return[+i[b],+j[b]]});k=k.filter(function(a){return!c.isNaN(a[1])}),a.cached[f[b]]={valueY:k[k.length-1][1]};var l=h.select(".vzb-lc-line-shadow").attr("d",a.line(k)),m=h.select(".vzb-lc-line").attr("d",a.line(k));if(a.model.time.playing){var n=m.node().getTotalLength();null===a.totalLength_1[f[b]]&&(a.totalLength_1[f[b]]=n),l.attr("stroke-dasharray",n).attr("stroke-dashoffset",n-a.totalLength_1[f[b]]).transition().duration(a.duration).ease("linear").attr("stroke-dashoffset",0),m.attr("stroke-dasharray",n).attr("stroke-dashoffset",n-a.totalLength_1[f[b]]).transition().duration(a.duration).ease("linear").attr("stroke-dashoffset",0),a.totalLength_1[f[b]]=n}else a.totalLength_1[f[b]]=null,l.attr("stroke-dasharray","none").attr("stroke-dashoffset","none"),m.attr("stroke-dasharray","none").attr("stroke-dashoffset","none")}),this.entityLabels.each(function(c,e){var f=d3.select(this),g=d.label[c[b]];f.select(".vzb-lc-circle").transition().duration(a.duration).ease("linear").attr("r",a.profiles[a.getLayoutProfile()].lollipopRadius).attr("cy",a.yScale(a.cached[c[b]].valueY)+1),f.select(".vzb-lc-label").transition().duration(a.duration).ease("linear").attr("transform","translate(0,"+a.yScale(a.cached[c[b]].valueY)+")");var h=a.yAxis.tickFormat()(a.cached[c[b]].valueY),i=g.length<13?g:g.substring(0,10)+"...",j=a.ui.entity_labels.min_number_of_entities_when_values_hide,k=f.select(".vzb-lc-labelName").attr("dx",a.activeProfile.text_padding).text(i+" "+(a.data.length<j?h:""));if(f.select(".vzb-lc-labelValue").attr("dx",a.activeProfile.text_padding).text(""),a.data.length<j){var l=a.xScale(a.time)+k[0][0].getComputedTextLength()+a.activeProfile.text_padding,m=a.width+a.margin.right;l>m&&(f.select(".vzb-lc-labelName").text(i),f.select(".vzb-lc-labelValue").text(h))}}),this.labelsContainer.transition().duration(a.duration).ease("linear").attr("transform","translate("+a.xScale(a.time)+",0)"),this.verticalNow.style("opacity",this.time-this.model.time.start===0||a.hoveringNow?0:1),this.hoveringNow||this.xAxisEl.call(this.xAxis.highlightValue(a.time).highlightTransDuration(a.duration)),0==a.duration&&d3.timer.flush(),clearTimeout(a.collisionTimeout),a.collisionTimeout=setTimeout(function(){
a.entityLabels.call(a.collisionResolver.data(a.cached))},1.5*a.model.time.speed)},entityMousemove:function(a,b,d,e){var f=d,g=f.KEY,h=(f.values,d3.mouse(f.graph.node()).map(function(a){return parseInt(a)})),i=f.xScale.invert(h[0]-f.margin.left);f.time-i<0?i=f.time:i<this.model.time.start&&(i=this.model.time.start);var j,k=f.model.time.getDimension();if(e){var l=h[1]-f.margin.bottom,m=this.getValuesForYear(i),n=this.getNearestKey(l,m.axis_y,f.yScale.bind(f));j=m.axis_y[n],a||(a={}),a[g]=n}else{var o={};o[g]=a[g],o[k]=i,j=f.model.marker.axis_y.getValue(o)}if(f.hoveringNow=a,f.graph.selectAll(".vzb-lc-entity").each(function(){d3.select(this).classed("vzb-dimmed",function(a){return a[g]!==f.hoveringNow[g]}).classed("vzb-hovered",function(a){return a[g]===f.hoveringNow[g]})}),!c.isNaN(j)){var p=f.xScale(i),q=f.yScale(j);f.ui.whenHovering.showTooltip&&f.tooltip.style("left",p+f.margin.left+"px").style("bottom",f.height-q+f.margin.bottom+"px").text(f.yAxis.tickFormat()(j)).classed("vzb-hidden",!1),f.ui.whenHovering.hideVerticalNow&&f.verticalNow.style("opacity",0),f.ui.whenHovering.showProjectionLineX&&f.projectionX.style("opacity",1).attr("y2",q).attr("x1",p).attr("x2",p),f.ui.whenHovering.showProjectionLineY&&f.projectionY.style("opacity",1).attr("y1",q).attr("y2",q).attr("x1",p),f.ui.whenHovering.higlightValueX&&f.xAxisEl.call(f.xAxis.highlightValue(i).highlightTransDuration(0)),f.ui.whenHovering.higlightValueY&&f.yAxisEl.call(f.yAxis.highlightValue(j).highlightTransDuration(0)),clearTimeout(f.unhoverTimeout)}},entityMouseout:function(a,b,c){var d=c;d3.select(d3.event.relatedTarget).classed("vzb-tooltip")||(d.unhoverTimeout=setTimeout(function(){d.tooltip.classed("vzb-hidden",!0),d.verticalNow.style("opacity",1),d.projectionX.style("opacity",0),d.projectionY.style("opacity",0),d.xAxisEl.call(d.xAxis.highlightValue(d.time)),d.yAxisEl.call(d.yAxis.highlightValue("none")),d.graph.selectAll(".vzb-lc-entity").each(function(){d3.select(this).classed("vzb-dimmed",!1).classed("vzb-hovered",!1)}),d.hoveringNow=null},300))},getValuesForYear:function(a){return c.isDate(a)||(a=new Date("00:00:00 "+a)),this.model.marker.getValues({time:a},[this.KEY])},getNearestKey:function(a,b,c){for(var d=Object.keys(b),e=d[0],f=1;f<d.length;f++){var g=d[f];Math.abs((c?c(b[g]):b[g])-a)<Math.abs((c?c(b[e]):b[e])-a)&&(e=g)}return e}})}.call(this),function(){"use strict";var a=this,b=a.Vizabi;b.utils;b._require("d3")&&b.Tool.extend("LineChart",{init:function(a,b){this.name="linechart",this.components=[{component:"gapminder-linechart",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"],ui:{show_value_when_drag_play:!1,axis_aligned:!0}},{component:"gapminder-buttonlist",placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]}],this._super(a,b)}})}.call(this),function(){"use strict";var a=this.Vizabi.Tool.get("LineChart");a.define("default_options",{state:{time:{start:1990,end:2012,value:2012,step:1,speed:300,formatInput:"%Y"},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"gdp_per_cap",scaleType:"log"},axis_x:{use:"indicator",which:"time",scaleType:"time"},color:{use:"property",which:"geo.region"},color_shadow:{use:"property",which:"geo.region"}}},data:{reader:"csv-file",path:"local_data/waffles/basic-indicators.csv"},ui:{"vzb-tool-line-chart":{entity_labels:{min_number_of_entities_when_values_hide:2},whenHovering:{hideVerticalNow:0,showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0,showTooltip:0}}}})}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils,c=a.iconset;a._require("d3")&&a.Component.extend("gapminder-mountainchart",{init:function(c,d){var e=this;this.name="mountainchart",this.template="src/tools/mountainchart/mountainchart.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}],this.model_binds={change:function(a){e._readyOnce&&-1!==a.indexOf("change:time")},"change:marker:color:palette":b.debounce(function(a){e.redrawDataPoints(),e.redrawDataPointsOnlyColors(),e.redrawSelectList()},200),"change:time:value":function(){e.updateTime(),e.redrawDataPoints(),e.redrawSelectList(),e.updatePovertyLine(),e._updateDoubtOpacity()},"change:time:povertyCutoff":function(){e.ready()},"change:time:gdpFactor":function(){e.ready()},"change:time:gdpShift":function(){e.ready()},"change:time:povertyFade":function(){e.ready()},"change:time:xPoints":function(){e.ready()},"change:time:record":function(){e.model.time.record?e._export.open(this.element,this.name):e._export.reset()},"change:time:xLogStops":function(){e.updateSize()},"change:entities:highlight":function(){e._readyOnce&&(e.highlightEntities(),e.updateOpacity())},"change:entities:select":function(){e._readyOnce&&(e.selectEntities(),e.redrawSelectList(),e.updateOpacity(),e._updateDoubtOpacity(),e.redrawDataPoints())},"change:time:yMaxMethod":function(){e._adjustMaxY({force:!0}),e.redrawDataPoints()},"change:time:povertyline":function(){e.ready()},"change:marker":function(a){e._readyOnce&&(a.indexOf("min")>-1||a.indexOf("max")>-1)&&(e.updateSize(),e.updateTime(),e._adjustMaxY({force:!0}),e.redrawDataPoints())},"change:marker:group":function(a){e._readyOnce&&"change:marker:group:merge"!==a&&e.ready()},"change:marker:group:merge":function(a){e._readyOnce&&(e.updateTime(),e.redrawDataPoints())},"change:marker:stack":function(a){e._readyOnce&&e.ready()},"change:entities:opacitySelectDim":function(){e.updateOpacity()},"change:entities:opacityRegular":function(){e.updateOpacity()}},this._super(c,d);var f=a.Helper.get("gapminder-mountainchart-math"),g=a.Helper.get("gapminder-svgexport");this._math=new f(this),this._export=new g(this),this._export.prefix("vzb-mc-").deleteClasses(["vzb-mc-mountains-mergestacked","vzb-mc-mountains-mergegrouped","vzb-mc-mountains","vzb-mc-year","vzb-mc-mountains-labels","vzb-mc-axis-labels"]),this.xScale=null,this.yScale=null,this.cScale=null,this.xAxis=d3.svg.axisSmart(),this.cached={},this.mesh=[],this.yMax=0,this.rescale=function(a){return Math.exp(e.model.time.gdpFactor*Math.log(a)+e.model.time.gdpShift)},this.unscale=function(a){return Math.exp((Math.log(a)-e.model.time.gdpShift)/e.model.time.gdpFactor)},this.area=d3.svg.area().interpolate("basis").x(function(a){return Math.round(e.xScale(e.rescale(a.x)))}).y0(function(a){return Math.round(e.yScale(a.y0))}).y1(function(a){return Math.round(e.yScale(a.y0+a.y))}),this.stack=d3.layout.stack().order("reverse").values(function(a){return e.cached[a.KEY()]}).out(function(a,b,c){a.y0=b})},domReady:function(){var a=this;this.element=d3.select(this.element),this.graph=this.element.select(".vzb-mc-graph"),this.xAxisEl=this.graph.select(".vzb-mc-axis-x"),this.xTitleEl=this.graph.select(".vzb-mc-axis-x-title"),this.yTitleEl=this.graph.select(".vzb-mc-axis-y-title"),this.infoEl=this.graph.select(".vzb-mc-axis-info"),this.dataWarningEl=this.graph.select(".vzb-data-warning"),this.yearEl=this.graph.select(".vzb-mc-year"),this.mountainMergeStackedContainer=this.graph.select(".vzb-mc-mountains-mergestacked"),this.mountainMergeGroupedContainer=this.graph.select(".vzb-mc-mountains-mergegrouped"),this.mountainAtomicContainer=this.graph.select(".vzb-mc-mountains"),this.mountainLabelContainer=this.graph.select(".vzb-mc-mountains-labels"),this.tooltip=this.element.select(".vzb-mc-tooltip"),this.eventAreaEl=this.element.select(".vzb-mc-eventarea"),this.povertylineEl=this.element.select(".vzb-mc-povertyline"),this.povertylineLineEl=this.povertylineEl.select("line"),this.povertylineTextEl=this.povertylineEl.selectAll("text"),this.element.onTap(function(b,c){a._interact()._mouseout(b,c)})},afterPreload:function(){var a=this,b=a.model.time.value.getFullYear(),c=a.model.time.end.getFullYear();if(this.precomputedShapes&&this.precomputedShapes[b]&&this.precomputedShapes[c]){var d=this.precomputedShapes["immediate"==this.model.time.yMaxMethod?b:c].yMax,e=this.precomputedShapes[b].shape;d&&e&&0!==e.length&&(this.xScale=d3.scale.log().domain([this.model.marker.axis_x.min,this.model.marker.axis_x.max]),this.yScale=d3.scale.linear().domain([0,+d]),a.updateSize(e.length),e=e.map(function(b,c){return{x:a.mesh[c],y0:0,y:+b}}),this.mountainAtomicContainer.selectAll(".vzb-mc-prerender").data([0]).enter().append("path").attr("class","vzb-mc-prerender").style("fill","pink").style("opacity",0).attr("d",a.area(e)).transition().duration(1e3).ease("linear").style("opacity",1))}},readyOnce:function(){this.eventAreaEl.on("mousemove",function(){if(!a.model.time.dragging){var b=d3.mouse(a.graph.node()).map(function(a){return parseInt(a)});a.updatePovertyLine({level:a.xScale.invert(b[0]),full:!0})}}).on("mouseout",function(){if(!a.model.time.dragging){d3.mouse(a.graph.node()).map(function(a){return parseInt(a)});a.updatePovertyLine()}});var a=this;this.on("resize",function(){a.updateSize(),a.updateTime(),a.redrawDataPoints(),a.redrawSelectList(),a.updatePovertyLine()}),this.KEY=this.model.entities.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.mountainAtomicContainer.select(".vzb-mc-prerender").remove(),this.wScale=d3.scale.linear().domain(this.parent.datawarning_content.doubtDomain).range(this.parent.datawarning_content.doubtRange)},ready:function(){this.updateUIStrings(),this.updateIndicators(),this.updateEntities(),this.updateSize(),this._spawnMasks(),this.updateTime(),this._adjustMaxY({force:!0}),this.redrawDataPoints(),this.redrawDataPointsOnlyColors(),this.highlightEntities(),this.selectEntities(),this.redrawSelectList(),this.updateOpacity(),this._updateDoubtOpacity(),this.updatePovertyLine()},updateUIStrings:function(){var b=this;this.translator=this.model.language.getTFunction();var d=a._globals.metadata.indicatorsDB[this.model.marker.axis_x.which];this.xTitleEl.select("text").text(this.translator("unit/mountainchart_hardcoded_income_per_day")),this.yTitleEl.select("text").text(this.translator("mount/title")),this.dataWarningEl.html(c.warn).select("svg").attr("width","0px").attr("height","0px"),this.dataWarningEl.append("text").text(this.translator("hints/dataWarning")),this.infoEl.on("click",function(){window.open(d.sourceLink,"_blank").focus()}),this.dataWarningEl.on("click",function(){b.parent.findChildByName("gapminder-datawarning").toggle()}).on("mouseover",function(){b._updateDoubtOpacity(1)}).on("mouseout",function(){b._updateDoubtOpacity()})},_updateDoubtOpacity:function(a){null==a&&(a=this.wScale(+this.time.getFullYear().toString())),this.someSelected&&(a=1),this.dataWarningEl.style("opacity",a)},updateIndicators:function(){var a=this;this.yScale=this.model.marker.axis_y.getScale(),this.xScale=this.model.marker.axis_x.getScale(),this.cScale=this.model.marker.color.getScale(),this.xAxis.tickFormat(a.model.marker.axis_x.tickFormatter)},updateEntities:function(){var a=this,c={};c[a.TIMEDIM]=this.model.time.end,this.values=this.model.marker.getValues(c,[a.KEY]),this.mountainPointers=this.model.marker.getKeys().map(function(b){var c={};return c[a.KEY]=b[a.KEY],c.KEY=function(){return this[a.KEY]},c.sortValue=[a.values.axis_y[c.KEY()],0],c.aggrLevel=0,c}),this.groupedPointers=d3.nest().key(function(b){return"property"===a.model.marker.stack.use?a.values.stack[b.KEY()]:a.values.group[b.KEY()]}).sortValues(function(a,b){return b.sortValue[0]-a.sortValue[0]}).entries(this.mountainPointers);var d=this.model.marker.group.manualSorting;this.groupedPointers.forEach(function(b){var c=d3.sum(b.values.map(function(a){return a.sortValue[0]}));d&&d.length>1&&(c=d.indexOf(b.key)),b.values.forEach(function(a){a.sortValue[1]=c}),b[a.model.entities.getDimension()]=b.key,b.KEY=function(){return this.key},b.aggrLevel=1});var e={};a.groupedPointers.map(function(a){e[a.key]=a.values[0].sortValue[1]}),"none"===a.model.marker.stack.which?(this.stackedPointers=[],this.mountainPointers.sort(function(a,b){return b.sortValue[0]-a.sortValue[0]})):(this.stackedPointers=d3.nest().key(function(b){return a.values.stack[b.KEY()]}).key(function(b){return a.values.group[b.KEY()]}).sortKeys(function(a,b){return e[b]-e[a]}).sortValues(function(a,b){return b.sortValue[0]-a.sortValue[0]}).entries(this.mountainPointers),this.mountainPointers.sort(function(a,b){return b.sortValue[1]-a.sortValue[1]}),this.stackedPointers.forEach(function(b){b.KEY=function(){return this.key},b[a.model.entities.getDimension()]=b.key,b.aggrLevel=2})),this.mountainsMergeStacked=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel2").data(this.stackedPointers),this.mountainsMergeGrouped=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel1").data(this.groupedPointers),this.mountainsAtomic=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain.vzb-mc-aggrlevel0").data(this.mountainPointers),this.mountainsMergeStacked.exit().remove(),this.mountainsMergeGrouped.exit().remove(),this.mountainsAtomic.exit().remove(),this.mountainsMergeStacked.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel2"),this.mountainsMergeGrouped.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel1"),this.mountainsAtomic.enter().append("path").attr("class","vzb-mc-mountain vzb-mc-aggrlevel0"),this.mountains=this.mountainAtomicContainer.selectAll(".vzb-mc-mountain"),this.mountains.on("mousemove",function(c,d){b.isTouchDevice()||a._interact()._mousemove(c,d)}).on("mouseout",function(c,d){b.isTouchDevice()||a._interact()._mouseout(c,d)}).on("click",function(c,d){b.isTouchDevice()||a._interact()._click(c,d)}).onTap(function(b,c){a._interact()._mouseout(b,c),a._interact()._mousemove(b,c),a.tooltip.classed("vzb-hidden",!1).html(a.tooltip.html()+"<br>Hold to select it"),d3.event.stopPropagation()}).onLongTap(function(b,c){a._interact()._mouseout(b,c),a._interact()._click(b,c),d3.event.stopPropagation()})},_interact:function(){var a=this;return{_mousemove:function(b,c){if(!a.model.time.dragging){a.model.entities.highlightEntity(b);d3.mouse(a.graph.node()).map(function(a){return parseInt(a)});a._setTooltip(b.key?a.translator("region/"+b.key):a.model.marker.label.getValue(b))}},_mouseout:function(b,c){a.model.time.dragging||(a._setTooltip(""),a.model.entities.clearHighlighted())},_click:function(b,c){a.model.entities.selectEntity(b)}}},highlightEntities:function(){var a=this;this.someHighlighted=this.model.entities.highlight.length>0,this.selectList&&this.someSelected&&this.selectList.classed("vzb-highlight",function(b){return a.model.entities.isHighlighted(b)})},selectEntities:function(){var a=this;this.someSelected=this.model.entities.select.length>0;var c=this.mountainPointers.concat(this.groupedPointers).concat(this.stackedPointers).filter(function(b){return a.model.entities.isSelected(b)}).sort(function(a,b){return b.yMax&&a.yMax?b.yMax-a.yMax:b.sortValue[0]-a.sortValue[0]});this.selectList=this.mountainLabelContainer.selectAll("g").data(b.unique(c,function(a){return a.KEY()})),this.selectList.exit().remove(),this.selectList.enter().append("g").attr("class","vzb-mc-label").each(function(a,b){d3.select(this).append("circle"),d3.select(this).append("text").attr("class","vzb-mc-label-shadow"),d3.select(this).append("text")}).on("mousemove",function(b,c){a.model.entities.highlightEntity(b)}).on("mouseout",function(b,c){a.model.entities.clearHighlighted()}).on("click",function(b,c){a.model.entities.clearHighlighted(),a.model.entities.selectEntity(b)})},_sumLeafPointersByMarker:function(a,b){var c=this;return a.key?d3.sum(a.values.map(function(a){return c._sumLeafPointersByMarker(a,b)})):c.values[b][a.KEY()]},redrawSelectList:function(){var a=this;if(this.selectList&&this.someSelected){var b=this.mountainLabelContainer.append("g").attr("class","vzb-mc-label").append("text").text("0"),c=b[0][0].getBBox().height;d3.select(b[0][0].parentNode).remove();var d=a.model.marker.axis_y.tickFormatter,e=this.yTitleEl.select("text").node().getBBox().height||0,f=(this.height-3*e)/(this.selectList.data().length+2);c>f&&(c=f),this.selectList.attr("transform",function(a,b){return"translate(0,"+(c*b+3*e)+")"}).each(function(b,e){var g=d3.select(this),h=b.key?a.translator("region/"+b.key):a.values.label[b.KEY()],i=a.values.axis_y[b.KEY()],j=h+": "+d(i)+(0===e?" people":"");g.select("circle").attr("r",c/3).attr("cx",.4*c).attr("cy",c/1.5).style("fill",a.cScale(a.values.color[b.KEY()])),g.selectAll("text").attr("x",c).attr("y",c).text(j).style("font-size",c===f?c:null)})}},updateOpacity:function(){var a=this,b=1,c=.3,d=1,e=this.model.entities.opacityRegular,f=this.model.entities.opacitySelectDim;this.mountains.style("opacity",function(g){return a.someHighlighted&&a.model.entities.isHighlighted(g)?b:a.someSelected?a.model.entities.isSelected(g)?d:f:a.someHighlighted?c:e}),this.mountains.classed("vzb-selected",function(b){return a.model.entities.isSelected(b)});var g=a.someSelected&&a.model.entities.opacitySelectDim<.01;g!==this.someSelectedAndOpacityZero_1&&this.mountainsAtomic.style("pointer-events",function(b){return!g||a.model.entities.isSelected(b)?"visible":"none"}),this.someSelectedAndOpacityZero_1=a.someSelected&&a.model.entities.opacitySelectDim<.01},updateTime:function(a){var b=this;this.time=this.model.time.value,null==a&&(a=this.time),this.yearEl.text(a.getFullYear().toString());var c={};c[b.TIMEDIM]=a,this.values=this.model.marker.getValues(c,[b.KEY]),this.yMax=0,this.mountainPointers.forEach(function(a,c){var d=b._spawn(b.values,a);b.cached[a.KEY()]=d,a.hidden=0===d.length}),"none"!==b.model.marker.stack.which&&this.stackedPointers.forEach(function(a){var c=[];a.values.forEach(function(a){c=c.concat(a.values.filter(function(a){return!a.hidden}))}),b.stack(c)}),this.mountainPointers.forEach(function(a){a.yMax=d3.max(b.cached[a.KEY()].map(function(a){return a.y0+a.y})),b.yMax<a.yMax&&(b.yMax=a.yMax)});var d=b.model.marker.group.merge,e=b.model.marker.stack.merge;(b.model.time.dragging||b.model.time.playing)&&"none"!==this.model.marker.stack.which;this.stackedPointers.forEach(function(a){var c=b._getFirstLastPointersInStack(a);b.cached[a.key]=b._getVerticesOfaMergedShape(c),b.values.color[a.key]="_default",b.values.axis_y[a.key]=b._sumLeafPointersByMarker(a,"axis_y"),a.yMax=c.first.yMax}),this.groupedPointers.forEach(function(a){var c=b._getFirstLastPointersInStack(a);b.cached[a.key]=b._getVerticesOfaMergedShape(c),b.values.color[a.key]=b.values.color[c.first.KEY()],b.values.axis_y[a.key]=b._sumLeafPointersByMarker(a,"axis_y"),a.yMax=c.first.yMax}),e||d||"property"!==this.model.marker.stack.use||this.groupedPointers.forEach(function(a){var b=a.values.filter(function(a){return!a.hidden});a.yMax=b[0].yMax,a.values.forEach(function(b){b.yMaxGroup=a.yMax})})},_getFirstLastPointersInStack:function(a){var b,c;if(a.values[0].values){b=a.values[0].values.filter(function(a){return!a.hidden}),c=a.values[a.values.length-1].values.filter(function(a){return!a.hidden});var d=b[0],e=c[c.length-1]}else{b=a.values.filter(function(a){return!a.hidden});var d=b[0],e=b[b.length-1]}return{first:d,last:e}},_getVerticesOfaMergedShape:function(a){var b=this,c=a.first.KEY(),d=a.last.KEY();return b.mesh.map(function(a,e){var f=b.cached[c][e].y0+b.cached[c][e].y-b.cached[d][e].y0,g=b.cached[d][e].y0;return{x:a,y0:g,y:f}})},updateSize:function(a){var b;switch(this.getLayoutProfile()){case"small":b={top:10,right:10,left:10,bottom:25};break;case"medium":b={top:20,right:20,left:20,bottom:30};break;case"large":b={top:30,right:30,left:30,bottom:35}}this.height=parseInt(this.element.style("height"),10)-b.top-b.bottom,this.width=parseInt(this.element.style("width"),10)-b.left-b.right,this.graph.attr("transform","translate("+b.left+","+b.top+")"),this.yearEl.attr("x",this.width/2).attr("y",this.height/3*1.5).style("font-size",Math.max(this.height/4,this.width/4)+"px"),this.yScale.range([this.height,0]),this.xScale.range([0,this.width]);var c=this._readyOnce?this.model.marker.axis_x.scaleType:"log";this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:c,toolMargin:b,method:this.xAxis.METHOD_REPEATING,stops:this._readyOnce?this.model.time.xLogStops:[1]}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.xTitleEl.select("text").attr("transform","translate("+this.width+","+this.height+")").attr("dy","-0.36em"),this.yTitleEl.select("text").attr("transform","translate(0,"+b.top+")");var d=this.dataWarningEl.select("text").node().getBBox();if(this.dataWarningEl.select("svg").attr("width",d.height).attr("height",d.height).attr("x",.1*d.height).attr("y",1*-d.height+1),this.dataWarningEl.attr("transform","translate(0,"+(b.top+1.5*d.height)+")").select("text").attr("dx",1.5*d.height),this.infoEl.select("text").node()){var e=this.infoEl.select("text").node().getBBox().height||0,f=this.yTitleEl.select("text").node().getBBox().width||0;this.infoEl.attr("transform","translate("+(f+1*e)+","+(b.top-.3*e)+")"),this.infoEl.select("text").attr("dy","0.1em"),this.infoEl.select("circle").attr("r",e/2)}this.eventAreaEl.attr("y",this.height).attr("width",this.width).attr("height",b.bottom),this._generateMesh(a,c)},_generateMesh:function(a,b){a||(a=this.model.time.xPoints);var c="linear"===b?this.xScale.domain()[0]:Math.log(this.unscale(this.xScale.domain()[0])),d="linear"===b?this.xScale.domain()[1]:Math.log(this.unscale(this.xScale.domain()[1])),e=(d-c)/a;return this.mesh=d3.range(c,d,e).concat(d),"linear"!==b?this.mesh=this.mesh.map(function(a){return Math.exp(a)}):this.mesh=this.mesh.filter(function(a){return a>0}),this.mesh},_spawnMasks:function(){var a=this,b=this.unscale(this.model.time.povertyline),c=this.unscale(this.model.time.povertyCutoff),d=this.model.time.povertyFade,e=2*Math.PI/(Math.log(b)-Math.log(c)),f=Math.PI-Math.log(b)*e;this.spawnMask=[],this.cosineShape=[],this.cosineArea=0,this.mesh.map(function(g,h){a.spawnMask[h]=c>g?1:g>7*d?0:Math.exp((c-g)/d),a.cosineShape[h]=g>c&&b>g?1+Math.cos(Math.log(g)*e+f):0,a.cosineArea+=a.cosineShape[h]})},_spawn:function(a,b){var c=this,d=a.axis_y[b.KEY()],e=c._math.giniToSigma(a.size[b.KEY()]),f=c._math.gdpToMu(a.axis_x[b.KEY()],e);if(!d||!f||!e)return[];var g=[],h=0;this.mesh.map(function(a,b){g[b]=c._math.pdf.lognormal(a,f,e),h+=c.spawnMask[b]*g[b]});var i=this.mesh.map(function(a,b){return{x:a,y0:0,y:d*(g[b]*(1-c.spawnMask[b])+c.cosineShape[b]/c.cosineArea*h)}});return i},_adjustMaxY:function(a){a||(a={});var c=this,d=this.model.time.yMaxMethod;("immediate"===d||a.force)&&("latest"===d&&c.updateTime(c.model.time.end),c.yMax||b.warn("Setting yMax to "+c.yMax+". You failed again :-/"),this.yScale.domain([0,c.yMax]),"latest"===d&&c.updateTime())},updatePovertyLine:function(a){var b=this;if(a||(a={}),a.level||(a.level=this.model.time.povertyline),this.povertylineEl.classed("vzb-hidden",!a.level),a.level){this.xAxisEl.call(this.xAxis.highlightValue(a.full?a.level:"none"));var c=0,d=0,e=0,f=function(f){c+=b.values.axis_y[f.KEY()],b.cached[f.KEY()].forEach(function(c){d+=c.y,b.rescale(c.x)<a.level&&(e+=c.y)})};"all"===this.model.marker.stack.which?this.stackedPointers.forEach(f):"none"===this.model.marker.stack.which?this.mountainPointers.forEach(f):this.groupedPointers.forEach(f);var g=d3.format(".3r"),h=b.model.marker.axis_y.tickFormatter;this.heightOfLabels=this.heightOfLabels||.66*this.height,this.povertylineTextEl.each(function(c,d){if(8===d){var e=d3.select(this);e.text(b.translator("mount/extremepoverty")).classed("vzb-hidden",a.full).attr("x",-b.height).attr("y",b.xScale(a.level)).attr("dy","-1em").attr("dx","0.5em").attr("transform","rotate(-90)"),a.full||(b.heightOfLabels=b.height-e.node().getBBox().width-2*e.node().getBBox().height)}}),this.povertylineTextEl.each(function(f,i){if(8!==i){var j,k=d3.select(this);(0===i||4===i)&&(j=g(e/d*100)+"%"),(1===i||5===i)&&(j=g(100-e/d*100)+"%"),(2===i||6===i)&&(j=h(c*e/d)),(3===i||7===i)&&(j=h(c*(1-e/d))+" "+b.translator("mount/people")),k.text(j).classed("vzb-hidden",!a.full&&0!==i&&4!==i).attr("x",b.xScale(a.level)+([0,4,2,6].indexOf(i)>-1?-5:5)).attr("y",b.heightOfLabels).attr("dy",[0,1,4,5].indexOf(i)>-1?0:"1.5em")}}),this.povertylineLineEl.attr("x1",this.xScale(a.level)).attr("x2",this.xScale(a.level)).attr("y1",this.height+6).attr("y2",0)}},redrawDataPoints:function(){var a=this,b=a.model.marker.group.merge,c=a.model.marker.stack.merge,d=(a.model.time.dragging||a.model.time.playing)&&"none"!==this.model.marker.stack.which,e=a.model.marker.stack.which;this._adjustMaxY(),this.mountainsMergeStacked.each(function(b){var d=d3.select(this),e=!c;a._renderShape(d,b.KEY(),e)}),this.mountainsMergeGrouped.each(function(e){var f=d3.select(this),g=!b&&!d||c&&!a.model.entities.isSelected(e);a._renderShape(f,e.KEY(),g)}),this.mountainsAtomic.each(function(e,f){var g=d3.select(this),h=e.hidden||(b||c||d)&&!a.model.entities.isSelected(e);a._renderShape(g,e.KEY(),h)}),"none"===e?this.mountainsAtomic.sort(function(a,b){return b.yMax-a.yMax}):"all"===e||(b||d?this.mountainsMergeGrouped.sort(function(a,b){return b.yMax-a.yMax}):this.mountainsAtomic.sort(function(a,b){return b.yMaxGroup-a.yMaxGroup}))},redrawDataPointsOnlyColors:function(){var a=this;this.mountains.style("fill",function(b){return a.cScale(a.values.color[b.KEY()])})},_renderShape:function(a,b,c){var d=this.model.marker.stack.which;return a.classed("vzb-hidden",c),c?void("none"!==d&&a.style("stroke-opacity",0)):(this.model.entities.isSelected({geo:b})?a.attr("d",this.area(this.cached[b].filter(function(a){return a.y>1e6}))):a.attr("d",this.area(this.cached[b])),"indicator"===this.model.marker.color.use&&a.style("fill",this.cScale(this.values.color[b])),"none"!==d&&a.transition().duration(900*Math.random()+100).ease("circle").style("stroke-opacity",.5),void(this.model.time.record&&this._export.write({type:"path",id:b,time:this.model.time.value.getFullYear(),fill:this.cScale(this.values.color[b]),d:this.area(this.cached[b])})))},_setTooltip:function(a,b,c){if(a){var d=d3.mouse(this.graph.node()).map(function(a){return parseInt(a)});this.tooltip.classed("vzb-hidden",!1).attr("transform","translate("+(b?b:d[0]-15)+","+(c?c:d[1]-15)+")").selectAll("text").text(a);var e=this.tooltip.select("text")[0][0].getBBox();this.tooltip.select("rect").attr("width",e.width+8).attr("height",e.height+8).attr("x",-e.width-4).attr("y",-e.height-1).attr("rx",.2*e.height).attr("ry",.2*e.height)}else this.tooltip.classed("vzb-hidden",!0)}})}.call(this),function(){var a=this.Vizabi;a.utils;a.Helper.extend("gapminder-mountainchart-math",{init:function(a){this.context=a},gdpToMu:function(a,b,c,d){return Math.log(a/365)-b*b/2},giniToSigma:function(a){return this.normsinv((a/100+1)/2)*Math.pow(2,.5)},pdf:{normal:function(a,b,c){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(c)-Math.pow(a-b,2)/(2*c*c))},lognormal:function(a,b,c){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(c)-Math.pow(Math.log(a)-b,2)/(2*c*c))}},normsinv:function(a){var b=[-39.69683028665376,220.9460984245205,-275.9285104469687,138.357751867269,-30.66479806614716,2.506628277459239],c=[-54.47609879822406,161.5858368580409,-155.6989798598866,66.80131188771972,-13.28068155288572],d=[-.007784894002430293,-.3223964580411365,-2.400758277161838,-2.549732539343734,4.374664141464968,2.938163982698783],e=[.007784695709041462,.3224671290700398,2.445134137142996,3.754408661907416],f=.02425,g=1-f;if(f>a){var h=Math.sqrt(-2*Math.log(a));return(((((d[0]*h+d[1])*h+d[2])*h+d[3])*h+d[4])*h+d[5])/((((e[0]*h+e[1])*h+e[2])*h+e[3])*h+1)}if(a>g){var h=Math.sqrt(-2*Math.log(1-a));return-(((((d[0]*h+d[1])*h+d[2])*h+d[3])*h+d[4])*h+d[5])/((((e[0]*h+e[1])*h+e[2])*h+e[3])*h+1)}var h=a-.5,i=h*h;return(((((b[0]*i+b[1])*i+b[2])*i+b[3])*i+b[4])*i+b[5])*h/(((((c[0]*i+c[1])*i+c[2])*i+c[3])*i+c[4])*i+1)}})}.call(this),function(){"use strict";var a=this.Vizabi;a.utils;if(a._require("d3")){a.Tool.extend("MountainChart",{init:function(a,b){this.name="mountainchart",this.components=[{component:"gapminder-mountainchart",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:"gapminder-buttonlist",placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]},{component:"gapminder-datawarning",placeholder:".vzb-tool-datawarning",model:["language"]}],this._super(a,b)}})}}.call(this),function(){"use strict";var a=this.Vizabi,b=a.utils;a._require("d3")&&a.Component.extend("gapminder-popbyage",{init:function(a,b){this.name="popbyage",this.template="src/tools/popbyage/popbyage.html",this.model_expects=[{name:"time",type:"time"},{name:"entities",type:"entities"},{name:"age",type:"entities"},{name:"marker",type:"model"},{name:"language",type:"language"}];var c=this;this.model_binds={"change:time:value":function(a){c._updateEntities()},"change:entities:needUpdate":function(a){c._updateEntities()},"change:entities:show":function(a){console.log("Trying to change show")},"change:age:select":function(a){c._selectBars()}},this._super(a,b),this.xScale=null,this.yScale=null,this.cScale=d3.scale.category10(),this.xAxis=d3.svg.axisSmart(),this.yAxis=d3.svg.axisSmart()},readyOnce:function(){this.element=d3.select(this.element),this.graph=this.element.select(".vzb-bc-graph"),this.yAxisEl=this.graph.select(".vzb-bc-axis-y"),this.xAxisEl=this.graph.select(".vzb-bc-axis-x"),this.yTitleEl=this.graph.select(".vzb-bc-axis-y-title"),this.bars=this.graph.select(".vzb-bc-bars"),this.labels=this.graph.select(".vzb-bc-labels"),this.title=this.element.select(".vzb-bc-title"),this.year=this.element.select(".vzb-bc-year"),this.model.age.selectMultiple(!0);var a=this;this.on("resize",function(){a._updateEntities()})},ready:function(){this.AGEDIM=this.model.age.getDimension(),this.TIMEDIM=this.model.time.getDimension(),this.timeFormatter=d3.time.format(this.model.time.formatOutput),this.updateUIStrings(),this._updateIndicators(),this.resize(),this._updateEntities(),this._updateEntities()},updateUIStrings:function(){this.translator=this.model.language.getTFunction();var a=this.translator("indicator/"+this.model.marker.axis_y.which),b=this.yTitleEl.selectAll("text").data([0]);b.enter().append("text"),b.attr("y","-6px").attr("x","-9px").attr("dx","-0.72em").text(a)},_updateIndicators:function(){var a=this;this.duration=this.model.time.speed,this.yScale=this.model.marker.axis_y.getScale({max:!0}),this.xScale=this.model.marker.axis_x.getScale(!1),this.cScale=this.model.marker.color.getScale(),this.yAxis.tickFormat(a.model.marker.axis_y.tickFormatter),this.xAxis.tickFormat(a.model.marker.axis_x.tickFormatter)},_updateEntities:function(){var a=this,c=this.model.time,d=d3.time.format(this.model.time.formatInput),e=this.AGEDIM,f=this.TIMEDIM,g=c.playing?c.speed:0,h={};h[f]=c.value;var i=this.model.marker.getKeys(h),j=this.model.marker.getValues(h,[e]),k=function(a){return parseInt(a,10)%l===1},l=this.model.marker.group_by;if(l>1){i=i.filter(function(a){return k(a[e])});var m={};b.forEach(j,function(a,c){m[c]={};var d=m[c],e=!1;b.forEach(a,function(a,f){(k(f)||e===!1)&&(e=f,d[e]=a),b.isNaN(a)||"axis_x"!==c||(d[e]=parseFloat(d[e])+parseFloat(a))})}),j=m}this.model.age.setVisible(i),this.entityBars=this.bars.selectAll(".vzb-bc-bar").data(i),this.entityLabels=this.labels.selectAll(".vzb-bc-label").data(i),this.entityBars.exit().remove(),this.entityLabels.exit().remove();var n=this._highlightBar.bind(this),o=this._unhighlightBars.bind(this);this.entityBars.enter().append("g").attr("class","vzb-bc-bar").attr("id",function(a){return"vzb-bc-bar-"+a[e]}).on("mousemove",n).on("mouseout",o).on("click",function(b,c){a.model.age.selectEntity(b)}).append("rect"),this.entityLabels.enter().append("g").attr("class","vzb-bc-label").attr("id",function(a){return"vzb-bc-label-"+a[e]}).on("mousemove",n).on("mouseout",o).append("text").attr("class","vzb-bc-age"),this.barHeight=this.height/i.length,this.bars.selectAll(".vzb-bc-bar > rect").attr("fill",function(b){
return a._temporaryBarsColorAdapter(j,b,e)}).style("stroke",function(b){return a._temporaryBarsColorAdapter(j,b,e)}).attr("x",0).transition().duration(g).ease("linear").attr("y",function(b){return a.yScale(j.axis_y[b[e]])-a.barHeight}).attr("height",this.barHeight).attr("width",function(b){return a.xScale(j.axis_x[b[e]])}),this.labels.selectAll(".vzb-bc-label > .vzb-bc-age").text(function(b){var f=a.model.marker.axis_x.tickFormatter,g=a.translator("popbyage/yearOldsIn"),h=parseInt(j.axis_y[b[e]],10);return l>1&&(h=h+"-to-"+(h+l-1)),h+g+" "+d(c.value)+": "+f(j.axis_x[b[e]])}).attr("x",7).attr("y",function(b){return a.yScale(j.axis_y[b[e]])-a.barHeight-10}).style("fill",function(b){var c=a.cScale(j.color[b[e]]);return d3.rgb(c).darker(2)});var p=b.values(j.label_name).reverse()[0];p="usa"===p?"United States":"Sweden",this.title.text(p),this.year.text(this.timeFormatter(this.model.time.value));var q=this.xScale.domain(),r=Math.max.apply(null,b.values(j.axis_x));this.xScale=this.xScale.domain([q[0],r]),this.resize()},_temporaryBarsColorAdapter:function(a,b,c){return"time"!=this.model.marker.color.scaleType?this.cScale(b[c]):this.cScale(a.color[b[c]])},_unhighlightBars:function(){this.bars.classed("vzb-dimmed",!1),this.bars.selectAll(".vzb-bc-bar.vzb-hovered").classed("vzb-hovered",!1),this.labels.selectAll(".vzb-hovered").classed("vzb-hovered",!1)},_highlightBar:function(a){this.bars.classed("vzb-dimmed",!0);var b=this.bars.select("#vzb-bc-bar-"+a[this.AGEDIM]);b.classed("vzb-hovered",!0);var c=this.labels.select("#vzb-bc-label-"+a[this.AGEDIM]);c.classed("vzb-hovered",!0)},_selectBars:function(){var a=this,c=this.AGEDIM,d=this.model.age.select;this._unselectBars(),d.length&&(this.bars.classed("vzb-dimmed-selected",!0),b.forEach(d,function(b){a.bars.select("#vzb-bc-bar-"+b[c]).classed("vzb-selected",!0),a.labels.select("#vzb-bc-label-"+b[c]).classed("vzb-selected",!0)}))},_unselectBars:function(){this.bars.classed("vzb-dimmed-selected",!1),this.bars.selectAll(".vzb-bc-bar.vzb-selected").classed("vzb-selected",!1),this.labels.selectAll(".vzb-selected").classed("vzb-selected",!1)},resize:function(){var a=this;this.profiles={small:{margin:{top:70,right:20,left:40,bottom:40},minRadius:2,maxRadius:40},medium:{margin:{top:80,right:60,left:60,bottom:40},minRadius:3,maxRadius:60},large:{margin:{top:100,right:60,left:60,bottom:40},minRadius:4,maxRadius:80}},this.activeProfile=this.profiles[this.getLayoutProfile()];var b=this.activeProfile.margin;this.height=parseInt(this.element.style("height"),10)-b.top-b.bottom,this.width=parseInt(this.element.style("width"),10)-b.left-b.right,this.graph.attr("transform","translate("+b.left+","+b.top+")"),"ordinal"!==this.model.marker.axis_y.scaleType?this.yScale.range([this.height,0]):this.yScale.rangePoints([this.height,0]).range(),"ordinal"!==this.model.marker.axis_x.scaleType?this.xScale.range([0,this.width]):this.xScale.rangePoints([0,this.width]).range(),this.yAxis.scale(this.yScale).orient("left").tickSize(6,6).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_y.scaleType,toolMargin:b,limitMaxTickNumber:6}),this.xAxis.scale(this.xScale).orient("bottom").tickSize(6,0).tickSizeMinor(3,0).labelerOptions({scaleType:this.model.marker.axis_x.scaleType,toolMargin:b,limitMaxTickNumber:6}),this.xAxisEl.attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.yAxisEl.call(this.yAxis),this.xAxisEl.call(this.xAxis),this.title.attr("x",b.right).attr("y",b.top/2),this.year.attr("x",this.width+b.left).attr("y",b.top/2),this.yAxisEl.selectAll('g[class="tick"]').attr("transform",function(b){var c=a.yScale(b)-a.barHeight/2;return isNaN(c)&&(c=0),"translate(0,"+c+")"})}})}.call(this),function(){"use strict";var a=this.Vizabi;a.utils;if(a._require("d3")){a.Tool.extend("PopByAge",{init:function(a,b){this.name="popbyage",this.components=[{component:"gapminder-popbyage",placeholder:".vzb-tool-viz",model:["state.time","state.entities","state.entities_age","state.marker","language"]},{component:"gapminder-timeslider",placeholder:".vzb-tool-timeslider",model:["state.time"]},{component:"gapminder-buttonlist",placeholder:".vzb-tool-buttonlist",model:["state","ui","language"]}],this._super(a,b)},validate:function(a){a=this.model||a;var b=a.state.time,c=a.state.marker.label;if(c.getKeys()&&!(c.getKeys().length<1)){var d=c.getLimits(b.getDimension()).min,e=c.getLimits(b.getDimension()).max;b.start<d&&(b.start=d),b.end>e&&(b.end=e)}}})}}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.axisSmart=function(){return function a(b){function c(a,b,c){return c.indexOf(a)===b}function d(a){if(null!=o)return void d.highlightValueRun(a);var c=a.append("g").attr("class","tick widthSampling"),e=c.append("text").text("0");u.cssMarginTop=e.style("margin-top"),u.cssMarginBottom=e.style("margin-bottom"),u.cssMarginLeft=e.style("margin-left"),u.cssMarginRight=e.style("margin-right"),u.widthOfOneDigit=e[0][0].getBBox().width,u.heightOfOneDigit=e[0][0].getBBox().height,c.remove(),d.labelFactory(u),b(u.transitionDuration>0?a.transition().duration(u.transitionDuration):a);var f="top"==d.orient()||"bottom"==d.orient()?i:h,g=f==i&&d.pivot()||f==h&&!d.pivot()?k:j;a.selectAll(".vzb-axis-value").data([null]).enter().append("g").attr("class","vzb-axis-value").append("text").style("opacity",0),a.selectAll("text").each(function(a,b){var c=d3.select(this);if(null!=d.pivot()&&(c.attr("transform","rotate("+(d.pivot()?-90:0)+")"),c.style("text-anchor",g==j?"middle":"end"),c.attr("x",g==j?0:-d.tickPadding()-d.tickSize()),c.attr("y",g==j?(f==h?-1:1)*(d.tickPadding()+d.tickSize()):0),c.attr("dy",g==j?f==h?0:".72em":".32em"),null!=d.repositionLabels())){var e=d.repositionLabels()[b]||{x:0,y:0};c.attr("x",+c.attr("x")+e.x),c.attr("y",+c.attr("y")+e.y)}}),null==d.tickValuesMinor()&&d.tickValuesMinor([]);var l=a.selectAll(".tickMinor").data(s);l.exit().remove(),l.enter().append("line").attr("class","tickMinor");var m=d.tickSizeMinor().outbound,n=d.tickSizeMinor().inbound,p=d.scale();l.attr("y1",f==i?("top"==d.orient()?1:-1)*n:p).attr("y2",f==i?("top"==d.orient()?-1:1)*m:p).attr("x1",f==h?("right"==d.orient()?-1:1)*n:p).attr("x2",f==h?("right"==d.orient()?1:-1)*m:p)}function e(a,b){null==b&&(b=!0);var c=[],d=[];-1!=a.indexOf(0)&&(c.push([0]),d.push(a.indexOf(0)));for(var e=a.length;e>=1;e=4>e?e-1:e/2)c.push(a.filter(function(a,c){return c%Math.floor(e)!=0||-1!=d.indexOf(c)&&b?!1:(d.push(c),!0)}));return c}function f(a,b,c,d,e){if(null==a)return null;var f=c==h?{head:b.toolMargin.top,tail:b.toolMargin.bottom}:{head:b.toolMargin.right,tail:b.toolMargin.left},g={};return a.forEach(function(j,k){if(0==k||k==a.length-1){var l=f.head+(c==i?1:0)*d3.max(d.range())-(c==i?0:1)*d3.min(d.range())+(c==i?-1:1)*d(j)-("x"==e)*b.formatter(j).length*b.widthOfOneDigit/2-("y"==e)*b.heightOfOneDigit/2-("x"==e)*parseInt(b.cssMarginRight);-("y"==e)*parseInt(b.cssMarginTop);var m=Math.min(f.tail,b.widthOfOneDigit)+(c==h?1:0)*d3.max(d.range())-(c==h?0:1)*d3.min(d.range())+(c==h?-1:1)*d(j)-("x"==e)*b.formatter(j).length*b.widthOfOneDigit/2-("y"==e)*b.heightOfOneDigit/2-("x"==e)*parseInt(b.cssMarginLeft);-("y"==e)*parseInt(b.cssMarginBottom),l>0&&(l=0),m>0&&(m=0),g[k]={x:0,y:0},g[k][e]=("y"==e&&c==h?-1:1)*(l-m)}}),a.forEach(function(f,j){if(0!=j&&j!=a.length-1){var k=Math.abs(d(f)-d(a[a.length-1]))-("y"==e&&c==i?-1:1)*g[a.length-1][e]-("x"==e)*b.widthOfOneDigit/2*b.formatter(f).length-("x"==e)*b.widthOfOneDigit/2*b.formatter(a[a.length-1]).length-("y"==e)*b.heightOfOneDigit*.7,l=Math.abs(d(f)-d(a[0]))-("y"==e&&c==h?-1:1)*g[0][e]-("x"==e)*b.widthOfOneDigit/2*b.formatter(f).length-("x"==e)*b.widthOfOneDigit/2*b.formatter(a[0]).length-("y"==e)*b.heightOfOneDigit*.7;k>0&&(k=0),l>0&&(l=0),g[j]={x:0,y:0},g[j][e]=("y"==e&&c==h?-1:1)*(k-l)}}),g}function g(a,b,c,e,f){return d.labelerOptions().isDevMode?null!=f?void console.log(a,b,c,e,f):null!=e?void console.log(a,b,c,e):null!=c?void console.log(a,b,c):null!=b?void console.log(a,b):null!=a?void console.log(a):void 0:void 0}var h="vertical axis",i="horizontal axis",j="labels stack side by side",k="labels stack top to bottom",l="optimistic approximation: labels have different lengths",m="pessimistic approximation: all labels have the largest length",n=10;d.highlightValueRun=function(a){var b="top"==d.orient()||"bottom"==d.orient()?i:h;a.selectAll(".tick").each(function(a,b){d3.select(this).select("text").transition().duration(p).ease("linear").style("opacity","none"==o?1:Math.min(1,Math.pow(Math.abs(d.scale()(a)-d.scale()(o))/(d.scale().range()[1]-d.scale().range()[0])*5,2)))}),a.select(".vzb-axis-value").transition().duration(p).ease("linear").attr("transform","none"==o?"translate(0,0)":"translate("+(b==i?d.scale()(o):0)+","+(b==h?d.scale()(o):0)+")"),a.select(".vzb-axis-value").select("text").text(d.tickFormat()("none"==o?0:o)).style("opacity","none"==o?0:1),o=null};var o=null;d.highlightValue=function(a){return arguments.length?(o=a,d):o};var p=0;d.highlightTransDuration=function(a){return arguments.length?(p=a,d):p};var q=null;d.repositionLabels=function(a){return arguments.length?(q=a,d):q};var r=!1;d.pivot=function(a){return arguments.length?(r=!!a,d):r};var s=[];d.tickValuesMinor=function(a){return arguments.length?(s=a,d):s};var t={outbound:0,inbound:0};d.tickSizeMinor=function(a,b){return arguments.length?(t={outbound:a,inbound:b||0},g("setting",t),d):t};var u={};return d.labelerOptions=function(a){return arguments.length?(u=a,d):u},d.METHOD_REPEATING="repeating specified powers",d.METHOD_DOUBLING="doubling the value",d.labelFactory=function(a){function b(b,c){return null==c&&(c=a.logBase),Math.log(b)/Math.log(c)}if(null==a&&(a={}),"linear"!=a.scaleType&&"time"!=a.scaleType&&"genericLog"!=a.scaleType&&"log"!=a.scaleType&&"ordinal"!=a.scaleType)return d.ticks(v).tickFormat(null).tickValues(null).tickValuesMinor(null).pivot(null).repositionLabels(null);if("ordinal"==a.scaleType)return d.tickValues(null);null==a.logBase&&(a.logBase=n),null==a.stops&&(a.stops=[1,2,5,3,7,4,6,8,9]),null==a.removeAllLabels&&(a.removeAllLabels=!1),null==a.formatterRemovePrefix&&(a.formatterRemovePrefix=!1),null==a.formatter&&(a.formatter=function(b){if("time"==a.scaleType)return b instanceof Date||(b=new Date(b)),d3.time.format("%Y")(b);var c="f",d=0;Math.abs(b)<1&&(d=1,c="r");var e="";if(a.formatterRemovePrefix)return d3.format("."+d+c)(b);switch(Math.floor(Math.log10(Math.abs(b)))){case-13:b=1e12*b,e="p";break;case-10:b=1e9*b,e="n";break;case-7:b=1e6*b,e="µ";break;case-6:b=1e6*b,e="µ";break;case-5:b=1e6*b,e="µ";break;case-4:break;case-3:break;case-2:break;case-1:break;case 0:break;case 1:break;case 2:break;case 3:break;case 4:break;case 5:b/=1e3,e="k";break;case 6:b/=1e6,e="M",d=1;break;case 7:b/=1e6,e="M";break;case 8:b/=1e6,e="M";break;case 9:b/=1e9,e="B",d=1;break;case 10:b/=1e9,e="B";break;case 11:b/=1e9,e="B";break;case 12:b/=1e12,e="T",d=1;break;default:return d3.format("."+d+"s")(b).replace("G","B")}return(d3.format("."+d+c)(b)+e).replace("G","B")}),a.cssLabelMarginLimit=5,(null==a.cssMarginLeft||parseInt(a.cssMarginLeft)<a.cssLabelMarginLimit)&&(a.cssMarginLeft=a.cssLabelMarginLimit+"px"),(null==a.cssMarginRight||parseInt(a.cssMarginRight)<a.cssLabelMarginLimit)&&(a.cssMarginRight=a.cssLabelMarginLimit+"px"),(null==a.cssMarginTop||parseInt(a.cssMarginTop)<a.cssLabelMarginLimit)&&(a.cssMarginTop=a.cssLabelMarginLimit+"px"),(null==a.cssMarginBottom||parseInt(a.cssMarginBottom)<a.cssLabelMarginLimit)&&(a.cssMarginBottom=a.cssLabelMarginLimit+"px"),null==a.toolMargin&&(a.toolMargin={left:30,bottom:30,right:30,top:30}),null==a.pivotingLimit&&(a.pivotingLimit=a.toolMargin[this.orient()]),null==a.showOuter&&(a.showOuter=!1),null==a.limitMaxTickNumber&&(a.limitMaxTickNumber=0);var j="top"==this.orient()||"bottom"==this.orient()?i:h;null==a.isPivotAuto&&(a.isPivotAuto=j==h),null==a.cssFontSize&&(a.cssFontSize="13px"),null==a.widthToFontsizeRatio&&(a.widthToFontsizeRatio=.75),null==a.heightToFontsizeRatio&&(a.heightToFontsizeRatio=1.2),null==a.widthOfOneDigit&&(a.widthOfOneDigit=parseInt(a.cssFontSize)*a.widthToFontsizeRatio),null==a.heightOfOneDigit&&(a.heightOfOneDigit=parseInt(a.cssFontSize)*a.heightToFontsizeRatio),g("********** "+j+" **********");var k=d.scale().domain(),o=d.scale().range(),p=(Math.abs(k[k.length-1]-k[0]),Math.abs(o[o.length-1]-o[0])),q=d3.min([k[0],k[k.length-1]]),r=d3.max([k[0],k[k.length-1]]),s=0>q&&r>0&&"time"!=a.scaleType;s&&"log"==a.scaleType&&console.error("It looks like your "+j+" log scale domain is crossing ZERO. Classic log scale can only be one-sided. If need crossing zero try using genericLog scale instead");var t=a.showOuter?[q,r]:[],u=[],v=5,w=d3.max(d3.range(q,r,(r-q)/17).concat(r).map(function(b){return a.formatter(b).length}))*a.widthOfOneDigit+parseInt(a.cssMarginLeft),x=a.isPivotAuto&&(w+d.tickPadding()+d.tickSize()>a.pivotingLimit&&j==h||!(w+d.tickPadding()+d.tickSize()>a.pivotingLimit)&&!(j==h)),y=j==i&&x||j==h&&!x,z=!y&&a.heightOfOneDigit>a.pivotingLimit;if(a.removeAllLabels)return d.tickValues([]);if(q==r)return d.tickValues([q]).ticks(1).tickFormat(a.formatter);var A=function(b,c,e,f){if(null==b||b.length<=1)return!0;if(null==e&&(e=m),null==f&&(scaleType="none"),y)return c>b.length*(a.heightOfOneDigit+parseInt(a.cssMarginTop)+parseInt(a.cssMarginBottom));var g=parseInt(a.cssMarginLeft)+parseInt(a.cssMarginRight),h=d3.max(b.map(function(b){return a.formatter(b).length}));return"log"==f?(c=Math.abs(d.scale()(d3.max(b))-d.scale()(d3.min(b))),c>d3.sum(b.map(function(b){return(a.widthOfOneDigit*(e==m?h:a.formatter(b).length)+g)*(1+Math.log10(b.toString().replace(/([0\.])/g,"")[0]))}))):c>b.length*g+(e==m?a.widthOfOneDigit*b.length*h:0)+(e==l?a.widthOfOneDigit*b.map(function(b){return a.formatter(b)}).join("").length:0)},B=function(b,c){if(null==c||0==c.length)return!1;c instanceof Array||(c=[c]);for(var e=0;e<c.length;e++)if(b!=c[e]&&0!=b&&Math.abs(d.scale()(b)-d.scale()(c[e]))<(y?a.heightOfOneDigit:(a.formatter(b).length+a.formatter(c[e]).length)*a.widthOfOneDigit/2))return!0;return!1};if("genericLog"==a.scaleType||"log"==a.scaleType){var C=d.scale().eps?d.scale().eps():0,D=s?[0]:[],E=C>r?[]:d3.range(Math.floor(b(Math.max(C,q))),Math.ceil(b(r)),1).concat(Math.ceil(b(r))).map(function(b){return Math.pow(a.logBase,b)}),F=q>-C?[]:d3.range(Math.floor(b(Math.max(C,-r))),Math.ceil(b(-q)),1).concat(Math.ceil(b(-q))).map(function(b){return-Math.pow(a.logBase,b)});if(null==a.method){var G=s?Math.max(Math.abs(r),Math.abs(q))/C:Math.max(Math.abs(r),Math.abs(q))/Math.min(Math.abs(r),Math.abs(q));a.method=G>=10&&1024>=G?this.METHOD_DOUBLING:this.METHOD_REPEATING}if(a.method==this.METHOD_DOUBLING){var H=[];s&&t.push(0);var I=[].concat(t),J=C>r?null:4*E[Math.floor(E.length/2)-1],K=q>-C?null:4*F[Math.floor(F.length/2)-1];if(J)for(var L=J;r>=L;L*=2)H.push(L);if(J)for(var L=J/2;L>=Math.max(q,C);L/=2)H.push(L);if(K)for(var L=K;L>=q;L*=2)H.push(L);if(K)for(var L=K/2;L<=Math.min(r,-C);L/=2)H.push(L);H=H.sort(d3.ascending).filter(function(a){return a>=q&&r>=a}),u=u.concat(H),H=e(H,!1);for(var M=t,N=0;N<H.length;N++){var O=M.concat(H[N]).filter(function(a){return!B(a,I)}).filter(c);if(!A(O,p,m,"none"))break;t=O}}if(a.method==this.METHOD_REPEATING){var P=D.concat(E).concat(F).sort(d3.ascending);a.stops.forEach(function(a,b){u=u.concat(P.map(function(b){return b*a}))}),P=e(P);var I=D.concat(t),Q=!1;a.stops.forEach(function(b,d){if(0==d){for(var e=0;e<P.length;e++){var f=t.concat(P[e].map(function(a){return a*b})).filter(function(a){return!B(a,I)}).filter(function(a){return a>=q&&r>=a}).filter(c);if(!A(f,p,m,"none"))break;t=f}P=[].concat.apply([],P)}else{if(Q)return;var f=t.concat(P.map(function(a){return a*b})).filter(function(a){return a>=q&&r>=a}).filter(c);if(!A(f,p,m,"log"))return void(Q=!0);if(t.length>a.limitMaxTickNumber&&0!=a.limitMaxTickNumber)return void(Q=!0);t=f}})}}if("linear"==a.scaleType||"time"==a.scaleType){s&&t.push(0);var I=[].concat(t);v=Math.max(Math.floor(p/w),2),0!=a.limitMaxTickNumber&&v>a.limitMaxTickNumber&&(v=a.limitMaxTickNumber);var R=d.scale().ticks.apply(d.scale(),[v]).sort(d3.ascending).filter(function(a){return a>=q&&r>=a});u=u.concat(R),R=e(R,!1);for(var M=t,N=0;N<R.length;N++){var O=M.concat(R[N]).filter(function(a){return!B(a,I)}).filter(c);if(!A(O,p,m,"none"))break;t=O}t=t.filter(function(a){return!B(a,I)}).filter(c)}return null!=t&&t.length<=2&&!s&&(t=[q,r]),null!=t&&t.length<=3&&s&&(t=B(0,[q,r])?[q,r]:[q,0,r]),null!=t&&t.sort(function(a,b){return(j==i?-1:1)*(d.scale()(b)-d.scale()(a))}),z&&(t=[]),u=u.filter(function(a){return-1==t.indexOf(a)&&a>=q&&r>=a}),g("final result",t),d.ticks(v).tickFormat(a.formatter).tickValues(t).tickValuesMinor(u).pivot(x).repositionLabels(f(t,a,j,d.scale(),y?"y":"x"))},d.copy=function(){return a(d3.svg.axis())},d3.rebind(d,b,"scale","orient","ticks","tickValues","tickFormat","tickSize","innerTickSize","outerTickSize","tickPadding","tickSubdivide")}(d3.svg.axis())})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.collisionResolver=function(){return function(){function a(m){return null==e?void console.warn("D3 collision resolver stopped: missing data to work with. Example: data = {asi: {valueY: 45, valueX: 87}, ame: {valueY: 987, valueX: 767}}"):null==f?void console.warn("D3 collision resolver stopped: missing a CSS slector"):null==g?void console.warn("D3 collision resolver stopped: missing height of the canvas"):null==i?void console.warn("D3 collision resolver stopped: missing pointer within data objects. Example: value = 'valueY' "):null==l?void console.warn("D3 collision resolver stopped: missing a key for data. Example: key = 'geo' "):(m.each(function(a,b){c[a[l]]=d3.select(this).select(f)[0][0].getBBox().height}),d=a.calculatePositions(e,i,g,h),void m.each(function(a,c){if(!e[a[l]][j]){var g=d[a[l]]||h(e[a[l]][i])||0,m=null;return null!=k?void k(a,c,this,m,g):void d3.select(this).selectAll(f).transition().duration(b).attr("transform","translate(0,"+g+")")}}))}var b=300,c={},d={};a.calculatePositions=function(a,b,d,e){var f={},g=Object.keys(a).sort(function(c,d){return a[c][b]-a[d][b]});g.forEach(function(d,h){f[d]=e(a[d][b]);for(var i=h;i>0;i--){var j=f[g[i-1]]-f[g[i]]-c[g[i]];if(0>j&&(f[g[i-1]]-=j),j>0)break}});var h=d-f[g[0]]-c[g[0]];if(0>h){f[g[0]]+=h;for(var i=0;i<g.length-1;i++){var h=f[g[i]]-f[g[i+1]]-c[g[i+1]];if(0>h&&(f[g[i+1]]+=h),h>0)break}}return f};var e=null;a.data=function(b){return arguments.length?(e=b,a):e};var f=null;a.selector=function(b){return arguments.length?(f=b,a):f};var g=null;a.height=function(b){return arguments.length?(g=b,a):g};var h=d3.scale.linear().domain([0,1]).range([0,1]);a.scale=function(b){return arguments.length?(h=b,a):h};var i=null;a.value=function(b){return arguments.length?(i=b,a):i};var j=null;a.fixed=function(b){return arguments.length?(j=b,a):j};var k=null;a.handleResult=function(b){return arguments.length?(k=b,a):k};var l=null;return a.KEY=function(b){return arguments.length?(l=b,a):l},a}()})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.colorPicker=function(){return function(){function a(){for(var a=[],c=0;f>c;c++){var l=g+(1-g)/f*c;a.push([]);for(var m=0;d>=m;m++){var n=e+(1-e)/d*m;a[c].push({display:b(n,0==m?k:h,0==c?i:l),meaning:b(n,0==m?k:h,0==c?j:l)})}}return a}function b(a,b,c){var d,e,f;if(0==b)d=e=f=c;else{var g=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a},h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;d=g(i,h,a+1/3),e=g(i,h,a),f=g(i,h,a-1/3)}return"#"+Math.round(255*d).toString(16)+Math.round(255*e).toString(16)+Math.round(255*f).toString(16)}function c(b){q=a(),t=b.append("svg").style("position","absolute").style("top","0").style("left","0").style("width","100%").style("height","100%").attr("class",p.COLOR_PICKER).classed(p.INVISIBLE,!v);var c=parseInt(t.style("width")),d=parseInt(t.style("height")),e=c/2*(1-m.left-m.right);y=t.append("rect").attr("width",c).attr("height",d).attr("class",p.COLOR_BUTTON+" "+p.COLOR_BACKGR).on("mouseover",function(a){C(n)});var g=t.append("g").attr("transform","translate("+(e+c*m.left)+","+(e+d*m.top)+")");t.append("rect").attr("class",p.COLOR_SAMPLE).attr("width",c/2).attr("height",d*m.top/2),w=t.append("rect").attr("class",p.COLOR_SAMPLE).attr("width",c/2).attr("x",c/2).attr("height",d*m.top/2),t.append("text").attr("x",c*m.left).attr("y",d*m.top/2).attr("dy","0.5em").style("text-anchor","start").attr("class",p.COLOR_SAMPLE),x=t.append("text").attr("x",c*(1-m.right)).attr("y",d*m.top/2).attr("dy","0.5em").style("text-anchor","end").attr("class",p.COLOR_SAMPLE),t.append("text").attr("x",.1*c).attr("y",d*(1-m.bottom)).attr("dy","0.3em").style("text-anchor","start").text("default"),t.append("circle").attr("class",p.COLOR_DEFAULT+" "+p.COLOR_BUTTON).attr("r",c*m.left/2).attr("cx",c*m.left*1.5).attr("cy",d*(1-1.5*m.bottom)).on("mouseover",function(){d3.select(this).style("stroke","#444"),C(o)}).on("mouseout",function(){d3.select(this).style("stroke","none")}),g.append("circle").attr("r",l-1).attr("fill","#FFF").attr("class",p.COLOR_BUTTON).on("mouseover",function(){d3.select(this).style("stroke","#444"),C("#FFF")}).on("mouseout",function(){d3.select(this).style("stroke","none")}),g.selectAll("."+p.COLOR_CIRCLE).data(q).enter().append("g").attr("class",p.COLOR_CIRCLE).each(function(a,b){r.outerRadius(l+(e-l)/f*(f-b)).innerRadius(l+(e-l)/f*(f-b-1));var c=d3.select(this).selectAll("."+p.COLOR_SEGMENT).data(s(a)).enter().append("g").attr("class",p.COLOR_SEGMENT);c.append("path").attr("class",p.COLOR_BUTTON).attr("d",r).style("fill",function(a){return a.data.display}).style("stroke",function(a){return a.data.display}).on("mouseover",function(a){C(a.data.meaning,this)}).on("mouseout",function(a){D()})}),u=g.append("path").attr("class",p.COLOR_POINTER+" "+p.INVISIBLE),t.selectAll("."+p.COLOR_BUTTON).on("click",function(){B.show(E)}),A(t)}var d=15,e=0,f=4,g=.5,h=.7,i=.4,j=.3,k=0,l=15,m={top:.1,bottom:.1,left:.1,right:.1},n="#000",o="#000",p={INVISIBLE:"vzb-invisible",COLOR_POINTER:"vzb-colorPicker-colorPointer",COLOR_BUTTON:"vzb-colorPicker-colorCell",COLOR_DEFAULT:"vzb-colorPicker-defaultColor",COLOR_SAMPLE:"vzb-colorPicker-colorSample",COLOR_PICKER:"vzb-colorPicker-colorPicker",COLOR_CIRCLE:"vzb-colorPicker-colorCircle",COLOR_SEGMENT:"vzb-colorPicker-colorSegment",COLOR_BACKGR:"vzb-colorPicker-background"},q=[],r=d3.svg.arc(),s=d3.layout.pie().sort(null).value(function(a){return 1}),t=null,u=null,v=!1,w=null,x=null,y=null,z=function(a){console.info("Color picker callback example. Setting color to "+a)},A=function(a){a.select("."+p.COLOR_BACKGR).style("fill","white"),a.select("."+p.COLOR_POINTER).style("stroke-width",2).style("stroke","white").style("pointer-events","none").style("fill","none"),a.selectAll("."+p.COLOR_BUTTON).style("cursor","pointer"),a.selectAll("text").style("dominant-baseline","hanging").style("fill","#D9D9D9").style("font-size","0.7em").style("text-transform","uppercase"),a.selectAll("circle."+p.COLOR_BUTTON).style("stroke-width",2)},B=c,C=function(a,b){null!=b&&u.classed(p.INVISIBLE,!1).attr("d",d3.select(b).attr("d")),w.style("fill",a),x.text(a),z(a)},D=function(){u.classed(p.INVISIBLE,!0)},E="toggle";return c.show=function(a){return arguments.length?(null==t&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),v=a==E?!v:a,void t.classed(p.INVISIBLE,!v)):v},c.nCellsH=function(a){return arguments.length?(d=a,c):d},c.minH=function(a){return arguments.length?(e=a,c):e},c.nCellsL=function(a){return arguments.length?(f=a,c):f},c.minL=function(a){return arguments.length?(g=a,c):g},c.outerL_display=function(a){return arguments.length?(i=a,c):i},c.outerL_meaning=function(a){return arguments.length?(j=a,c):j},c.satConstant=function(a){return arguments.length?(h=a,c):h},c.firstAngleSat=function(a){return arguments.length?(k=a,c):k},c.minRadius=function(a){return arguments.length?(l=a,c):l},c.margin=function(a){return arguments.length?(m=a,c):m},c.callback=function(a){return arguments.length?(z=a,c):z},c.colorDef=function(a){return arguments.length?(o=a,null==t&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),t.select("."+p.COLOR_DEFAULT).style("fill",o),c):o},c.colorOld=function(a){return arguments.length?(n=a,null==t&&console.warn("Color picker is missing SVG element. Was init sequence performed?"),t.select("rect."+p.COLOR_SAMPLE).style("fill",n),t.select("text."+p.COLOR_SAMPLE).text(n),c):n},c}()})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.scale.genericLog=function(){return function a(b){function c(a){var c=1,e=0,h=0,k=0,l=f[0]<f[f.length-1],m=g[0]<g[g.length-1];if(d3.min(f)<0&&d3.max(f)>0){var n=d3.min(j([f[0],f[f.length-1]]));c=l!=m?(d3.max(g)+d3.max(g)-b(Math.max(d,n)))/d3.max(g):(d3.max(g)+b(Math.max(d,n)))/d3.max(g),l&&!m?(e=(d3.max(g)+i(0))/c,j(f[0])>j(f[f.length-1])&&(k-=b(Math.max(d,n))/c)):l||m?l&&m?(k=d3.max(g)/c,j(f[0])<j(f[f.length-1])&&(k-=(d3.max(g)-b(Math.max(d,n)))/c)):!l&&m&&(e=(d3.max(g)+i(0))/c,j(f[0])<j(f[f.length-1])&&(k-=b(Math.max(d,n))/c)):(k=b(Math.max(d,n))/c,j(f[0])<j(f[f.length-1])&&(k+=(d3.max(g)-b(Math.max(d,n)))/c))}else d3.min(f)<0&&d3.max(f)<0&&(e=d3.max(g));return a>d?b(a)/c+k+h:-d>a?-b(-a)/c+k+e:a>=0&&d>=a?i(a)/c+k+h:a>=-d&&0>a?-i(-a)/c+k+e:void 0}var d=.001,e=5,f=b.domain(),g=b.range(),h=!1,i=d3.scale.linear().domain([0,d]).range([0,e]),j=function(a){return a instanceof Array?a.map(function(a){return Math.abs(a)}):Math.abs(a)},k=function(a){for(var b=Math.sign(a[0]),c=0;c<a.length;c++)if(Math.sign(a[c])!=b)return!1;return!0};return c.eps=function(a){return arguments.length?(d=a,c.domain(f),c):d},c.delta=function(a){return arguments.length?(e=a,c.range(g),c):e},c.domain=function(a){if(!arguments.length)return f;var e=[];switch(2!=a.length&&console.warn("generic log scale is best for 2 values in domain, but it tries to support other cases too"),a.length){case 0:e=f;break;case 1:e=[a[0]/2,2*a[0]];break;case 2:e=[a[0],a[1]];break;case 3:e=[a[0],a[2]],d=j(a[1]);break;default:e=[a[0],a[a.length-1]],d=d3.min(j(a.filter(function(b,c){return 0!=c&&c!=a.length-1})))}return e[0]==e[1]&&(e[0]=e[0]/2,e[1]=2*e[1]),k(e)&&d3.min(j(e))>=d?(e[0]>0&&e[1]>0?b.domain(e):b.domain([-e[1],-e[0]]),h=!1):k(e)&&d3.min(j(e))<d?(e[0]>0&&e[1]>0?e[0]<=e[1]?(b.domain([d,e[1]]),i.domain([0,d])):(b.domain([e[0],d]),i.domain([d,0])):e[0]<=e[1]?(b.domain([d,-e[0]]),i.domain([0,d])):(b.domain([-e[1],d]),i.domain([d,0])),h=!0):k(e)||(e[0]<=e[1]?(b.domain([d,d3.max(j(e))]),i.domain([0,d])):(b.domain([d3.max(j(e)),d]),i.domain([d,0])),h=!0),f=a,c},c.range=function(a){if(!arguments.length)return g;switch(2!=a.length&&console.warn("generic log scale is best for 2 values in range, but it tries to support other cases too"),a.length){case 0:a=g;break;case 1:a=[a[0]-100,a[0]+100];break;case 2:a=a;break;case 3:e=a[1],a=[a[0],a[2]];break;default:e=d3.min(a.filter(function(b,c){return 0!=c&&c!=a.length-1})),a=[a[0],a[a.length-1]]}return h?a[0]<a[1]?f[0]<f[f.length-1]?(b.range([e,a[1]]),i.range([0,e])):(b.range([0,a[1]-e]),i.range([a[1]-e,a[1]])):f[0]<f[f.length-1]?(b.range([a[0]-e,0]),i.range([a[0],a[0]-e])):(b.range([a[0],e]),i.range([e,0])):b.range(a),g=a,c},c.copy=function(){return a(d3.scale.log().domain([1,10])).domain(f).range(g).eps(d).delta(e)},d3.rebind(c,b,"invert","base","rangeRound","interpolate","clamp","nice","tickFormat","ticks")}(d3.scale.log().domain([1,10]))})}.call(this),function(){"use strict";function a(a,b,c){var d,e=b?".onTap":".onLongTap";d3.select(a).on("touchstart"+e,function(a,b){d=d3.event.timeStamp}).on("touchend"+e,function(a,e){return d3.event.timeStamp-d<500?b?b(a,e):void 0:c?c(a,e):void 0})}Vizabi._require("d3")&&(d3.selection.prototype.onTap=function(b){return this.each(function(){a(this,b)})},d3.selection.prototype.onLongTap=function(b){return this.each(function(){a(this,null,b)})})}.call(this),function(){"use strict";Vizabi._require("d3")&&(d3.svg.worldMap=function(){return function(){function a(a){a.selectAll("path").remove(),a.html(b),a.selectAll("path").datum(function(){return{"geo.name":d3.select(this).attr("id"),"geo.region":d3.select(this).attr("id")}})}var b='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 584.5 364.5"><path id="eur" d="M556.7,26.9l-35.5-7.3l-3.5,1.4l-49.9-5.2l-2.7,2l-45.8-4.1l-1.3-1.9l-15.3-2.2l-0.2,0.1h-0.1l-0.2,0.2l-6,0.6 l-0.5,0.5L372.4,17l-1.7,1.7l-5.8-3.1h-1.7l-1.5,3.7l1.8,2.5l-0.4,0.2l-10.1-1.5l-6.8,1.9l-5.3-0.6l-7.2,2.6l-4.2-1h-0.1l-3.1,3.2 l-0.9,0.2l-2.6,2.2l-2.3,0.8l-1.6,2h-1.7l-5.1-5.1l-1-0.2l-0.1-0.5l1.3-0.9l8.4,1.6l0.5-0.1l2.4-1.8l-0.8-0.9l-20.2-5.5l-16.9,3.4 L268,37l0.8,6.1l3.2,1.7l4-1l1.5,0.9l2.6,5.5h0.8l0.7,1.2l0.8,0.2l7.9-9.7l-2.9-5.4l8.5-8.9h0.5l1.3,1.7l-2.7,6.6l0.8,2.8l11.9,2.4 l-4,1.8l-3.5-0.3l-1.5,1.2l1,1.6l-0.1,2.2l-0.9-0.6H297l-1.8,1.2l-0.5,3.9l-2.3,2.2h-4.3l-4.2,1.9l-6.8-0.7l-0.6-0.4l2.5-1.7 l0.5-1.2l-0.9-1.7l-0.2-0.1l-2.3,0.5l-0.2-0.1l-0.2-3.4l-0.4-0.1l-2.6,3.9l1.3,3.7l-1.4,1.7L269,57l-18.9,13.1l0.1,1l1.7,1.6 l0.8,0.3l1.3,2.2l0.3,3.6l-3.1,4.5l-9.7-0.9l-1.3,1.5L239,97.9l0.4,1.1l5.1,3.1l0.2,0.8l1.6-0.2l0.1-0.2h0.1v-0.1l7.9-4.5l10-14.3 l10-2.8l1.2,0.5l11,11.5l0.2,2.3l-2,1.8l-1.9-0.4l-1.8,0.5l3.8,3.9l1.1-0.7l3.7-5.6l0.2-0.5l-0.9-1.9l0.2-0.4l2.3,0.3l0.8-1 l-1.7-0.9l-8.7-7.6l-0.5-4.5l1.4,0.2l10.4,8l3.4,9l1,0.5l0.5,0.6v1.5l4.5,6.1v0.4l0.7,1.1l3.7,1.3l1.4-1.6l-3.8-2.3l-0.1-1.7 l2.2-2.6l-6.3-6.3l5.6-2.2L306,90l5.8,8l4.2-0.6l2.7,0.9l1,4.7l0.7-0.1l1.8-2l-1.3-1.7l0.2-0.9h4.3l0.3,2.7l15.2-4.7l0.4-5.1 l1.5-0.9l2.5,2l3.9-2.1l1.4,1.5l0.3-3.9l-3.1-5.3l-1.3-8.6l2.9-2.5l-0.6-2.7l-3.8-3.8l4.5-6.9l6.8,1.6l1.1-3.1l9.2,3.8l13.3-3.1 l-1.8-6.7l0.2-1l8.7,7.4l22.2,7.4l4.3-2.7l1.5-4.5l1-0.5l0.2,0.2l6,0.4l1,1.2l1.7,0.8l0.5-0.3l7.5,2.9l7.5-4.2l1.5,1.8l22.1,0.8 l0.7-1.8l23.5-1.4l7,9.2l9.6-1.2l3.4,15.2l1,1.1l-0.2,0.2l1.7,1.7l0.5,0.1l1.8-2.2l1.6-5.3L508,56.7l-2.9-2.2l-5.5,0.3l-2.6-2.5 l1.8-7.8l0.5-0.3l0.2-0.9l3.4-1.7l14.2,0.6l1.3-4.8l1.6-1.2l0.4-0.1l4.3,1.2l0.1-0.1l0.2,0.1l3.1-2.5l1.7,0.9l-1,12l6.9,15.9l3.1-3 l0.1-0.3l2.3,1.1l0.8-2.2l-1.1-8.7l-4.8-5.8l0.1-2.6l0.8-1.5l4.5-2.2l2.2,0.2l4-3.7l2.1-0.3l1.1-1.7l-5.2-2.5l-0.5-1.7l2.9-1.7 l8.2,2.2l0.9-0.2l0.8-1.2L556.7,26.9 M331,87l-11.6-3.1l-8.9,2.9l-0.2-0.1l-0.5-1.9l2.9-7l2.9-2.5h1.7l2.1,1.1l2.3-1.7l1.8-3.4 l1.8-0.6l2.1,0.6l-0.8,3.9l7.7,7.3L331,87 M252.8,18.2l-5.8,5.6l-3.7,1.1l-1.1,4.3l-2.2,1.7l-0.2,1.2l0.9,1.7l7.8,1.2l-2.4,2.9 l-4.6,1.7l-5.9-2.9l2-1.8l1.9-0.8l-2.5-2.1l-11.4,1.7l-4.7,3.1l-8,1.7L203,49l-3.4,0.3l-3.7-2.8l-1.3-10.6l5.2-4.5l1.1-2l-1.9-3.3 l-0.5-0.3v-0.6l-0.5-0.3v-0.6l-0.6-0.3l-1.1-1.4l-3.1-1.4h-5.5l-4-1.7l71.2-3.4L252.8,18.2 M258.9,60.7l0.7,1.2l-10.5,1.5l3.4-1.5 l-0.1-1.5l-2.7-0.9l4.2-4.9l-2.7-2.7l-5.9,7.4l-4.4,0.8l1.1-2.7l-0.2-2.7l8.5-4.8l0.3-3.8l1-1.3l1.3,0.4l0.2,1.1l1.3,0.3l-0.8,3.2 l3.3,2.4l1.7,5.1l2.6,0.9L258.9,60.7"/><path id="afr" d="M322.7,114.7l-1-1.8l-6.5,2.3l-16-4.8l-2.3,1.7l-1.8,4.5l-16.9-8.6l-0.2-0.6l-0.3-5.5l-2-2.8l-29,4.4l-0.2-0.4 l-1.7,0.2l-0.1,1.1l-6.7,7l-0.5,1.9l-0.6,0.7l-0.3,3.3l-15.3,23.7l0.6,13.2l-1.4,3l1.1,7.6l12.1,17.9l6,2.8l7.1-1.9l4.5,0.8 l13.7-3.3l3.9,4.5h3.5l1.6,1.4l1.8,3.6l-1.1,10.7l9.2,27.4l-4,14.6l8.5,30.7l1.1,1.1v0.7h0.5l3.5,12.5l2,1.7l11.9-0.6l15-18.2v-3.9 l5.1-4.5l1.1-4.2l-1.1-5.9l10.5-12.2l0.6-0.3l1.6-3.7l-3.4-24l25-43.3l-13.1,1.1l-1.8-1.1l-24.7-48.6l0.9-0.4l0.6-1L322.7,114.7  M360.1,233.2l2.3,1.7l-8.6,30.5l-4.3-0.6l-2-7.6l2.8-14.6l6.4-4.4l2.8-4.9L360.1,233.2z"/><path id="ame" d="M134.8,152l-11.4,1.8l-3.1-1.7l5.3-1.3l-0.7-1.1l-3.3-1.4h-0.1l-8.1-0.9l-0.3-0.3l-0.3-1.5l-6.2-3.6l-3.4,0.8 l-1.6,1.3l-1.2-0.5l-0.7-1.7l3.8-1.6l9.1,0.7l9.5,5.3l0,0l3.3,1.8l1.7-0.5l6.6,2.8L134.8,152 M183.7,25.4l-0.5-1.5l-2.6-2.2 l-2.1-0.6l-2.9-2.2l-18.2-2.2l-5.1,3.7l2,4.3l-6,2.2l1-1.7l-4.6-1.9l-0.5-1.7l-1.1-1.2l-2.9,0.5l-2.1,4.2l-5.8,2.5l-15.5-2.2 l10.5-1.7l-1.3-4l-11.6-0.4l-3.2-1.5L96,20.7h5.8l4,1.9l-1.7,1l0.8,1l7.2,2.3l-78.9-5.3l-10,3.6l-0.4,4.4L18,31.1l1,1.8l1.7,1.2 l-5.5,4.5l-0.4,5.6L13.8,46l1.8,1.8l-4.4,6.2L22,43.7l1.8-0.5l1.3-1.2l13.4,4l4,4.2l-1.3,14l1.6,2.6l-3.3,1.3L39.4,70l2.7,2.6 L28.6,96.9l1.6,11.2l4.8,5.6l-0.2,3.4l2.5,6.1l-0.5,5l6.6,11.9L38,121.5l1.7-4l3.4,6.1l0.3,2.2l7.1,13.1l1.1,9.2l11.1,8.7l1.6,0.3 l1.3,0.9l5.5,1.2l3.4-0.9l5.5,4.2l0.3,0.5l0.8,0.3l2.1,1.9l5.5,0.5l0.2,0.6l0.8,0.3l4.8,8.9l2.3,1.5l0.2,0.5l7.1,3.4l1.6-1.7 l-5.1-2.2l-1.3-15.6l-6.3-2.2l-3.7,0.3v-4.6l3.7-8.9l-5.2-0.9l-0.5,0.3L83,151l-6.3,2.2l-4-2.8l-3.2-8.9l3.2-11.8l0.5-0.3l0.2-1.2 l2.6-3.1l8.5-3.6l6.3,1.8l4.5-3.1l9.2,1.1l2.5,3.1l1.5,7.8l1.3,1.8l2.1-4.5l-1.1-5l1.6-7l13.7-12.3l0.2-3.7l0.8-1.7l0.9-0.2l0.7,0.5 l0.6-1.9l15-8.8l2.2-3.9l11.9-5.1l-2.2,3.6l11.4-3.8l-5.2-1.7l-1.8-2.8l1.6-4.2l-0.8-0.9h-4.2l0.8-1.5l19.5-3.2l1.6,2.8l-4.5,4.2 l6,1.7l5.3-2.2l-6.3-7.6l4.5-6.1l-1.1-0.6l-0.2-0.5h-3.2l-3.7-13.4l-7.7,3.1l-1.8-1.9l0.2-3.9l-2.3-2.5l-3.4-1.5l-6.6,1.9l-2.1,4.2 l-1.1,0.6l-1.3,2.2l-0.3,3.4l-10,9.5l-0.8,2.8l-1.8,1.9l-2.1,0.3l-1.8-2.5l1.1-4.8l-11.9-6.1l-3.1-5.1l15-12l1.3,0.3l5.1-1.2 l1.1-1.2l0.4-1.2l3.4-0.3l-1.7,4.8L147,34l4.6,0.7l-2.2-2.9l-2.1-1.2l8.2-2.8l0.3-0.6l2-1.7l0.7,0.1l8.1-4.2l7.4,5.3l0.2,1.5l-6,1.5 l-1.8,2.2l3.7,5.3l3.4,1.2l2.3-2.2l2.9-1.2L179,33l-0.2-1.9l7.7-1.7L183.7,25.4 M119.7,74.5l0.8,3.1l1.7,1.8l3.3-0.2l5.4,4.7 l2.7,0.2l-0.5,1.7l-4.7-0.4l0.2-1.2l-2.6-0.9l-2,0.6l-2.6,3.4l3.1,1.7l-3.2,2.3l-2.6-1.2l0.1-9.3l-9.6,9.9L108,88l4.5-7l4.3-2 l-5.1-2.1l-4.8,0.5l0.2-1.7l1.3-1.2l8.7-2.2L119.7,74.5 M205.9,223.1l-1.3,3.1H204l-7.1,11.2l-1.9,18.2l-3.1,6.1h-0.5v0.6l-0.8,0.3 l-1.1,1.2l-2.7-0.3l-9.4,6.7l-7.7,21.6l-3.9,3.3l-5.1-1.1l2.1,3.3l0.5,5.3l-7.9,3.3l-1.4,1.5l-0.5,3.6l-1.1,0.6l-1.1-0.3l-1.8,0.9 l1.8,6.1l-1.8,5.6l3.4,6.1l-2,5.9l0.5,3.1l11.1,8.2l-0.2,0.5l-9.3-0.6l-4.3-5.1l-4.7-1.7l-8.6-17.1l0.5-1.7l-6-12.3l-4.5-56.7 l-12.4-10.2l-4.2-8.1l-0.8-0.6l-9.8-21.5l1.1-2.2l-0.3-2.6l-0.5-0.8l7.9-15.3l0.3-5.6l-1-2.8l1-3.9l1.8-0.3l9.7-8.2l2.1,0.3l0.8,5.1 l2.7-5.1l1.3-0.3l4.2,2.8h0.9l0.2,0.6l14.8,3.9l1.6,1.4l0.3,0.6l7.9,6.7l7.7,0.9l4.3,4l2,6.3l-1,4.6l4.4,1.4l1.1,2.2l5.2-1.1 l2.1,1.1l2.6,4l2.9-0.9l9,1.9l8.6,5.8L205.9,223.1"/><path id="asi" d="M322.9,118.9l22.8,42.5l13.5-5.9l16.8-19l-7.3-6.5l-0.7-3.4h-0.1l-5.7,5.2l-0.9,0.1l-3.2-4.4l-0.4-0.2l-0.7,1.7 l-1.2-0.4l-4.1-11.4l0.2-0.5l1.9-1.2l5.1,6.8l6.2,2.7l0.8-0.2l1.1-1.1l1.6,0.4l2.9,2.6l0.4,0.8l16.4,0.8l6.9,6.5l0.4,0.1l1.4-0.3 l0.3,0.1l-1.7,2.5l2.9,2.8h0.7l3.3-3.3l0.5,0.3l9.2,32.1l4,3.7l1.3-1.3h0.2l1.7,1.3l1.4,6.6l1.6,0.9l1.7-2.9l-2.3-7.3l-0.1,0.3v-0.2 l-1.7,0.6l-1.3-1.1l1.2-14.3l14.3-17.6l5.9-1.7l0.3,0.1l3.1,4.5l0.8,0.2l0.9,1.5l0.8,0.3l4.7,10.3l0.2,0.1l2-0.6l5.4,10.1l-0.3,10.5 l2.8,3.7l0,0l4.2,10.8l1.8,1.7l-1.1,2.4l-0.8-0.6l-1.9-4l-1.7-1.4l-0.3-0.9l-5.5-3.5l-2.4-0.3l-0.2,1.2l19.8,28.5l2.6-3.6l-5.7-11.2 l0.9-4l0.7-0.2l0.2-2.3l-9.3-18.6l-0.3-8.9l1.4-1.5l6.7,7.8l1.4,0.3l1.1-0.6l0.1,0.1l-0.2,3.4l0.6,0.5l0.5,0.2l7.4-7.9l-2-10.4 l-6.9-9.5l4.9-6l0.8,0.2l0.8,0.5l1.7,3.9l2.9-4.7l10.1-3.6l5.1-8.1l1.6-9.9l-2.5-2l1.1-1.7l-7.5-11.5l3.5-4.7l-6.1-0.9l-3.5-3.7 l4.1-4.3l0.8-0.1l1.4,0.9l0.6,2.9l2.8-1.3l3.9,1.4l0.9,3.2l2.3,0.5l5,9h0.4l2.3-2.4h0.3l1-1.5l-1.7-3.8l-5.8-5.9l2.1-4v-3.6l2.6-2.4 l0.5,0.1l0.2-0.1l-3.5-15.2l-0.2,0.1v-0.1l-9.3,1.2l-7.3-9.3L464,58.8l-0.8,1.9L441.2,60l-1.5-1.8l-0.2,0.1l0,0l-7.3,4.1l-7.5-3 l-0.5,0.3l-1.8-0.8l-0.9-1.2l-0.3,0.1l-0.1-0.1l-5.7-0.4l-0.3-0.2l0,0l0,0l-1,0.5l-1.5,4.5l-4.2,2.7l-16.8-4.4L377.5,50l0,0l-0.2,1 l1.8,6.7l-13.3,3l-9.2-3.8l-1.1,3.1l-6.7-1.6l-0.1,0.1h-0.2l-4.4,6.8l3.8,3.8l0.6,2.7l0,0l0,0L352,71l2.6,2.2V74l-2.3,1.9l-0.8,1.6 l1.6,3.9l0.9,0.3l1,1.1l2.6,0.9l1.7,1.7l-0.2,1.1l-1.5,2.8l2.1,3.7v4.5l-1.3,1.4l-3.8-0.9l-4.7-5.1v-0.6l-1.4-1.4l-3.9,2.1l-2.4-2.1 l-1.6,0.9l-0.3,5.1l-15.2,4.7l-1.7,9.8l-2.5,1.7L322.9,118.9 M531.1,99.3l-1,2l-4,1.7l-2.4,3l-3.3-2.5l-6.4,0.2l-0.2-0.7l8.9-4.2 l3.7-4.9l-0.6-3.3l-3.2-5.1l-0.7-0.4v-5.1l1.4-2.6l1.7,0.3l0.6,0.7h0.8l1.1,0.8l1.3,0.3l0.6,1.9l-1.7,2l-2.6-1.2L531.1,99.3  M500.5,130.3l1.9-0.9l-0.8,6.3l-1.6-0.3L500.5,130.3 M515.9,180.5l-1.7,0.4l-2.2-3.3l-3.6-2.2l4.3-2.5l0.9-3.1l-0.3-4.1l-4.6-2.1 l-2,0.5l-5.1,8.5l-2.4,0.3l-0.2-3.4l0.8-0.7l4.2-9.3l-1.8-3.7l1.4-9.3l2.4,1.8l1.6,3.6l-0.5,4.8l8,6.4l0.1-0.1l3.1,11.2L515.9,180.5 L515.9,180.5L515.9,180.5 M497.7,179.5l2.6,0.9l1.1,1.9l-1.8,5.1l0.8,7l-6,10.9l-9.2-1.7l-2.9-10.9L497.7,179.5L497.7,179.5  M509,194.8l-1.8,0.1L509,194.8 M515,193.9l-1.7,2.2l-2.4-0.2l-1.9-1.1l-3.3,1.3l-0.3,1.9l1.2,1.4l2.1-0.3l0.9-0.7l1.1,0.1l0.3,1.2 l-1.9,2.6l0.7,5.6l-2.3-2l-1-2l-1.5,1l0.9,5.2l-3.1-0.4l0.2-2.8l-1.4-2.5l2.9-10.5l3.2-1.6l3.8,1.2l3.4-1.1L515,193.9 M530.7,198.1 l2.5,0.5l0.4,0.4l2,5.3l2.1-2.2l4.2-1.7l14.5,11.5l2.4,0.5l4-2.6l-1.2,4.7l-3.5,1.4l-0.5,1.4l0.1,1.3l4.4,6.5l-4.4-1.5l-5.2-7.5 l-5.6,4.4l-5.6-2l-1.2-1.5l1.3-1.5l-1.9-2.4l-0.3-0.8l-8.5-5l-0.9-4.7l-3.4-3.1l2.4-1.4H530.7 M476.6,212.1l19.1,5l3.1-0.8l4.4,1.4 l3.3-0.9l12.4,2.1l-0.1,0.6l-8.2,4v-1.9l-35.4-5.6l-1.5-1.8l2.5-1.9H476.6 M569.4,280.1l-19,14.6l-0.7-1.1l2.2-4.6l5.1-3l7.4-9.7 l0.9-4.3l4.8,5.1L569.4,280.1 M554.3,267.3l-11.1,18.2l-5.7,3.1l-4.8,7.7l-2.5,0.5l-0.6-1.9l0.5-3.4l2.8-2.9l-6.6-0.8l-1.6-1.4 l-1.7-8.4l-0.9-0.9l-3.1,1.1l-5.2-3.9l-32.3,7.3l-2.3-1.9l2.3-4.5l0.6-21.9l1.8-2.5l13.9-6.4l4.3-4.8l0.3-0.9l10-9.2l4.2,1.9l5.5-7 l4.2-1.4l4.9,2l-1.1,5l2.8,4.8l4.5,2.8l3.2-4.5l2.5-11.7l4.6,10.8v7.6l7.7,18.5L554.3,267.3L554.3,267.3L554.3,267.3L554.3,267.3 L554.3,267.3L554.3,267.3"/></svg>';
return a}()})}.call(this),function(){"use strict";var a=this,b=a.Vizabi,c=b.utils,d=this.Vizabi.Tool.get("BarChart"),e=this.Vizabi.Tool.get("LineChart"),f=this.Vizabi.Tool.get("BubbleChart"),g=this.Vizabi.Tool.get("MountainChart"),h=this.Vizabi.Component.get("gapminder-mountainchart"),i=this.Vizabi.Tool.get("PopByAge"),j={id:"en",strings:{}},k=window.location.href.split("/"),l=k.splice(0,k.indexOf("preview")).join("/");l+="/preview/";b._globals.gapminder_paths={baseUrl:l},d.define("default_options",{state:{time:{start:"1952",end:"2012",value:"2000",step:1,speed:300,formatInput:"%Y"},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"lex",scaleType:"linear",min:0,max:90,allow:{scales:["linear","log"]}},axis_x:{use:"property",which:"geo.name",allow:{scales:["ordinal"]}},color:{use:"property",which:"geo.region",scaleType:"ordinal"}}},data:{reader:"waffle-server",splash:!0},language:j,ui:{buttons:[]}}),g.define("datawarning_content",{title:"Income data has large uncertainty!",body:"There are many different ways to estimate and compare income. Different methods are used in different countries and years. Unfortunately no data source exists that would enable comparisons across all countries, not even for one single year. Gapminder has managed to adjust the picture for some differences in the data, but there are still large issues in comparing individual countries. The precise shape of a country should be taken with a large grain of salt.<br/><br/> Gapminder strongly agrees with <a href='https://twitter.com/brankomilan' target='_blank'>Branko Milanovic</a> about the urgent need for a comparable global income survey, especially for the purpose of monitoring the UN poverty-goal.<br/><br/> We are constantly improving our datasets and methods. Please expect revision of this graph within the coming months. <br/><br/> Learn more about the datasets and methods in this <a href='http://www.gapminder.org/news/data-sources-dont-panic-end-poverty' target='_blank'>blog post</a>",doubtDomain:[1800,1950,2015],doubtRange:[1,.8,.6]}),g.define("default_options",{state:{time:{start:1800,end:2015,value:2015,step:1,speed:100,formatInput:"%Y",xLogStops:[1,2,5],yMaxMethod:"latest",povertyline:1.82,povertyCutoff:.2,povertyFade:.7,gdpFactor:1.039781626,gdpShift:-1.127066411,xPoints:50},entities:{dim:"geo",opacitySelectDim:.3,opacityRegular:.6,show:{_defs_:{geo:["*"],"geo.cat":["country"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"pop",scaleType:"linear"},axis_x:{use:"indicator",which:"gdp_per_cap",scaleType:"log",min:.11,max:500},size:{use:"indicator",which:"gini",scaleType:"linear"},color:{use:"property",which:"geo.region",scaleType:"ordinal"},stack:{use:"value",which:"all"},group:{which:"geo.region",manualSorting:["eur","ame","afr","asi"],merge:!1}}},language:j,data:{reader:"csv-file",path:b._globals.gapminder_paths.baseUrl+"local_data/waffles/dont-panic-poverty.csv",splash:!0}}),e.define("default_options",{state:{time:{start:1990,end:2012,value:2012,step:1,speed:300,formatInput:"%Y"},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["region"]}}},marker:{space:["entities","time"],label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"gdp_per_cap",scaleType:"log"},axis_x:{use:"indicator",which:"time",scaleType:"time"},color:{use:"property",which:"geo",palette:{asi:"#FF5872",eur:"#FFE700",ame:"#7FEB00",afr:"#00D5E9",_default:"#ffb600"}},color_shadow:{use:"property",which:"geo",palette:{asi:"#FF5872",eur:"#FFE700",ame:"#7FEB00",afr:"#00D5E9",_default:"#ffb600"}}}},data:{reader:"waffle-server"},language:j,ui:{"vzb-tool-line-chart":{entity_labels:{min_number_of_entities_when_values_hide:2},whenHovering:{hideVerticalNow:0,showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0,showTooltip:0}},buttons:[]}}),f.define("datawarning_content",{title:"",body:"Comparing the size of economy across countries and time is not trivial. The methods vary and the prices change. Gapminder has adjusted the picture for many such differences, but still we recommend you take these numbers with a large grain of salt.<br/><br/> Countries on a lower income levels have lower data quality in general, as less resources are available for compiling statistics. Historic estimates of GDP before 1950 are generally also more rough. <br/><br/> Data for child mortality is more reliable than GDP per capita, as the unit of comparison, dead children, is universally comparable across time and place. This is one of the reasons this indicator has become so useful to measure social progress. But the historic estimates of child mortality are still suffering from large uncertainties.<br/><br/> Learn more about the datasets and methods in this <a href='http://www.gapminder.org/news/data-sources-dont-panic-end-poverty' target='_blank'>blog post</a>",doubtDomain:[1800,1950,2015],doubtRange:[1,.3,.2]}),f.define("default_options",{state:{time:{start:"1800",end:"2015",value:"2015",step:1,speed:300,formatInput:"%Y",round:"ceil",trails:!0,lockNonSelected:0,adaptMinMaxZoom:!1},entities:{dim:"geo",show:{_defs_:{geo:["*"],"geo.cat":["country"]}}},marker:{space:["entities","time"],type:"geometry",shape:"circle",label:{use:"property",which:"geo.name"},axis_y:{use:"indicator",which:"u5mr",scaleType:"linear",allow:{scales:["linear","log","genericLog"]}},axis_x:{use:"indicator",which:"gdp_per_cap",scaleType:"log",allow:{scales:["linear","log","genericLog"]}},color:{use:"property",which:"geo.region",scaleType:"ordinal"},size:{use:"indicator",which:"pop",scaleType:"linear",allow:{scales:["linear","log"]},min:.04,max:.9}}},data:{reader:"csv-file",path:b._globals.gapminder_paths.baseUrl+"local_data/waffles/dont-panic-poverty.csv",splash:!0},language:j,ui:{"vzb-tool-bubble-chart":{whenHovering:{showProjectionLineX:!0,showProjectionLineY:!0,higlightValueX:!0,higlightValueY:!0},labels:{autoResolveCollisions:!0,dragging:!0}},buttons:[]}}),i.define("default_options",{state:{time:{value:"2013"},entities:{dim:"geo",show:{_defs_:{geo:["usa"]}}},entities_age:{dim:"age",show:{_defs_:{age:[[1,100]]}}},marker:{space:["entities","entities_age","time"],group_by:1,label:{use:"indicator",which:"age"},label_name:{use:"property",which:"geo"},axis_y:{use:"indicator",which:"age"},axis_x:{use:"indicator",which:"population"},color:{use:"value",which:"#ffb600"}}},data:{reader:"csv-file",path:b._globals.gapminder_paths.baseUrl+"local_data/waffles/{{geo}}.csv",splash:!0},language:j,ui:{buttons:[]}});var m=this.Vizabi.Reader.get("waffle-server");m.define("basepath","http://52.18.235.31:8001/values/waffle"),h.define("preload",function(a){var c=b._globals.gapminder_paths.baseUrl+"local_data/mc_precomputed_shapes.json";d3.json(c,function(b,d){return b?console.warn("Failed loading json "+c+". "+b):(h.define("precomputedShapes",d),void a.resolve())})}),b.Tool.define("preload",function(a){var d=this,e=b._globals.gapminder_paths.baseUrl+"local_data/waffles/metadata.json",f=b._globals;this.preloadLanguage().then(function(){d3.json(e,function(b){f.metadata=b,f.metadata.indicatorsArray=c.keys(b.indicatorsDB).filter(function(a){var c=b.indicatorsDB[a];return-1!=c.allowCharts.indexOf(d.name)||-1!=c.allowCharts.indexOf("*")}),a.resolve()})})}),b.Tool.define("preloadLanguage",function(){var a=new b.Promise,c=this.model.language,d=b._globals.gapminder_paths.baseUrl+"local_data/translation/"+c.id+".json";return c&&!c.strings[c.id]?d3.json(d,function(b){c.strings[c.id]=b,a.resolve()}):a=a.resolve(),a})}.call(this);